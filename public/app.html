<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SafetyFirst EHS - Application</title>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/prop-types@15/prop-types.min.js"></script>
  <script src="https://unpkg.com/recharts@2.1.16/umd/Recharts.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: { 50: '#eff6ff', 100: '#dbeafe', 200: '#bfdbfe', 300: '#93c5fd', 400: '#60a5fa', 500: '#3b82f6', 600: '#2563eb', 700: '#1d4ed8', 800: '#1e40af', 900: '#1e3a8a' },
            success: { 50: '#f0fdf4', 100: '#dcfce7', 500: '#22c55e', 600: '#16a34a' },
            warning: { 50: '#fffbeb', 100: '#fef3c7', 500: '#f59e0b', 600: '#d97706' },
            danger: { 50: '#fef2f2', 100: '#fee2e2', 500: '#ef4444', 600: '#dc2626' }
          }
        }
      }
    }
  </script>
  <style>
    * { font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif; box-sizing: border-box; }
    .spin { animation: spin 1s linear infinite; }
    @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    .fade-in { animation: fadeIn 0.3s ease-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
    .slide-up { animation: slideUp 0.4s ease-out; }
    @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    .gradient-bg { background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 50%, #06b6d4 100%); }
    .gradient-card { background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%); }
    .card-shadow { box-shadow: 0 1px 3px rgba(0,0,0,0.05), 0 1px 2px rgba(0,0,0,0.1); }
    .card-shadow-lg { box-shadow: 0 10px 40px -10px rgba(0,0,0,0.1); }
    .card-hover { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
    .card-hover:hover { transform: translateY(-2px); box-shadow: 0 20px 40px -15px rgba(0,0,0,0.15); }
    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-track { background: #f1f5f9; border-radius: 4px; }
    ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    .sidebar-hidden { transform: translateX(-100%); }
    @media (min-width: 1024px) { .sidebar-hidden { transform: translateX(0); } }
    .tab-active { border-bottom: 2px solid #3b82f6; color: #1e40af; background: #eff6ff; }
    input:focus, select:focus, textarea:focus { outline: none; box-shadow: 0 0 0 3px rgba(59,130,246,0.15); }
    .btn-press:active { transform: scale(0.98); }
    .risk-low { background: linear-gradient(135deg, #dcfce7, #bbf7d0); color: #166534; }
    .risk-medium { background: linear-gradient(135deg, #fef3c7, #fde68a); color: #92400e; }
    .risk-high { background: linear-gradient(135deg, #fed7aa, #fdba74); color: #9a3412; }
    .risk-critical { background: linear-gradient(135deg, #fecaca, #fca5a5); color: #991b1b; }
  </style>
</head>
<body class="bg-slate-50 antialiased">
  <div id="root"></div>
  <script type="text/babel">
    const { useState, useEffect, createContext, useContext, useCallback, useMemo, useRef } = React;
    const { LineChart, Line, AreaChart, Area, BarChart, Bar, PieChart, Pie, Cell, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer, RadialBarChart, RadialBar } = Recharts;

    // ========== CONFIGURATION ==========
    const API = '/api';
    const AuthContext = createContext(null);
    const ToastContext = createContext(null);
    const COLORS = ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899', '#06b6d4', '#84cc16'];
    
    const PRICING = {
      starter: { name: 'Starter', price: 199, users: 10, color: 'blue' },
      professional: { name: 'Professional', price: 499, users: 50, color: 'purple' },
      enterprise: { name: 'Enterprise', price: 1299, users: 'Unlimited', color: 'amber' }
    };

    // ========== API HELPER ==========
    const api = {
      token: localStorage.getItem('ehs_token'),
      setToken(t) { this.token = t; t ? localStorage.setItem('ehs_token', t) : localStorage.removeItem('ehs_token'); },
      async req(ep, opt = {}) {
        try {
          const r = await fetch(API + ep, { 
            ...opt, 
            headers: { 'Content-Type': 'application/json', ...(this.token && { Authorization: 'Bearer ' + this.token }), ...opt.headers } 
          });
          const d = await r.json().catch(() => ({ error: 'Invalid server response' }));
          if (r.status === 401 && !ep.includes('/auth/')) { 
            this.setToken(null); 
            window.location.href = '/login'; 
            throw new Error('Session expired'); 
          }
          if (!r.ok) throw new Error(d.error || d.message || 'Request failed');
          return d;
        } catch (e) { 
          if (e.message === 'Failed to fetch') {
            throw new Error('Unable to connect to server. Please check your connection.');
          }
          throw e; 
        }
      },
      get: (ep) => api.req(ep),
      post: (ep, data) => api.req(ep, { method: 'POST', body: JSON.stringify(data) }),
      put: (ep, data) => api.req(ep, { method: 'PUT', body: JSON.stringify(data) }),
      del: (ep) => api.req(ep, { method: 'DELETE' })
    };

    // ========== ICONS ==========
    const Icons = {
      Dashboard: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M4 5a1 1 0 011-1h4a1 1 0 011 1v5a1 1 0 01-1 1H5a1 1 0 01-1-1V5zM14 5a1 1 0 011-1h4a1 1 0 011 1v2a1 1 0 01-1 1h-4a1 1 0 01-1-1V5zM4 15a1 1 0 011-1h4a1 1 0 011 1v4a1 1 0 01-1 1H5a1 1 0 01-1-1v-4zM14 12a1 1 0 011-1h4a1 1 0 011 1v7a1 1 0 01-1 1h-4a1 1 0 01-1-1v-7z" /></svg>,
      Incident: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" /></svg>,
      Action: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4" /></svg>,
      Inspection: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" /></svg>,
      Training: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" /></svg>,
      Document: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>,
      OSHA: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>,
      Risk: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" /></svg>,
      JSA: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" /></svg>,
      Permit: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" /></svg>,
      Contractor: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" /></svg>,
      Chemical: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z" /></svg>,
      Health: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" /></svg>,
      Emergency: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" /></svg>,
      Ergo: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg>,
      Reports: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" /></svg>,
      Users: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" /></svg>,
      Settings: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>,
      Audit: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>,
      Bell: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" /></svg>,
      Plus: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4" /></svg>,
      Download: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>,
      Menu: () => <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 6h16M4 12h16M4 18h16" /></svg>,
      X: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" /></svg>,
      Logout: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" /></svg>,
      Shield: () => <svg className="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" /></svg>,
      Check: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" /></svg>,
      Search: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>,
      Filter: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z" /></svg>,
      Eye: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" /></svg>,
      Edit: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg>,
      Trash: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>,
      Observation: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" /></svg>,
      Environment: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M3.055 11H5a2 2 0 012 2v1a2 2 0 002 2 2 2 0 012 2v2.945M8 3.935V5.5A2.5 2.5 0 0010.5 8h.5a2 2 0 012 2 2 2 0 104 0 2 2 0 012-2h1.064M15 20.488V18a2 2 0 012-2h3.064M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>,
      MOC: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4" /></svg>,
      Quality: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M9 12l2 2 4-4M7.835 4.697a3.42 3.42 0 001.946-.806 3.42 3.42 0 014.438 0 3.42 3.42 0 001.946.806 3.42 3.42 0 013.138 3.138 3.42 3.42 0 00.806 1.946 3.42 3.42 0 010 4.438 3.42 3.42 0 00-.806 1.946 3.42 3.42 0 01-3.138 3.138 3.42 3.42 0 00-1.946.806 3.42 3.42 0 01-4.438 0 3.42 3.42 0 00-1.946-.806 3.42 3.42 0 01-3.138-3.138 3.42 3.42 0 00-.806-1.946 3.42 3.42 0 010-4.438 3.42 3.42 0 00.806-1.946 3.42 3.42 0 013.138-3.138z" /></svg>,
      Asset: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>,
      Supplier: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M9 17a2 2 0 11-4 0 2 2 0 014 0zM19 17a2 2 0 11-4 0 2 2 0 014 0z" /><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M13 16V6a1 1 0 00-1-1H4a1 1 0 00-1 1v10a1 1 0 001 1h1m8-1a1 1 0 01-1 1H9m4-1V8a1 1 0 011-1h2.586a1 1 0 01.707.293l3.414 3.414a1 1 0 01.293.707V16a1 1 0 01-1 1h-1m-6-1a1 1 0 001 1h1M5 17a2 2 0 104 0m-4 0a2 2 0 114 0m6 0a2 2 0 104 0m-4 0a2 2 0 114 0" /></svg>,
      Meeting: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" /></svg>,
      CAPA: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4" /></svg>,
      Upload: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" /></svg>,
    };

    // ========== UI COMPONENTS ==========
    const Spinner = ({ size = 'md', className = '' }) => {
      const s = { sm: 'w-4 h-4 border-2', md: 'w-8 h-8 border-3', lg: 'w-12 h-12 border-4' };
      return <div className={'spin ' + s[size] + ' border-primary-200 border-t-primary-600 rounded-full ' + className}></div>;
    };

    const Button = ({ children, variant = 'primary', size = 'md', loading, disabled, className = '', icon, ...props }) => {
      const variants = {
        primary: 'bg-gradient-to-r from-primary-600 to-primary-700 hover:from-primary-700 hover:to-primary-800 text-white shadow-lg shadow-primary-500/20',
        secondary: 'bg-white hover:bg-slate-50 text-slate-700 border border-slate-200 shadow-sm hover:shadow',
        success: 'bg-gradient-to-r from-emerald-500 to-emerald-600 hover:from-emerald-600 hover:to-emerald-700 text-white shadow-lg shadow-emerald-500/20',
        danger: 'bg-gradient-to-r from-red-500 to-red-600 hover:from-red-600 hover:to-red-700 text-white shadow-lg shadow-red-500/20',
        ghost: 'text-slate-600 hover:bg-slate-100 hover:text-slate-900',
        outline: 'border-2 border-primary-500 text-primary-600 hover:bg-primary-50'
      };
      const sizes = { sm: 'px-3 py-1.5 text-xs', md: 'px-4 py-2.5 text-sm', lg: 'px-6 py-3 text-base' };
      return (
        <button 
          className={variants[variant] + ' ' + sizes[size] + ' rounded-xl font-semibold transition-all duration-200 flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed btn-press ' + className} 
          disabled={loading || disabled} 
          {...props}
        >
          {loading ? <Spinner size="sm" /> : icon}
          {children}
        </button>
      );
    };

    const Input = ({ label, error, icon, helper, className = '', ...props }) => (
      <div className={className}>
        {label && <label className="block text-sm font-semibold text-slate-700 mb-1.5">{label}</label>}
        <div className="relative">
          {icon && <div className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400">{icon}</div>}
          <input 
            className={'w-full ' + (icon ? 'pl-10' : 'px-4') + ' pr-4 py-2.5 bg-white border-2 rounded-xl transition-all ' + (error ? 'border-red-300 focus:border-red-500' : 'border-slate-200 focus:border-primary-500 hover:border-slate-300')} 
            {...props} 
          />
        </div>
        {helper && !error && <p className="mt-1 text-xs text-slate-500">{helper}</p>}
        {error && <p className="mt-1 text-xs text-red-500 font-medium">{error}</p>}
      </div>
    );

    const Select = ({ label, options, className = '', ...props }) => (
      <div className={className}>
        {label && <label className="block text-sm font-semibold text-slate-700 mb-1.5">{label}</label>}
        <select className="w-full px-4 py-2.5 bg-white border-2 border-slate-200 rounded-xl focus:border-primary-500 hover:border-slate-300 transition-all appearance-none cursor-pointer" {...props}>
          {options.map(o => <option key={o.value} value={o.value}>{o.label}</option>)}
        </select>
      </div>
    );

    const Textarea = ({ label, className = '', ...props }) => (
      <div className={className}>
        {label && <label className="block text-sm font-semibold text-slate-700 mb-1.5">{label}</label>}
        <textarea className="w-full px-4 py-2.5 bg-white border-2 border-slate-200 rounded-xl focus:border-primary-500 hover:border-slate-300 transition-all resize-none" {...props} />
      </div>
    );

    const Checkbox = ({ label, checked, onChange, className = '' }) => (
      <label className={'flex items-center gap-3 cursor-pointer group ' + className}>
        <div className={'w-5 h-5 rounded-md border-2 flex items-center justify-center transition-all ' + (checked ? 'bg-primary-500 border-primary-500' : 'border-slate-300 group-hover:border-primary-400')}>
          {checked && <Icons.Check />}
        </div>
        <span className="text-sm font-medium text-slate-700">{label}</span>
      </label>
    );

    const Badge = ({ children, color = 'gray', size = 'sm' }) => {
      const colors = {
        gray: 'bg-slate-100 text-slate-700 border-slate-200',
        blue: 'bg-blue-50 text-blue-700 border-blue-200',
        green: 'bg-emerald-50 text-emerald-700 border-emerald-200',
        yellow: 'bg-amber-50 text-amber-700 border-amber-200',
        red: 'bg-red-50 text-red-700 border-red-200',
        purple: 'bg-purple-50 text-purple-700 border-purple-200',
        orange: 'bg-orange-50 text-orange-700 border-orange-200',
        cyan: 'bg-cyan-50 text-cyan-700 border-cyan-200',
        pink: 'bg-pink-50 text-pink-700 border-pink-200'
      };
      const sizes = { sm: 'px-2.5 py-0.5 text-xs', md: 'px-3 py-1 text-sm' };
      return <span className={colors[color] + ' ' + sizes[size] + ' font-semibold rounded-full border inline-flex items-center'}>{children}</span>;
    };

    const StatusBadge = ({ status }) => {
      const map = {
        draft: ['gray', 'Draft'], open: ['blue', 'Open'], investigating: ['orange', 'Investigating'],
        pending_review: ['yellow', 'Pending Review'], closed: ['green', 'Closed'], reopened: ['red', 'Reopened'],
        in_progress: ['blue', 'In Progress'], pending_verification: ['yellow', 'Pending Verification'],
        completed: ['green', 'Completed'], overdue: ['red', 'Overdue'], cancelled: ['gray', 'Cancelled'],
        scheduled: ['cyan', 'Scheduled'], assigned: ['orange', 'Assigned'], expired: ['red', 'Expired'],
        active: ['green', 'Active'], approved: ['green', 'Approved'], pending: ['yellow', 'Pending'],
        pending_approval: ['yellow', 'Pending Approval'], suspended: ['red', 'Suspended'], blacklisted: ['red', 'Blacklisted']
      };
      const [color, label] = map[status] || ['gray', status?.replace(/_/g, ' ') || 'Unknown'];
      return <Badge color={color}>{label}</Badge>;
    };

    const RiskBadge = ({ level }) => {
      const map = { low: 'risk-low', medium: 'risk-medium', high: 'risk-high', critical: 'risk-critical' };
      return <span className={(map[level] || 'risk-low') + ' px-3 py-1 rounded-full text-xs font-bold uppercase'}>{level || 'N/A'}</span>;
    };

    const Card = ({ title, subtitle, children, actions, className = '', noPadding = false, icon }) => (
      <div className={'bg-white rounded-2xl card-shadow border border-slate-100 overflow-hidden card-hover ' + className}>
        {(title || actions) && (
          <div className="px-5 py-4 border-b border-slate-100 flex flex-col sm:flex-row sm:items-center justify-between gap-3 bg-gradient-to-r from-slate-50 to-white">
            <div className="flex items-center gap-3">
              {icon && <div className="w-10 h-10 rounded-xl bg-primary-100 text-primary-600 flex items-center justify-center">{icon}</div>}
              <div>
                {title && <h3 className="text-lg font-bold text-slate-800">{title}</h3>}
                {subtitle && <p className="text-sm text-slate-500">{subtitle}</p>}
              </div>
            </div>
            {actions && <div className="flex items-center gap-2 flex-wrap">{actions}</div>}
          </div>
        )}
        <div className={noPadding ? '' : 'p-5'}>{children}</div>
      </div>
    );

    const Modal = ({ isOpen, onClose, title, children, size = 'md', footer }) => {
      if (!isOpen) return null;
      const sizes = { sm: 'max-w-md', md: 'max-w-2xl', lg: 'max-w-4xl', xl: 'max-w-6xl', full: 'max-w-[95vw]' };
      return (
        <div className="fixed inset-0 z-50 flex items-center justify-center p-4" onClick={onClose}>
          <div className="absolute inset-0 bg-slate-900/70 backdrop-blur-sm"></div>
          <div className={sizes[size] + ' relative bg-white rounded-2xl shadow-2xl w-full max-h-[90vh] overflow-hidden fade-in'} onClick={e => e.stopPropagation()}>
            <div className="px-6 py-4 border-b border-slate-100 flex items-center justify-between bg-gradient-to-r from-slate-50 to-white">
              <h2 className="text-xl font-bold text-slate-800">{title}</h2>
              <button onClick={onClose} className="p-2 hover:bg-slate-100 rounded-xl transition-colors text-slate-500 hover:text-slate-700"><Icons.X /></button>
            </div>
            <div className="p-6 overflow-y-auto max-h-[calc(90vh-140px)]">{children}</div>
            {footer && <div className="px-6 py-4 border-t border-slate-100 bg-slate-50 flex justify-end gap-3">{footer}</div>}
          </div>
        </div>
      );
    };

    const StatCard = ({ title, value, subtitle, icon, color = 'blue', trend, onClick }) => {
      const colors = {
        blue: 'from-primary-500 to-primary-600',
        green: 'from-emerald-500 to-emerald-600',
        yellow: 'from-amber-500 to-amber-600',
        red: 'from-red-500 to-red-600',
        purple: 'from-purple-500 to-purple-600',
        cyan: 'from-cyan-500 to-cyan-600'
      };
      return (
        <div className={'bg-white rounded-2xl card-shadow border border-slate-100 p-5 card-hover ' + (onClick ? 'cursor-pointer' : '')} onClick={onClick}>
          <div className="flex items-start justify-between">
            <div className="flex-1">
              <p className="text-sm font-medium text-slate-500">{title}</p>
              <p className="text-3xl font-bold text-slate-800 mt-1">{value}</p>
              {subtitle && <p className="text-sm text-slate-500 mt-1">{subtitle}</p>}
              {trend !== undefined && (
                <div className={'flex items-center gap-1 mt-2 text-sm font-semibold ' + (trend >= 0 ? 'text-emerald-600' : 'text-red-600')}>
                  <span>{trend >= 0 ? '‚Üë' : '‚Üì'}</span>
                  <span>{Math.abs(trend)}% vs last month</span>
                </div>
              )}
            </div>
            <div className={'bg-gradient-to-br ' + colors[color] + ' p-3 rounded-xl text-white shadow-lg'}>{icon}</div>
          </div>
        </div>
      );
    };

    const EmptyState = ({ icon, title, description, action }) => (
      <div className="flex flex-col items-center justify-center py-16 px-4">
        <div className="w-16 h-16 rounded-2xl bg-slate-100 flex items-center justify-center text-slate-400 mb-4">{icon || <Icons.Document />}</div>
        <h3 className="text-lg font-semibold text-slate-800 mb-1">{title || 'No data found'}</h3>
        {description && <p className="text-slate-500 text-center max-w-sm mb-4">{description}</p>}
        {action}
      </div>
    );

    const Table = ({ columns, data, loading, onRowClick, emptyMessage = 'No data found', emptyIcon }) => {
      if (loading) return <div className="flex flex-col items-center justify-center py-16"><Spinner size="lg" /><p className="mt-4 text-slate-500">Loading...</p></div>;
      if (!data?.length) return <EmptyState icon={emptyIcon} title={emptyMessage} />;
      return (
        <div className="overflow-x-auto">
          <table className="w-full">
            <thead>
              <tr className="bg-gradient-to-r from-slate-50 to-slate-100 border-b border-slate-200">
                {columns.map((c, i) => <th key={i} className="px-4 py-3.5 text-left text-xs font-bold text-slate-600 uppercase tracking-wider whitespace-nowrap">{c.header}</th>)}
              </tr>
            </thead>
            <tbody className="divide-y divide-slate-100">
              {data.map((row, i) => (
                <tr key={row._id || i} className={'transition-colors ' + (onRowClick ? 'cursor-pointer hover:bg-primary-50' : 'hover:bg-slate-50')} onClick={() => onRowClick?.(row)}>
                  {columns.map((c, j) => <td key={j} className="px-4 py-4 text-sm text-slate-700 whitespace-nowrap">{c.render ? c.render(row) : row[c.accessor]}</td>)}
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      );
    };

    const Pagination = ({ page, pages, total, onChange }) => {
      if (pages <= 1) return null;
      return (
        <div className="flex flex-col sm:flex-row items-center justify-between gap-3 px-4 py-4 border-t border-slate-100 bg-slate-50/50">
          <span className="text-sm text-slate-500">Showing page {page} of {pages} {total && `(${total} total)`}</span>
          <div className="flex gap-2">
            <Button variant="secondary" size="sm" disabled={page === 1} onClick={() => onChange(page - 1)}>‚Üê Previous</Button>
            <Button variant="secondary" size="sm" disabled={page === pages} onClick={() => onChange(page + 1)}>Next ‚Üí</Button>
          </div>
        </div>
      );
    };

    const Tabs = ({ tabs, active, onChange }) => (
      <div className="flex gap-1 p-1 bg-slate-100 rounded-xl overflow-x-auto">
        {tabs.map(t => (
          <button
            key={t.id}
            onClick={() => onChange(t.id)}
            className={'px-4 py-2 rounded-lg font-medium text-sm transition-all whitespace-nowrap ' + (active === t.id ? 'bg-white text-primary-700 shadow-sm' : 'text-slate-600 hover:text-slate-900 hover:bg-white/50')}
          >
            {t.label}
          </button>
        ))}
      </div>
    );

    const Toast = ({ toasts, removeToast }) => (
      <div className="fixed bottom-4 right-4 z-50 space-y-2 max-w-sm">
        {toasts.map(t => (
          <div key={t.id} className={'px-4 py-3 rounded-xl shadow-xl text-white flex items-center gap-3 fade-in ' + (t.type === 'success' ? 'bg-gradient-to-r from-emerald-500 to-emerald-600' : t.type === 'error' ? 'bg-gradient-to-r from-red-500 to-red-600' : 'bg-gradient-to-r from-primary-500 to-primary-600')}>
            <span className="flex-1 font-medium">{t.message}</span>
            <button onClick={() => removeToast(t.id)} className="p-1 hover:bg-white/20 rounded-lg transition-colors"><Icons.X /></button>
          </div>
        ))}
      </div>
    );

    // ========== AUTH PAGES ==========
    const LoginPage = ({ onLogin, isSuperAdmin = false }) => {
      const [email, setEmail] = useState('');
      const [password, setPassword] = useState('');
      const [loading, setLoading] = useState(false);
      const [error, setError] = useState('');

      const handleSubmit = async (e) => {
        e.preventDefault();
        setLoading(true);
        setError('');
        try {
          const endpoint = isSuperAdmin ? '/auth/superadmin/login' : '/auth/login';
          const data = await api.post(endpoint, { email, password });
          if (data && data.token) {
            api.setToken(data.token);
            onLogin(data.user);
          } else {
            throw new Error('Invalid response from server');
          }
        } catch (err) { setError(err.message); } 
        finally { setLoading(false); }
      };

      const handleDemoLogin = async () => {
        setLoading(true);
        setError('');
        try {
          const data = await api.post('/auth/login', { email: 'demo@safetyfirst.com', password: 'demo123' });
          if (data && data.token) {
            api.setToken(data.token);
            onLogin(data.user);
          } else {
            throw new Error('Demo login failed');
          }
        } catch (err) { setError(err.message); }
        finally { setLoading(false); }
      };

      const bgClass = isSuperAdmin ? 'bg-gradient-to-br from-slate-800 to-slate-900' : 'gradient-bg';
      const iconBg = isSuperAdmin ? 'from-red-500 to-red-600' : 'from-primary-500 to-primary-700';

      return (
        <div className={'min-h-screen flex items-center justify-center p-4 ' + bgClass}>
          <div className="absolute inset-0 overflow-hidden pointer-events-none">
            <div className="absolute -top-40 -right-40 w-96 h-96 bg-white/10 rounded-full blur-3xl"></div>
            <div className="absolute -bottom-40 -left-40 w-96 h-96 bg-white/10 rounded-full blur-3xl"></div>
            <div className="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[800px] h-[800px] bg-white/5 rounded-full blur-3xl"></div>
          </div>
          <div className="relative bg-white rounded-3xl shadow-2xl w-full max-w-md p-8 slide-up">
            <div className="text-center mb-8">
              <div className={'w-20 h-20 bg-gradient-to-br rounded-2xl flex items-center justify-center mx-auto mb-4 shadow-xl rotate-3 hover:rotate-0 transition-transform ' + iconBg + (isSuperAdmin ? ' shadow-red-500/30' : ' shadow-primary-500/30')}>
                <Icons.Shield />
              </div>
              <h1 className="text-2xl font-bold text-slate-800">{isSuperAdmin ? 'SafetyFirst Admin' : 'SafetyFirst EHS'}</h1>
              <p className="text-slate-500 mt-2">{isSuperAdmin ? 'Platform Administration Portal' : 'Enterprise Safety Management Platform'}</p>
            </div>
            {error && <div className="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-xl mb-6 text-sm font-medium">{error}</div>}
            <form onSubmit={handleSubmit} className="space-y-5">
              <Input label="Email Address" type="email" value={email} onChange={(e) => setEmail(e.target.value)} placeholder={isSuperAdmin ? 'admin@safetyfirst.com' : 'you@company.com'} icon={<Icons.Users />} required />
              <Input label="Password" type="password" value={password} onChange={(e) => setPassword(e.target.value)} placeholder="Enter your password" required />
              <Button type="submit" loading={loading} className="w-full" size="lg">Sign In</Button>
            </form>
            {!isSuperAdmin && (
              <div className="mt-6 text-center">
                <p className="text-sm text-slate-500">Don't have an account? <a href="/register" className="text-primary-600 font-semibold hover:underline">Start 14-day trial</a></p>
              </div>
            )}
            {isSuperAdmin && (
              <div className="mt-6 text-center">
                <a href="/" className="text-sm text-slate-500 hover:text-slate-700">‚Üê Back to main site</a>
              </div>
            )}
          </div>
        </div>
      );
    };

    const RegisterPage = ({ onRegister }) => {
      const [form, setForm] = useState({ organizationName: '', firstName: '', lastName: '', email: '', phone: '', password: '', confirmPassword: '', industry: '' });
      const [loading, setLoading] = useState(false);
      const [error, setError] = useState('');
      const handleChange = (f) => (e) => setForm(p => ({ ...p, [f]: e.target.value }));
      
      const handleSubmit = async (e) => {
        e.preventDefault();
        if (form.password !== form.confirmPassword) { setError('Passwords do not match'); return; }
        if (form.password.length < 8) { setError('Password must be at least 8 characters'); return; }
        setLoading(true); setError('');
        try { 
          const data = await api.post('/auth/register', form); 
          api.setToken(data.token); 
          onRegister(data.user); 
        } catch (err) { setError(err.message); } 
        finally { setLoading(false); }
      };
      
      return (
        <div className="min-h-screen gradient-bg flex items-center justify-center p-4">
          <div className="relative bg-white rounded-3xl shadow-2xl w-full max-w-2xl p-8 slide-up my-8">
            <div className="text-center mb-8">
              <div className="w-16 h-16 bg-gradient-to-br from-primary-500 to-primary-700 rounded-2xl flex items-center justify-center mx-auto mb-4 shadow-xl"><Icons.Shield /></div>
              <h1 className="text-2xl font-bold text-slate-800">Start Your Free Trial</h1>
              <p className="text-slate-500 mt-2">14 days free ‚Ä¢ No credit card required ‚Ä¢ Cancel anytime</p>
            </div>
            {error && <div className="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-xl mb-6 text-sm font-medium">{error}</div>}
            <form onSubmit={handleSubmit} className="space-y-5">
              <Input label="Organization Name" value={form.organizationName} onChange={handleChange('organizationName')} placeholder="Acme Safety Corp" required />
              <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <Input label="First Name" value={form.firstName} onChange={handleChange('firstName')} placeholder="John" required />
                <Input label="Last Name" value={form.lastName} onChange={handleChange('lastName')} placeholder="Smith" required />
              </div>
              <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <Input label="Work Email" type="email" value={form.email} onChange={handleChange('email')} placeholder="john@company.com" required />
                <Input label="Phone (Optional)" type="tel" value={form.phone} onChange={handleChange('phone')} placeholder="+1 (555) 000-0000" />
              </div>
              <Select label="Industry" value={form.industry} onChange={handleChange('industry')} options={[
                { value: '', label: 'Select your industry' },
                { value: 'manufacturing', label: 'üè≠ Manufacturing' },
                { value: 'construction', label: 'üèóÔ∏è Construction' },
                { value: 'healthcare', label: 'üè• Healthcare' },
                { value: 'logistics', label: 'üì¶ Logistics & Distribution' },
                { value: 'energy', label: '‚ö° Energy & Utilities' },
                { value: 'mining', label: '‚õèÔ∏è Mining' },
                { value: 'oil_gas', label: 'üõ¢Ô∏è Oil & Gas' },
                { value: 'other', label: 'Other' }
              ]} />
              <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <Input label="Password" type="password" value={form.password} onChange={handleChange('password')} placeholder="Min 8 characters" helper="Must be at least 8 characters" required />
                <Input label="Confirm Password" type="password" value={form.confirmPassword} onChange={handleChange('confirmPassword')} placeholder="Confirm password" required />
              </div>
              <Button type="submit" loading={loading} className="w-full" size="lg">Create Account & Start Trial</Button>
            </form>
            <p className="mt-6 text-center text-sm text-slate-500">Already have an account? <a href="/login" className="text-primary-600 font-semibold hover:underline">Sign in</a></p>
          </div>
        </div>
      );
    };

    // ========== SIDEBAR ==========
    const Sidebar = ({ page, setPage, user, onLogout, mobileOpen, setMobileOpen }) => {
      const tier = user?.organization?.subscription?.tier || 'starter';
      const features = {
        starter: { risk: false, jsa: false, permit: false, contractor: false, chemical: false, health: false, emergency: false, ergo: false, reports: false, moc: false, supplier: false, asset: false, environmental: false, quality: false, capa: false },
        professional: { risk: true, jsa: true, permit: true, contractor: true, chemical: false, health: false, emergency: true, ergo: false, reports: true, moc: true, supplier: true, asset: true, environmental: false, quality: true, capa: true },
        enterprise: { risk: true, jsa: true, permit: true, contractor: true, chemical: true, health: true, emergency: true, ergo: true, reports: true, moc: true, supplier: true, asset: true, environmental: true, quality: true, capa: true }
      }[tier] || {};

      const sections = [
        { title: 'Overview', items: [
          { id: 'dashboard', label: 'Dashboard', icon: Icons.Dashboard },
          { id: 'inbox', label: 'My Inbox', icon: Icons.Action },
        ]},
        { title: 'Core Safety', items: [
          { id: 'incidents', label: 'Incidents', icon: Icons.Incident },
          { id: 'observations', label: 'Safety Observations', icon: Icons.Observation },
          { id: 'icare', label: 'I-CARE Notes', icon: Icons.Health },
          { id: 'actions', label: 'Action Items', icon: Icons.Action },
          { id: 'inspections', label: 'Inspections', icon: Icons.Inspection },
          { id: 'training', label: 'Training', icon: Icons.Training },
        ]},
        { title: 'Risk & Compliance', items: [
          { id: 'risk', label: 'Risk Assessments', icon: Icons.Risk, req: 'risk' },
          { id: 'jsa', label: 'Job Safety Analysis', icon: Icons.JSA, req: 'jsa' },
          { id: 'permits', label: 'Permits to Work', icon: Icons.Permit, req: 'permit' },
          { id: 'moc', label: 'Management of Change', icon: Icons.MOC, req: 'moc' },
          { id: 'audits', label: 'Scheduled Audits', icon: Icons.Audit, role: ['admin', 'manager', 'safety_officer'] },
          { id: 'osha', label: 'OSHA Logs', icon: Icons.OSHA },
        ]},
        { title: 'Operations', items: [
          { id: 'contractors', label: 'Contractors', icon: Icons.Contractor, req: 'contractor' },
          { id: 'suppliers', label: 'Supplier Management', icon: Icons.Supplier, req: 'supplier' },
          { id: 'assets', label: 'Asset Management', icon: Icons.Asset, req: 'asset' },
          { id: 'chemicals', label: 'Chemical/SDS', icon: Icons.Chemical, req: 'chemical' },
          { id: 'health', label: 'Occupational Health', icon: Icons.Health, req: 'health' },
          { id: 'emergency', label: 'Emergency Plans', icon: Icons.Emergency, req: 'emergency' },
          { id: 'ergonomics', label: 'Ergonomics', icon: Icons.Ergo, req: 'ergo' },
        ]},
        { title: 'Environment & Quality', items: [
          { id: 'environmental', label: 'Environmental', icon: Icons.Environment, req: 'environmental' },
          { id: 'quality', label: 'Quality/NCR', icon: Icons.Quality, req: 'quality' },
          { id: 'capa', label: 'CAPA', icon: Icons.CAPA, req: 'capa' },
        ]},
        { title: 'Resources', items: [
          { id: 'documents', label: 'Documents', icon: Icons.Document },
          { id: 'meetings', label: 'Safety Meetings', icon: Icons.Meeting },
          { id: 'reports', label: 'Reports', icon: Icons.Reports, req: 'reports' },
          { id: 'customreports', label: 'Report Builder', icon: Icons.Reports, role: ['admin', 'manager', 'safety_officer'] },
        ]},
        { title: 'Admin', items: [
          { id: 'hierarchy', label: 'Org Hierarchy', icon: Icons.Users, role: ['admin', 'superadmin'] },
          { id: 'formbuilder', label: 'Form Builder', icon: Icons.Document, role: ['admin', 'superadmin'] },
          { id: 'archived', label: 'Archived', icon: Icons.Document, role: ['admin', 'superadmin', 'moderator'] },
          { id: 'users', label: 'Users', icon: Icons.Users, role: ['admin', 'superadmin'] },
          { id: 'audit', label: 'Audit Logs', icon: Icons.Audit, role: ['admin', 'superadmin'] },
          { id: 'settings', label: 'Settings', icon: Icons.Settings, role: ['admin', 'superadmin'] },
        ]},
      ];

      const filteredSections = sections
        .map(s => ({ ...s, items: s.items.filter(i => (!i.req || features[i.req]) && (!i.role || i.role.includes(user?.role))) }))
        .filter(s => s.items.length > 0);

      const tierColors = { starter: 'blue', professional: 'purple', enterprise: 'yellow' };

      return (
        <>
          {mobileOpen && <div className="fixed inset-0 bg-black/60 backdrop-blur-sm z-40 lg:hidden" onClick={() => setMobileOpen(false)}></div>}
          <aside className={'fixed lg:static inset-y-0 left-0 z-50 w-72 bg-slate-900 text-white flex flex-col transition-transform duration-300 lg:translate-x-0 ' + (mobileOpen ? 'translate-x-0' : 'sidebar-hidden')}>
            <div className="p-5 border-b border-slate-800/50">
              <div className="flex items-center gap-3">
                <div className="w-11 h-11 bg-gradient-to-br from-primary-400 to-primary-600 rounded-xl flex items-center justify-center shadow-lg shadow-primary-500/30">
                  <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" /></svg>
                </div>
                <div>
                  <div className="font-bold text-lg">SafetyFirst</div>
                  <Badge color={tierColors[tier]} size="sm">{tier.toUpperCase()}</Badge>
                </div>
              </div>
            </div>
            <nav className="flex-1 overflow-y-auto py-4 px-3">
              {filteredSections.map((section, idx) => (
                <div key={idx} className="mb-5">
                  <p className="px-3 mb-2 text-xs font-bold text-slate-500 uppercase tracking-wider">{section.title}</p>
                  {section.items.map(item => (
                    <button
                      key={item.id}
                      onClick={() => { setPage(item.id); setMobileOpen(false); }}
                      className={'w-full flex items-center gap-3 px-3 py-2.5 rounded-xl mb-1 transition-all font-medium ' + (page === item.id ? 'bg-gradient-to-r from-primary-600 to-primary-700 text-white shadow-lg shadow-primary-600/30' : 'text-slate-400 hover:bg-slate-800 hover:text-white')}
                    >
                      <item.icon /><span>{item.label}</span>
                    </button>
                  ))}
                </div>
              ))}
            </nav>
            <div className="p-4 border-t border-slate-800/50">
              <div className="flex items-center gap-3 mb-4 p-2 rounded-xl bg-slate-800/50">
                <div className="w-10 h-10 bg-gradient-to-br from-primary-400 to-primary-600 rounded-full flex items-center justify-center font-bold text-sm">{user?.firstName?.[0]}{user?.lastName?.[0]}</div>
                <div className="flex-1 min-w-0">
                  <p className="font-semibold truncate text-sm">{user?.firstName} {user?.lastName}</p>
                  <p className="text-xs text-slate-400 truncate capitalize">{user?.role?.replace('_', ' ')}</p>
                </div>
              </div>
              <button onClick={onLogout} className="w-full flex items-center justify-center gap-2 px-4 py-2.5 bg-slate-800 hover:bg-red-600 rounded-xl transition-all font-medium text-sm">
                <Icons.Logout /><span>Sign Out</span>
              </button>
            </div>
          </aside>
        </>
      );
    };

    // ========== HEADER ==========
    const Header = ({ user, setMobileOpen }) => {
      const [showNotifs, setShowNotifs] = useState(false);
      const [notifications, setNotifications] = useState([]);
      const [unreadCount, setUnreadCount] = useState(0);
      const [loadingNotifs, setLoadingNotifs] = useState(false);

      useEffect(() => {
        fetchNotifications();
        // Poll for new notifications every 30 seconds
        const interval = setInterval(fetchNotifications, 30000);
        return () => clearInterval(interval);
      }, []);

      const fetchNotifications = async () => {
        try {
          const data = await api.get('/notifications?limit=10&unreadOnly=true');
          setNotifications(data.notifications || []);
          setUnreadCount(data.unreadCount || 0);
        } catch (e) {
          // Demo notifications
          setNotifications([
            { _id: '1', type: 'action_assigned', title: 'New Action Item Assigned', message: 'Update safety signage in warehouse', isRead: false, createdAt: new Date(), entityType: 'action', actionUrl: '/actions/1' },
            { _id: '2', type: 'incident_status_change', title: 'Incident Status Updated', message: 'INC-042 moved to investigating', isRead: false, createdAt: new Date(Date.now() - 3600000), entityType: 'incident', actionUrl: '/incidents/2' },
            { _id: '3', type: 'training_due_soon', title: 'Training Due Soon', message: 'Forklift Certification expires in 7 days', isRead: true, createdAt: new Date(Date.now() - 86400000), entityType: 'training', actionUrl: '/training/3' },
          ]);
          setUnreadCount(2);
        }
      };

      const markAsRead = async (id) => {
        try {
          await api.put('/notifications/' + id + '/read');
          setNotifications(prev => prev.map(n => n._id === id ? { ...n, isRead: true } : n));
          setUnreadCount(prev => Math.max(0, prev - 1));
        } catch (e) {}
      };

      const markAllRead = async () => {
        try {
          await api.put('/notifications/read-all');
          setNotifications(prev => prev.map(n => ({ ...n, isRead: true })));
          setUnreadCount(0);
        } catch (e) {}
      };

      const notifTypeIcons = {
        action_assigned: 'üìã', action_completed: '‚úÖ', action_overdue: '‚ö†Ô∏è',
        incident_assigned: 'üö®', incident_status_change: 'üîÑ',
        training_due_soon: 'üìö', training_completed: 'üéì',
        audit_assigned: 'üìù', approval_needed: 'üëÅÔ∏è', icare_received: 'üíö'
      };

      return (
        <header className="bg-white/80 backdrop-blur-lg border-b border-slate-200/50 px-4 lg:px-6 py-4 sticky top-0 z-30">
          <div className="flex items-center justify-between">
            <div className="flex items-center gap-4">
              <button onClick={() => setMobileOpen(true)} className="lg:hidden p-2 hover:bg-slate-100 rounded-xl transition-colors"><Icons.Menu /></button>
              <div>
                <h1 className="text-lg font-bold text-slate-800 truncate max-w-[200px] sm:max-w-none">{user?.organization?.name || 'Organization'}</h1>
                <p className="text-sm text-slate-500 hidden sm:block">{new Date().toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' })}</p>
              </div>
            </div>
            <div className="flex items-center gap-2">
              {/* Notification Bell */}
              <div className="relative">
                <button onClick={() => setShowNotifs(!showNotifs)} className="p-2.5 hover:bg-slate-100 rounded-xl relative transition-colors">
                  <Icons.Bell />
                  {unreadCount > 0 && (
                    <span className="absolute -top-0.5 -right-0.5 min-w-5 h-5 bg-red-500 rounded-full border-2 border-white flex items-center justify-center text-xs text-white font-bold">
                      {unreadCount > 9 ? '9+' : unreadCount}
                    </span>
                  )}
                </button>
                
                {/* Notification Dropdown */}
                {showNotifs && (
                  <div className="absolute right-0 top-full mt-2 w-80 sm:w-96 bg-white rounded-2xl shadow-2xl border border-slate-200 z-50 overflow-hidden">
                    <div className="flex items-center justify-between p-4 border-b border-slate-100 bg-slate-50">
                      <h3 className="font-bold text-slate-800">Notifications</h3>
                      {unreadCount > 0 && (
                        <button onClick={markAllRead} className="text-sm text-primary-600 hover:text-primary-700 font-medium">Mark all read</button>
                      )}
                    </div>
                    <div className="max-h-96 overflow-y-auto">
                      {notifications.length === 0 ? (
                        <div className="p-8 text-center text-slate-500">
                          <Icons.Bell />
                          <p className="mt-2">No notifications</p>
                        </div>
                      ) : (
                        notifications.map(notif => (
                          <div 
                            key={notif._id} 
                            onClick={() => { markAsRead(notif._id); if(notif.actionUrl) window.location.hash = notif.actionUrl; setShowNotifs(false); }}
                            className={`p-4 border-b border-slate-100 hover:bg-slate-50 cursor-pointer transition-colors ${!notif.isRead ? 'bg-primary-50/50' : ''}`}
                          >
                            <div className="flex gap-3">
                              <div className="text-xl">{notifTypeIcons[notif.type] || 'üîî'}</div>
                              <div className="flex-1 min-w-0">
                                <p className={`text-sm ${!notif.isRead ? 'font-semibold text-slate-800' : 'text-slate-600'}`}>{notif.title}</p>
                                <p className="text-sm text-slate-500 truncate">{notif.message}</p>
                                <p className="text-xs text-slate-400 mt-1">{new Date(notif.createdAt).toLocaleString()}</p>
                              </div>
                              {!notif.isRead && <div className="w-2 h-2 bg-primary-500 rounded-full mt-2"></div>}
                            </div>
                          </div>
                        ))
                      )}
                    </div>
                    <div className="p-3 border-t border-slate-100 bg-slate-50">
                      <button onClick={() => { setShowNotifs(false); }} className="w-full text-center text-sm text-primary-600 hover:text-primary-700 font-medium">
                        View All Notifications
                      </button>
                    </div>
                  </div>
                )}
              </div>
              
              {/* Quick Actions */}
              <button onClick={() => window.location.hash = 'inbox'} className="p-2.5 hover:bg-slate-100 rounded-xl transition-colors hidden sm:block" title="My Inbox">
                <Icons.Action />
              </button>
              
              <div className="hidden sm:flex items-center gap-3 pl-3 ml-2 border-l border-slate-200">
                <div className="w-10 h-10 bg-gradient-to-br from-primary-500 to-primary-600 rounded-full flex items-center justify-center text-white font-bold shadow-lg shadow-primary-500/20">
                  {user?.firstName?.[0]}{user?.lastName?.[0]}
                </div>
                <div className="hidden md:block">
                  <p className="text-sm font-semibold text-slate-800">{user?.firstName} {user?.lastName}</p>
                  <p className="text-xs text-slate-500 capitalize">{user?.role?.replace('_', ' ')}</p>
                </div>
              </div>
            </div>
          </div>
        </header>
      );
    };

    // ========== DASHBOARD ==========
    const DashboardPage = () => {
      const [data, setData] = useState(null);
      const [loading, setLoading] = useState(true);
      const [showDashboardBuilder, setShowDashboardBuilder] = useState(false);
      
      useEffect(() => { 
        api.get('/dashboard')
          .then(setData)
          .catch(console.error)
          .finally(() => setLoading(false)); 
      }, []);
      
      if (loading) return <div className="flex items-center justify-center h-96"><Spinner size="lg" /></div>;

      const chartData = data?.trends?.incidents?.map(i => ({ month: ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'][i._id?.month - 1] || 'N/A', incidents: i.count, recordable: i.recordable })) || [];

      return (
        <div className="space-y-6 slide-up">
          <div className="flex flex-col lg:flex-row lg:items-center justify-between gap-4">
            <div>
              <h2 className="text-2xl lg:text-3xl font-bold text-slate-800">Safety Dashboard</h2>
              <p className="text-slate-500 mt-1">Real-time overview of your safety performance</p>
            </div>
            <div className="flex gap-3">
              <Button variant="secondary" icon={<Icons.Settings />} onClick={() => setShowDashboardBuilder(true)}>Customize</Button>
              <Button variant="secondary" icon={<Icons.Download />}>Export</Button>
              <Button icon={<Icons.Plus />}>Quick Report</Button>
            </div>
          </div>

          <div className="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-4 gap-4 lg:gap-6">
            <StatCard title="Open Incidents" value={data?.incidents?.open || 0} subtitle={(data?.incidents?.ytd || 0) + ' total YTD'} icon={<Icons.Incident />} color="red" trend={-12} />
            <StatCard title="Overdue Actions" value={data?.actionItems?.overdue || 0} subtitle={(data?.actionItems?.open || 0) + ' actions open'} icon={<Icons.Action />} color="yellow" />
            <StatCard title="OSHA Recordables" value={data?.incidents?.recordable || 0} subtitle="Year to date" icon={<Icons.OSHA />} color="blue" />
            <StatCard title="Training Compliance" value={data?.training?.completionRate ? (data.training.completionRate + '%') : '0%'} subtitle={(data?.training?.overdueTraining || 0) + ' overdue'} icon={<Icons.Training />} color="green" />
          </div>

          <div className="grid grid-cols-1 xl:grid-cols-3 gap-6">
            <Card title="Incident Trends" subtitle="Monthly incident overview" className="xl:col-span-2" icon={<Icons.Reports />}>
              <ResponsiveContainer width="100%" height={300}>
                <AreaChart data={chartData}>
                  <defs>
                    <linearGradient id="incidentGrad" x1="0" y1="0" x2="0" y2="1">
                      <stop offset="5%" stopColor="#3b82f6" stopOpacity={0.3}/>
                      <stop offset="95%" stopColor="#3b82f6" stopOpacity={0}/>
                    </linearGradient>
                    <linearGradient id="recordableGrad" x1="0" y1="0" x2="0" y2="1">
                      <stop offset="5%" stopColor="#ef4444" stopOpacity={0.3}/>
                      <stop offset="95%" stopColor="#ef4444" stopOpacity={0}/>
                    </linearGradient>
                  </defs>
                  <CartesianGrid strokeDasharray="3 3" stroke="#e2e8f0" vertical={false} />
                  <XAxis dataKey="month" stroke="#94a3b8" fontSize={12} tickLine={false} axisLine={false} />
                  <YAxis stroke="#94a3b8" fontSize={12} tickLine={false} axisLine={false} />
                  <Tooltip contentStyle={{ borderRadius: '12px', border: 'none', boxShadow: '0 10px 40px rgba(0,0,0,0.15)', padding: '12px' }} />
                  <Area type="monotone" dataKey="incidents" stroke="#3b82f6" strokeWidth={2} fillOpacity={1} fill="url(#incidentGrad)" name="Total Incidents" />
                  <Area type="monotone" dataKey="recordable" stroke="#ef4444" strokeWidth={2} fillOpacity={1} fill="url(#recordableGrad)" name="Recordable" />
                </AreaChart>
              </ResponsiveContainer>
            </Card>

            <Card title="By Incident Type" subtitle="Distribution breakdown" icon={<Icons.Incident />}>
              <ResponsiveContainer width="100%" height={300}>
                <PieChart>
                  <Pie 
                    data={data?.trends?.byType || []} 
                    cx="50%" cy="50%" 
                    innerRadius={60} outerRadius={90} 
                    paddingAngle={4} 
                    dataKey="count"
                    label={({ _id, percent }) => `${(_id || '').slice(0,6)}... ${(percent * 100).toFixed(0)}%`}
                    labelLine={false}
                  >
                    {(data?.trends?.byType || []).map((e, i) => <Cell key={i} fill={COLORS[i % COLORS.length]} />)}
                  </Pie>
                  <Tooltip formatter={(v, n, p) => [v, p.payload._id]} />
                </PieChart>
              </ResponsiveContainer>
            </Card>
          </div>

          <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <Card title="Recent Incidents" subtitle="Latest reported incidents" noPadding icon={<Icons.Incident />}>
              {data?.recentActivity?.incidents?.length ? (
                <div className="divide-y divide-slate-100">
                  {data.recentActivity.incidents.slice(0, 5).map(i => (
                    <div key={i._id} className="flex items-center justify-between p-4 hover:bg-slate-50 transition-colors">
                      <div className="flex items-center gap-4 min-w-0">
                        <div className="w-11 h-11 bg-red-100 text-red-600 rounded-xl flex items-center justify-center flex-shrink-0"><Icons.Incident /></div>
                        <div className="min-w-0">
                          <p className="font-semibold text-slate-800 truncate">{i.incidentNumber}</p>
                          <p className="text-sm text-slate-500 truncate">{i.title}</p>
                        </div>
                      </div>
                      <StatusBadge status={i.status} />
                    </div>
                  ))}
                </div>
              ) : <EmptyState title="No recent incidents" description="Great job maintaining safety!" />}
            </Card>

            <Card title="Action Items Due" subtitle="Requires immediate attention" noPadding icon={<Icons.Action />}>
              {data?.recentActivity?.actionItems?.filter(a => new Date(a.dueDate) < new Date() && a.status !== 'completed').length ? (
                <div className="divide-y divide-slate-100">
                  {data.recentActivity.actionItems.filter(a => new Date(a.dueDate) < new Date() && a.status !== 'completed').slice(0, 5).map(a => (
                    <div key={a._id} className="flex items-center justify-between p-4 hover:bg-slate-50 transition-colors">
                      <div className="flex items-center gap-4 min-w-0">
                        <div className="w-11 h-11 bg-amber-100 text-amber-600 rounded-xl flex items-center justify-center flex-shrink-0"><Icons.Action /></div>
                        <div className="min-w-0">
                          <p className="font-semibold text-slate-800 truncate">{a.actionNumber}</p>
                          <p className="text-sm text-slate-500 truncate">{a.title}</p>
                        </div>
                      </div>
                      <span className="text-sm font-bold text-red-600 whitespace-nowrap">Due: {new Date(a.dueDate).toLocaleDateString()}</span>
                    </div>
                  ))}
                </div>
              ) : <EmptyState title="No overdue actions" description="All action items are on track!" icon={<Icons.Check />} />}
            </Card>
          </div>

          {showDashboardBuilder && <DashboardBuilderModal isOpen={showDashboardBuilder} onClose={() => setShowDashboardBuilder(false)} />}
        </div>
      );
    };

    // ========== DASHBOARD BUILDER MODAL ==========
    const DashboardBuilderModal = ({ isOpen, onClose }) => {
      const [widgets, setWidgets] = useState([]);
      const [dashboards, setDashboards] = useState([]);
      const [loading, setLoading] = useState(true);
      const [tab, setTab] = useState('widgets');
      const [editWidget, setEditWidget] = useState(null);
      const { addToast } = useContext(ToastContext) || {};

      useEffect(() => {
        fetchWidgets();
        fetchDashboards();
      }, [isOpen]);

      const fetchWidgets = async () => {
        try {
          const data = await api.get('/widgets');
          setWidgets(data.widgets || []);
        } catch (e) {
          setWidgets([
            { _id: '1', name: 'Open Incidents', widgetType: 'stat_card', dataSource: 'incidents', display: { color: 'red', icon: 'Incident' } },
            { _id: '2', name: 'Incident Trend', widgetType: 'line_chart', dataSource: 'incidents', display: { title: 'Monthly Incidents' } }
          ]);
        }
        setLoading(false);
      };

      const fetchDashboards = async () => {
        try {
          const data = await api.get('/dashboards');
          setDashboards(data.dashboards || []);
        } catch (e) {}
      };

      const widgetTypes = [
        { type: 'stat_card', label: 'Stat Card', icon: '#', desc: 'Single metric with optional trend' },
        { type: 'line_chart', label: 'Line Chart', icon: 'üìà', desc: 'Trend over time' },
        { type: 'bar_chart', label: 'Bar Chart', icon: 'üìä', desc: 'Comparison chart' },
        { type: 'pie_chart', label: 'Pie Chart', icon: 'ü•ß', desc: 'Distribution breakdown' },
        { type: 'table', label: 'Data Table', icon: 'üìã', desc: 'Tabular data' },
        { type: 'gauge', label: 'Gauge', icon: 'üéØ', desc: 'Progress toward goal' },
        { type: 'kpi', label: 'KPI Card', icon: '‚≠ê', desc: 'Key performance indicator' }
      ];

      const dataSources = [
        { value: 'incidents', label: 'Incidents' },
        { value: 'actions', label: 'Action Items' },
        { value: 'inspections', label: 'Inspections' },
        { value: 'training', label: 'Training' },
        { value: 'icare', label: 'I-CARE Notes' },
        { value: 'audits', label: 'Audits' }
      ];

      const createWidget = async (type) => {
        const newWidget = {
          name: 'New ' + widgetTypes.find(w => w.type === type)?.label,
          widgetType: type,
          dataSource: 'incidents',
          filters: { dateRange: 'this_year' },
          display: { size: 'medium' }
        };
        try {
          const data = await api.post('/widgets', newWidget);
          setWidgets(prev => [...prev, data.widget || newWidget]);
          addToast?.('Widget created', 'success');
        } catch (e) {
          setWidgets(prev => [...prev, { ...newWidget, _id: Date.now().toString() }]);
        }
      };

      const deleteWidget = async (id) => {
        if (!confirm('Delete this widget?')) return;
        try {
          await api.del('/widgets/' + id);
          setWidgets(prev => prev.filter(w => w._id !== id));
          addToast?.('Widget deleted', 'success');
        } catch (e) {}
      };

      return (
        <Modal isOpen={isOpen} onClose={onClose} title="Customize Dashboard" size="xl">
          <div className="flex flex-wrap gap-1 mb-6 border-b border-slate-200 pb-3">
            {['widgets', 'add_new', 'dashboards'].map(t => (
              <button key={t} onClick={() => setTab(t)}
                className={`px-3 py-2 text-sm font-medium rounded-lg capitalize ${tab === t ? 'bg-primary-100 text-primary-700' : 'text-slate-600 hover:bg-slate-100'}`}>
                {t.replace('_', ' ')}
              </button>
            ))}
          </div>

          <div className="max-h-[60vh] overflow-y-auto pr-2">
            {tab === 'widgets' && (
              <>
                <h4 className="font-semibold text-slate-800 mb-4">Your Widgets ({widgets.length})</h4>
                {loading ? (
                  <div className="text-center py-8"><Spinner /></div>
                ) : widgets.length === 0 ? (
                  <div className="text-center py-8 text-slate-500">
                    <p>No custom widgets yet.</p>
                    <Button size="sm" className="mt-4" onClick={() => setTab('add_new')}>Create Your First Widget</Button>
                  </div>
                ) : (
                  <div className="grid grid-cols-2 gap-4">
                    {widgets.map(widget => (
                      <div key={widget._id} className="p-4 bg-slate-50 rounded-xl border border-slate-200 hover:shadow-md transition-shadow">
                        <div className="flex justify-between items-start mb-2">
                          <div>
                            <p className="font-semibold text-slate-800">{widget.name}</p>
                            <div className="flex gap-2 mt-1">
                              <Badge color="blue" size="sm">{widget.widgetType?.replace('_', ' ')}</Badge>
                              <Badge color="gray" size="sm">{widget.dataSource}</Badge>
                            </div>
                          </div>
                          <div className="flex gap-1">
                            <button onClick={() => setEditWidget(widget)} className="p-1 hover:bg-primary-100 rounded text-slate-500 hover:text-primary-600"><Icons.Edit /></button>
                            <button onClick={() => deleteWidget(widget._id)} className="p-1 hover:bg-red-100 rounded text-slate-500 hover:text-red-600"><Icons.Trash /></button>
                          </div>
                        </div>
                        <p className="text-xs text-slate-500">
                          Filter: {widget.filters?.dateRange?.replace('_', ' ') || 'All time'}
                        </p>
                      </div>
                    ))}
                  </div>
                )}
              </>
            )}

            {tab === 'add_new' && (
              <>
                <h4 className="font-semibold text-slate-800 mb-4">Add New Widget</h4>
                <div className="grid grid-cols-2 gap-4">
                  {widgetTypes.map(wt => (
                    <div key={wt.type} onClick={() => createWidget(wt.type)}
                      className="p-4 bg-white rounded-xl border-2 border-slate-200 hover:border-primary-400 hover:shadow-md cursor-pointer transition-all">
                      <div className="flex items-center gap-3">
                        <span className="text-3xl">{wt.icon}</span>
                        <div>
                          <p className="font-semibold text-slate-800">{wt.label}</p>
                          <p className="text-sm text-slate-500">{wt.desc}</p>
                        </div>
                      </div>
                    </div>
                  ))}
                </div>
              </>
            )}

            {tab === 'dashboards' && (
              <>
                <div className="flex items-center justify-between mb-4">
                  <h4 className="font-semibold text-slate-800">Saved Dashboards</h4>
                  <Button size="sm" icon={<Icons.Plus />} onClick={async () => {
                    try {
                      await api.post('/dashboards', { name: 'My Dashboard', layout: [] });
                      fetchDashboards();
                      addToast?.('Dashboard created', 'success');
                    } catch (e) {}
                  }}>New Dashboard</Button>
                </div>
                {dashboards.length === 0 ? (
                  <div className="text-center py-8 text-slate-500">
                    <p>No saved dashboards. Create one to save your widget layout.</p>
                  </div>
                ) : (
                  <div className="space-y-3">
                    {dashboards.map(dash => (
                      <div key={dash._id} className="flex items-center justify-between p-4 bg-slate-50 rounded-xl">
                        <div>
                          <p className="font-semibold text-slate-800">{dash.name}</p>
                          <p className="text-sm text-slate-500">{dash.layout?.length || 0} widgets ‚Ä¢ {dash.isDefault ? 'Default' : ''}</p>
                        </div>
                        <div className="flex gap-2">
                          <Button size="sm" variant="secondary">Load</Button>
                          {!dash.isDefault && <Button size="sm" variant="secondary">Set Default</Button>}
                        </div>
                      </div>
                    ))}
                  </div>
                )}
              </>
            )}
          </div>

          {editWidget && (
            <WidgetEditorModal 
              isOpen={!!editWidget} 
              onClose={() => setEditWidget(null)} 
              widget={editWidget} 
              onSave={(updated) => {
                setWidgets(prev => prev.map(w => w._id === updated._id ? updated : w));
                setEditWidget(null);
              }} 
            />
          )}
        </Modal>
      );
    };

    // ========== WIDGET EDITOR MODAL ==========
    const WidgetEditorModal = ({ isOpen, onClose, widget, onSave }) => {
      const [form, setForm] = useState({});
      const [saving, setSaving] = useState(false);
      const { addToast } = useContext(ToastContext) || {};

      useEffect(() => {
        if (widget) setForm({ ...widget });
      }, [widget]);

      const handleSave = async () => {
        setSaving(true);
        try {
          const data = await api.put('/widgets/' + widget._id, form);
          addToast?.('Widget updated', 'success');
          onSave(data.widget || form);
        } catch (e) {
          onSave(form);
        }
        setSaving(false);
      };

      return (
        <Modal isOpen={isOpen} onClose={onClose} title="Edit Widget" size="lg"
          footer={<><Button variant="secondary" onClick={onClose}>Cancel</Button><Button onClick={handleSave} loading={saving}>Save Widget</Button></>}
        >
          <div className="space-y-4">
            <Input label="Widget Name" value={form.name || ''} onChange={e => setForm(p => ({ ...p, name: e.target.value }))} />
            <div className="grid grid-cols-2 gap-4">
              <Select label="Data Source" value={form.dataSource || 'incidents'} onChange={e => setForm(p => ({ ...p, dataSource: e.target.value }))} options={[
                { value: 'incidents', label: 'Incidents' },
                { value: 'actions', label: 'Action Items' },
                { value: 'inspections', label: 'Inspections' },
                { value: 'training', label: 'Training' },
                { value: 'icare', label: 'I-CARE Notes' }
              ]} />
              <Select label="Date Range" value={form.filters?.dateRange || 'this_year'} onChange={e => setForm(p => ({ ...p, filters: { ...p.filters, dateRange: e.target.value } }))} options={[
                { value: 'today', label: 'Today' },
                { value: 'this_week', label: 'This Week' },
                { value: 'this_month', label: 'This Month' },
                { value: 'this_quarter', label: 'This Quarter' },
                { value: 'this_year', label: 'This Year' },
                { value: 'last_month', label: 'Last Month' },
                { value: 'last_year', label: 'Last Year' }
              ]} />
            </div>
            <div className="grid grid-cols-2 gap-4">
              <Select label="Widget Size" value={form.display?.size || 'medium'} onChange={e => setForm(p => ({ ...p, display: { ...p.display, size: e.target.value } }))} options={[
                { value: 'small', label: 'Small (1x1)' },
                { value: 'medium', label: 'Medium (2x1)' },
                { value: 'large', label: 'Large (2x2)' },
                { value: 'xlarge', label: 'Extra Large (4x2)' }
              ]} />
              <Input label="Refresh Interval (seconds)" type="number" value={form.refreshInterval || 0} onChange={e => setForm(p => ({ ...p, refreshInterval: parseInt(e.target.value) || 0 }))} placeholder="0 for manual" />
            </div>
            <Checkbox label="Make widget public (visible to all users)" checked={form.isPublic || false} onChange={e => setForm(p => ({ ...p, isPublic: e.target.checked }))} />
          </div>
        </Modal>
      );
    };

    // ========== GENERIC LIST PAGE ==========
    const ListPage = ({ title, subtitle, endpoint, columns, ModalComp, createLabel, icon: PageIcon, emptyDesc }) => {
      const [items, setItems] = useState([]);
      const [loading, setLoading] = useState(true);
      const [modal, setModal] = useState(false);
      const [selected, setSelected] = useState(null);
      const [pagination, setPagination] = useState({ page: 1, pages: 1, total: 0 });
      const [search, setSearch] = useState('');
      const { addToast } = useContext(ToastContext) || {};

      const fetchData = useCallback(async () => {
        setLoading(true);
        try {
          const data = await api.get(endpoint + '?page=' + pagination.page + '&limit=15' + (search ? '&search=' + search : ''));
          const key = Object.keys(data).find(k => Array.isArray(data[k]));
          setItems(data[key] || []);
          if (data.pagination) setPagination(data.pagination);
        } catch (e) { 
          console.error(e);
          if (e.message?.includes('Feature not available')) {
            addToast?.('This feature requires a higher subscription tier', 'error');
          }
        } finally { setLoading(false); }
      }, [endpoint, pagination.page, search]);

      useEffect(() => { fetchData(); }, [fetchData]);

      const handleSave = () => {
        setModal(false);
        setSelected(null);
        fetchData();
        addToast?.('Saved successfully!', 'success');
      };

      const handleDelete = async (id) => {
        if (!confirm('Are you sure you want to delete this item?')) return;
        try {
          await api.del(endpoint + '/' + id);
          fetchData();
          addToast?.('Deleted successfully', 'success');
        } catch (e) {
          addToast?.('Failed to delete: ' + e.message, 'error');
        }
      };

      return (
        <div className="space-y-6 slide-up">
          <div className="flex flex-col lg:flex-row lg:items-center justify-between gap-4">
            <div>
              <h2 className="text-2xl lg:text-3xl font-bold text-slate-800">{title}</h2>
              {subtitle && <p className="text-slate-500 mt-1">{subtitle}</p>}
            </div>
            <div className="flex flex-col sm:flex-row gap-3">
              <div className="relative">
                <div className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400"><Icons.Search /></div>
                <input 
                  type="text" 
                  placeholder="Search..." 
                  value={search}
                  onChange={e => setSearch(e.target.value)}
                  className="pl-10 pr-4 py-2.5 bg-white border-2 border-slate-200 rounded-xl focus:border-primary-500 w-full sm:w-64 transition-colors"
                />
              </div>
              <Button onClick={() => { setSelected(null); setModal(true); }} icon={<Icons.Plus />}>{createLabel || 'Create New'}</Button>
            </div>
          </div>
          
          <Card noPadding icon={PageIcon && <PageIcon />}>
            <Table 
              columns={columns} 
              data={items} 
              loading={loading} 
              onRowClick={r => { setSelected(r); setModal(true); }} 
              emptyMessage={'No ' + title.toLowerCase() + ' found'}
              emptyIcon={PageIcon && <PageIcon />}
            />
            <Pagination page={pagination.page} pages={pagination.pages} total={pagination.total} onChange={p => setPagination(prev => ({ ...prev, page: p }))} />
          </Card>
          
          {ModalComp && (
            <ModalComp 
              isOpen={modal} 
              onClose={() => { setModal(false); setSelected(null); }} 
              item={selected} 
              onSave={handleSave}
              onDelete={selected?._id ? () => handleDelete(selected._id) : undefined}
            />
          )}
        </div>
      );
    };

    // ========== COMPREHENSIVE INCIDENT MODAL ==========
    const IncidentModal = ({ isOpen, onClose, item, onSave, onDelete }) => {
      const [form, setForm] = useState({});
      const [loading, setLoading] = useState(false);
      const [tab, setTab] = useState('basic');
      const [involvedPerson, setInvolvedPerson] = useState(null);
      const [witness, setWitness] = useState(null);
      
      useEffect(() => { 
        if (item) {
          setForm({ 
            ...item, 
            dateOccurred: item.dateOccurred ? new Date(item.dateOccurred).toISOString().split('T')[0] : '',
            location: item.location || {},
            environmentalConditions: item.environmentalConditions || {},
            involvedPersons: item.involvedPersons || [],
            witnesses: item.witnesses || [],
            equipmentInvolved: item.equipmentInvolved || [],
            rootCauseAnalysis: item.rootCauseAnalysis || {},
            investigation: item.investigation || {},
            oshaRecordability: item.oshaRecordability || {},
            costs: item.costs || { direct: {}, indirect: {} },
            drugAlcoholTesting: item.drugAlcoholTesting || {}
          }); 
        } else {
          setForm({ 
            title: '', description: '', type: 'injury', severity: 'minor', status: 'draft', 
            dateOccurred: new Date().toISOString().split('T')[0], 
            location: { site: '', building: '', floor: '', department: '', area: '', specificLocation: '' },
            environmentalConditions: { weather: 'clear', lighting: 'adequate', floorCondition: 'dry', housekeeping: 'good' },
            involvedPersons: [],
            witnesses: [],
            equipmentInvolved: [],
            rootCauseAnalysis: { method: '5_whys', immediateCauses: [], basicCauses: [], rootCauses: [], fiveWhys: {} },
            investigation: { required: true, status: 'not_started' },
            oshaRecordability: { isRecordable: false },
            costs: { direct: {}, indirect: {} },
            drugAlcoholTesting: { testingRequired: false }
          }); 
        }
        setTab('basic');
      }, [item, isOpen]);
      
      const handleSubmit = async () => { 
        if (!form.title || !form.dateOccurred) return;
        setLoading(true); 
        try { 
          item?._id ? await api.put('/incidents/' + item._id, form) : await api.post('/incidents', form); 
          onSave(); 
        } catch (e) { console.error(e); } 
        finally { setLoading(false); } 
      };

      const updateNested = (path, value) => {
        setForm(prev => {
          const keys = path.split('.');
          const newForm = { ...prev };
          let current = newForm;
          for (let i = 0; i < keys.length - 1; i++) {
            current[keys[i]] = { ...current[keys[i]] };
            current = current[keys[i]];
          }
          current[keys[keys.length - 1]] = value;
          return newForm;
        });
      };

      const addInvolvedPerson = () => {
        const newPerson = {
          personType: 'employee', firstName: '', lastName: '', employeeId: '', department: '', jobTitle: '',
          wasInjured: false, injuryDescription: '', natureOfInjury: '', bodyPartsAffected: [],
          treatmentType: 'none', daysAwayFromWork: 0, daysRestrictedDuty: 0,
          returnToWork: { status: 'working' }, workersCompClaim: { filed: false }
        };
        setForm(p => ({ ...p, involvedPersons: [...(p.involvedPersons || []), newPerson] }));
      };

      const updateInvolvedPerson = (index, field, value) => {
        setForm(p => {
          const persons = [...(p.involvedPersons || [])];
          persons[index] = { ...persons[index], [field]: value };
          return { ...p, involvedPersons: persons };
        });
      };

      const removeInvolvedPerson = (index) => {
        setForm(p => ({ ...p, involvedPersons: p.involvedPersons.filter((_, i) => i !== index) }));
      };

      const addWitness = () => {
        setForm(p => ({ ...p, witnesses: [...(p.witnesses || []), { firstName: '', lastName: '', phone: '', email: '', statement: '', statementTaken: false }] }));
      };

      const updateWitness = (index, field, value) => {
        setForm(p => {
          const witnesses = [...(p.witnesses || [])];
          witnesses[index] = { ...witnesses[index], [field]: value };
          return { ...p, witnesses };
        });
      };

      const types = [
        { value: 'injury', label: 'Injury' }, { value: 'illness', label: 'Illness' }, { value: 'near_miss', label: 'Near Miss' }, 
        { value: 'first_aid', label: 'First Aid Only' }, { value: 'property_damage', label: 'Property Damage' }, 
        { value: 'environmental', label: 'Environmental' }, { value: 'security', label: 'Security' }, { value: 'vehicle', label: 'Vehicle' },
        { value: 'fire', label: 'Fire' }, { value: 'chemical_exposure', label: 'Chemical Exposure' }, { value: 'ergonomic', label: 'Ergonomic' },
        { value: 'slip_trip_fall', label: 'Slip/Trip/Fall' }, { value: 'struck_by', label: 'Struck By' }, { value: 'caught_in', label: 'Caught In/Between' },
        { value: 'electrical', label: 'Electrical' }, { value: 'other', label: 'Other' }
      ];
      const severities = [{ value: 'insignificant', label: 'Insignificant' }, { value: 'minor', label: 'Minor' }, { value: 'moderate', label: 'Moderate' }, { value: 'major', label: 'Major' }, { value: 'severe', label: 'Severe' }, { value: 'catastrophic', label: 'Catastrophic' }];
      const statuses = [{ value: 'draft', label: 'Draft' }, { value: 'submitted', label: 'Submitted' }, { value: 'acknowledged', label: 'Acknowledged' }, { value: 'investigating', label: 'Investigating' }, { value: 'pending_review', label: 'Pending Review' }, { value: 'approved', label: 'Approved' }, { value: 'closed', label: 'Closed' }];
      const shifts = [{ value: 'day', label: 'Day Shift' }, { value: 'evening', label: 'Evening Shift' }, { value: 'night', label: 'Night Shift' }, { value: 'rotating', label: 'Rotating' }];
      
      const bodyParts = [
        'Head', 'Face', 'Eye (Left)', 'Eye (Right)', 'Ear (Left)', 'Ear (Right)', 'Neck',
        'Shoulder (Left)', 'Shoulder (Right)', 'Upper Arm (Left)', 'Upper Arm (Right)', 
        'Elbow (Left)', 'Elbow (Right)', 'Lower Arm (Left)', 'Lower Arm (Right)',
        'Wrist (Left)', 'Wrist (Right)', 'Hand (Left)', 'Hand (Right)', 'Finger(s) (Left)', 'Finger(s) (Right)',
        'Chest', 'Abdomen', 'Upper Back', 'Lower Back', 'Hip (Left)', 'Hip (Right)',
        'Upper Leg (Left)', 'Upper Leg (Right)', 'Knee (Left)', 'Knee (Right)',
        'Lower Leg (Left)', 'Lower Leg (Right)', 'Ankle (Left)', 'Ankle (Right)',
        'Foot (Left)', 'Foot (Right)', 'Toe(s) (Left)', 'Toe(s) (Right)', 'Multiple Body Parts', 'Internal Organs'
      ];

      const injuryTypes = [
        { value: 'amputation', label: 'Amputation' }, { value: 'bruise', label: 'Bruise/Contusion' },
        { value: 'burn_chemical', label: 'Burn (Chemical)' }, { value: 'burn_heat', label: 'Burn (Heat)' },
        { value: 'burn_electrical', label: 'Burn (Electrical)' }, { value: 'concussion', label: 'Concussion' },
        { value: 'crushing', label: 'Crushing Injury' }, { value: 'cut_laceration', label: 'Cut/Laceration' },
        { value: 'dislocation', label: 'Dislocation' }, { value: 'fracture', label: 'Fracture' },
        { value: 'hearing_loss', label: 'Hearing Loss' }, { value: 'hernia', label: 'Hernia' },
        { value: 'puncture', label: 'Puncture' }, { value: 'respiratory', label: 'Respiratory Condition' },
        { value: 'skin_disorder', label: 'Skin Disorder' }, { value: 'sprain_strain', label: 'Sprain/Strain' },
        { value: 'vision_loss', label: 'Vision Loss' }, { value: 'other', label: 'Other' }
      ];

      const treatmentTypes = [
        { value: 'none', label: 'No Treatment' }, { value: 'first_aid_onsite', label: 'First Aid (On-site)' },
        { value: 'first_aid_offsite', label: 'First Aid (Off-site)' }, { value: 'medical_treatment', label: 'Medical Treatment' },
        { value: 'emergency_room', label: 'Emergency Room' }, { value: 'hospitalized', label: 'Hospitalized' },
        { value: 'surgery', label: 'Surgery Required' }, { value: 'fatality', label: 'Fatality' }
      ];

      const tabs = [
        { id: 'basic', label: 'Basic Info' },
        { id: 'location', label: 'Location' },
        { id: 'environment', label: 'Environment' },
        { id: 'persons', label: 'Involved Persons' },
        { id: 'witnesses', label: 'Witnesses' },
        { id: 'investigation', label: 'Investigation' },
        { id: 'rootcause', label: 'Root Cause' },
        { id: 'osha', label: 'OSHA' },
        { id: 'costs', label: 'Costs' },
        { id: 'lifecycle', label: 'Lifecycle' },
        { id: 'documents', label: 'Documents' }
      ];

      return (
        <Modal 
          isOpen={isOpen} 
          onClose={onClose} 
          title={item ? 'Edit Incident ' + (item.incidentNumber || '') : 'Report New Incident'} 
          size="xl"
          footer={
            <>
              {item && onDelete && <Button variant="danger" onClick={onDelete} icon={<Icons.Trash />}>Delete</Button>}
              {item && form.status === 'closed' && (
                <Button variant="secondary" onClick={async () => {
                  if (confirm('Archive this incident? It will be moved to the archive and can be restored later.')) {
                    try {
                      await api.post('/incidents/' + item._id + '/archive', { reason: 'Manual archive' });
                      onClose();
                      onSave();
                    } catch (e) { console.error(e); }
                  }
                }} icon={<Icons.Document />}>Archive</Button>
              )}
              <div className="flex-1" />
              <Button variant="secondary" onClick={onClose}>Cancel</Button>
              <Button onClick={handleSubmit} loading={loading}>{item ? 'Update Incident' : 'Create Incident'}</Button>
            </>
          }
        >
          <div className="flex flex-wrap gap-1 mb-6 border-b border-slate-200 pb-3 overflow-x-auto">
            {tabs.map(t => (
              <button key={t.id} onClick={() => setTab(t.id)} 
                className={`px-3 py-2 text-sm font-medium rounded-lg whitespace-nowrap transition-colors ${tab === t.id ? 'bg-primary-100 text-primary-700' : 'text-slate-600 hover:bg-slate-100'}`}>
                {t.label}
              </button>
            ))}
          </div>
          
          <div className="space-y-5 max-h-[60vh] overflow-y-auto pr-2">
            {/* BASIC INFO TAB */}
            {tab === 'basic' && (
              <>
                <Input label="Incident Title *" value={form.title || ''} onChange={e => setForm(p => ({ ...p, title: e.target.value }))} placeholder="Brief description of the incident" />
                <div className="grid grid-cols-1 sm:grid-cols-3 gap-4">
                  <Select label="Type *" value={form.type || 'injury'} onChange={e => setForm(p => ({ ...p, type: e.target.value }))} options={types} />
                  <Select label="Severity" value={form.severity || 'minor'} onChange={e => setForm(p => ({ ...p, severity: e.target.value }))} options={severities} />
                  <Select label="Potential Severity" value={form.potentialSeverity || ''} onChange={e => setForm(p => ({ ...p, potentialSeverity: e.target.value }))} options={[{ value: '', label: 'Select...' }, ...severities]} />
                </div>
                <div className="grid grid-cols-1 sm:grid-cols-4 gap-4">
                  <Input label="Date Occurred *" type="date" value={form.dateOccurred || ''} onChange={e => setForm(p => ({ ...p, dateOccurred: e.target.value }))} />
                  <Input label="Time Occurred" type="time" value={form.timeOccurred || ''} onChange={e => setForm(p => ({ ...p, timeOccurred: e.target.value }))} />
                  <Select label="Shift" value={form.shift || ''} onChange={e => setForm(p => ({ ...p, shift: e.target.value }))} options={[{ value: '', label: 'Select...' }, ...shifts]} />
                  <Input label="Hours Into Shift" type="number" value={form.hoursIntoShift || ''} onChange={e => setForm(p => ({ ...p, hoursIntoShift: parseInt(e.target.value) || '' }))} />
                </div>
                <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                  <Input label="Date Reported" type="date" value={form.dateReported ? new Date(form.dateReported).toISOString().split('T')[0] : ''} onChange={e => setForm(p => ({ ...p, dateReported: e.target.value }))} />
                  <Select label="Status" value={form.status || 'draft'} onChange={e => setForm(p => ({ ...p, status: e.target.value }))} options={statuses} />
                </div>
                <Textarea label="Description" value={form.description || ''} onChange={e => setForm(p => ({ ...p, description: e.target.value }))} rows={4} placeholder="Describe what happened, who was involved, and any immediate actions taken..." />
              </>
            )}

            {/* LOCATION TAB */}
            {tab === 'location' && (
              <>
                <div className="grid grid-cols-1 sm:grid-cols-3 gap-4">
                  <Input label="Site/Facility" value={form.location?.site || ''} onChange={e => updateNested('location.site', e.target.value)} placeholder="Main Plant" />
                  <Input label="Building" value={form.location?.building || ''} onChange={e => updateNested('location.building', e.target.value)} placeholder="Building A" />
                  <Input label="Floor/Level" value={form.location?.floor || ''} onChange={e => updateNested('location.floor', e.target.value)} placeholder="2nd Floor" />
                </div>
                <div className="grid grid-cols-1 sm:grid-cols-3 gap-4">
                  <Input label="Department" value={form.location?.department || ''} onChange={e => updateNested('location.department', e.target.value)} placeholder="Operations" />
                  <Input label="Area" value={form.location?.area || ''} onChange={e => updateNested('location.area', e.target.value)} placeholder="Production Line 3" />
                  <Input label="Specific Location" value={form.location?.specificLocation || ''} onChange={e => updateNested('location.specificLocation', e.target.value)} placeholder="Near conveyor belt" />
                </div>
                <Select label="Indoor/Outdoor" value={form.location?.indoorOutdoor || ''} onChange={e => updateNested('location.indoorOutdoor', e.target.value)} options={[
                  { value: '', label: 'Select...' }, { value: 'indoor', label: 'Indoor' }, { value: 'outdoor', label: 'Outdoor' }, { value: 'both', label: 'Both' }
                ]} />
              </>
            )}

            {/* ENVIRONMENT TAB */}
            {tab === 'environment' && (
              <>
                <div className="grid grid-cols-1 sm:grid-cols-3 gap-4">
                  <Select label="Weather" value={form.environmentalConditions?.weather || 'na'} onChange={e => updateNested('environmentalConditions.weather', e.target.value)} options={[
                    { value: 'na', label: 'N/A' }, { value: 'clear', label: 'Clear' }, { value: 'rain', label: 'Rain' }, { value: 'snow', label: 'Snow' },
                    { value: 'ice', label: 'Ice' }, { value: 'fog', label: 'Fog' }, { value: 'wind', label: 'High Wind' },
                    { value: 'extreme_heat', label: 'Extreme Heat' }, { value: 'extreme_cold', label: 'Extreme Cold' }
                  ]} />
                  <Select label="Lighting" value={form.environmentalConditions?.lighting || 'adequate'} onChange={e => updateNested('environmentalConditions.lighting', e.target.value)} options={[
                    { value: 'adequate', label: 'Adequate' }, { value: 'poor', label: 'Poor' }, { value: 'dark', label: 'Dark' }, { value: 'glare', label: 'Glare' }, { value: 'na', label: 'N/A' }
                  ]} />
                  <Select label="Noise Level" value={form.environmentalConditions?.noise || 'normal'} onChange={e => updateNested('environmentalConditions.noise', e.target.value)} options={[
                    { value: 'normal', label: 'Normal' }, { value: 'loud', label: 'Loud' }, { value: 'very_loud', label: 'Very Loud' }, { value: 'na', label: 'N/A' }
                  ]} />
                </div>
                <div className="grid grid-cols-1 sm:grid-cols-3 gap-4">
                  <Select label="Floor Condition" value={form.environmentalConditions?.floorCondition || 'dry'} onChange={e => updateNested('environmentalConditions.floorCondition', e.target.value)} options={[
                    { value: 'dry', label: 'Dry' }, { value: 'wet', label: 'Wet' }, { value: 'oily', label: 'Oily' }, { value: 'dusty', label: 'Dusty' },
                    { value: 'uneven', label: 'Uneven' }, { value: 'cluttered', label: 'Cluttered' }, { value: 'na', label: 'N/A' }
                  ]} />
                  <Select label="Housekeeping" value={form.environmentalConditions?.housekeeping || 'good'} onChange={e => updateNested('environmentalConditions.housekeeping', e.target.value)} options={[
                    { value: 'good', label: 'Good' }, { value: 'fair', label: 'Fair' }, { value: 'poor', label: 'Poor' }
                  ]} />
                  <Select label="Ventilation" value={form.environmentalConditions?.ventilation || 'adequate'} onChange={e => updateNested('environmentalConditions.ventilation', e.target.value)} options={[
                    { value: 'adequate', label: 'Adequate' }, { value: 'poor', label: 'Poor' }, { value: 'none', label: 'None' }, { value: 'na', label: 'N/A' }
                  ]} />
                </div>
                <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                  <Input label="Temperature" value={form.environmentalConditions?.temperature || ''} onChange={e => updateNested('environmentalConditions.temperature', e.target.value)} placeholder="72¬∞F" />
                  <Input label="Humidity" value={form.environmentalConditions?.humidity || ''} onChange={e => updateNested('environmentalConditions.humidity', e.target.value)} placeholder="45%" />
                </div>
                <Textarea label="Additional Notes" value={form.environmentalConditions?.notes || ''} onChange={e => updateNested('environmentalConditions.notes', e.target.value)} rows={2} />
              </>
            )}

            {/* INVOLVED PERSONS TAB */}
            {tab === 'persons' && (
              <>
                <div className="flex justify-between items-center mb-4">
                  <h4 className="font-semibold text-slate-800">Involved Persons ({form.involvedPersons?.length || 0})</h4>
                  <Button size="sm" onClick={addInvolvedPerson} icon={<Icons.Plus />}>Add Person</Button>
                </div>
                {(form.involvedPersons || []).length === 0 ? (
                  <div className="text-center py-8 bg-slate-50 rounded-xl text-slate-500">
                    No persons added yet. Click "Add Person" to add involved individuals.
                  </div>
                ) : (
                  <div className="space-y-4">
                    {(form.involvedPersons || []).map((person, idx) => (
                      <div key={idx} className="border border-slate-200 rounded-xl p-4 bg-slate-50">
                        <div className="flex justify-between items-start mb-4">
                          <h5 className="font-semibold text-slate-700">Person #{idx + 1}</h5>
                          <button onClick={() => removeInvolvedPerson(idx)} className="text-red-500 hover:text-red-700"><Icons.Trash /></button>
                        </div>
                        <div className="grid grid-cols-1 sm:grid-cols-4 gap-3">
                          <Select label="Type" value={person.personType || 'employee'} onChange={e => updateInvolvedPerson(idx, 'personType', e.target.value)} options={[
                            { value: 'employee', label: 'Employee' }, { value: 'contractor', label: 'Contractor' }, { value: 'visitor', label: 'Visitor' }, { value: 'vendor', label: 'Vendor' }, { value: 'other', label: 'Other' }
                          ]} />
                          <Input label="First Name" value={person.firstName || ''} onChange={e => updateInvolvedPerson(idx, 'firstName', e.target.value)} />
                          <Input label="Last Name" value={person.lastName || ''} onChange={e => updateInvolvedPerson(idx, 'lastName', e.target.value)} />
                          <Input label="Employee ID" value={person.employeeId || ''} onChange={e => updateInvolvedPerson(idx, 'employeeId', e.target.value)} />
                        </div>
                        <div className="grid grid-cols-1 sm:grid-cols-3 gap-3 mt-3">
                          <Input label="Department" value={person.department || ''} onChange={e => updateInvolvedPerson(idx, 'department', e.target.value)} />
                          <Input label="Job Title" value={person.jobTitle || ''} onChange={e => updateInvolvedPerson(idx, 'jobTitle', e.target.value)} />
                          <Input label="Supervisor" value={person.supervisor || ''} onChange={e => updateInvolvedPerson(idx, 'supervisor', e.target.value)} />
                        </div>
                        
                        <div className="mt-4 pt-4 border-t border-slate-200">
                          <Checkbox label="This person was injured/ill" checked={person.wasInjured || false} onChange={e => updateInvolvedPerson(idx, 'wasInjured', e.target.checked)} />
                        </div>
                        
                        {person.wasInjured && (
                          <div className="mt-4 space-y-3 bg-white p-4 rounded-lg border border-slate-200">
                            <h6 className="font-medium text-slate-700">Injury Details</h6>
                            <div className="grid grid-cols-1 sm:grid-cols-2 gap-3">
                              <Select label="Nature of Injury" value={person.natureOfInjury || ''} onChange={e => updateInvolvedPerson(idx, 'natureOfInjury', e.target.value)} options={[{ value: '', label: 'Select...' }, ...injuryTypes]} />
                              <Select label="Treatment Type" value={person.treatmentType || 'none'} onChange={e => updateInvolvedPerson(idx, 'treatmentType', e.target.value)} options={treatmentTypes} />
                            </div>
                            <div className="space-y-2">
                              <label className="block text-sm font-medium text-slate-700">Body Parts Affected</label>
                              <div className="grid grid-cols-2 sm:grid-cols-4 gap-2 max-h-48 overflow-y-auto p-2 border rounded-lg bg-slate-50">
                                {bodyParts.map(part => (
                                  <label key={part} className="flex items-center gap-2 text-sm cursor-pointer">
                                    <input type="checkbox" checked={(person.bodyPartsAffected || []).some(b => b.bodyPart === part.toLowerCase().replace(/[^a-z]/g, '_'))} 
                                      onChange={e => {
                                        const partKey = part.toLowerCase().replace(/[^a-z]/g, '_');
                                        const current = person.bodyPartsAffected || [];
                                        if (e.target.checked) {
                                          updateInvolvedPerson(idx, 'bodyPartsAffected', [...current, { bodyPart: partKey }]);
                                        } else {
                                          updateInvolvedPerson(idx, 'bodyPartsAffected', current.filter(b => b.bodyPart !== partKey));
                                        }
                                      }}
                                      className="rounded text-primary-600"
                                    />
                                    <span className="text-slate-600">{part}</span>
                                  </label>
                                ))}
                              </div>
                            </div>
                            <Textarea label="Injury Description" value={person.injuryDescription || ''} onChange={e => updateInvolvedPerson(idx, 'injuryDescription', e.target.value)} rows={2} />
                            <div className="grid grid-cols-1 sm:grid-cols-2 gap-3">
                              <Input label="Days Away From Work" type="number" value={person.daysAwayFromWork || 0} onChange={e => updateInvolvedPerson(idx, 'daysAwayFromWork', parseInt(e.target.value) || 0)} />
                              <Input label="Days Restricted Duty" type="number" value={person.daysRestrictedDuty || 0} onChange={e => updateInvolvedPerson(idx, 'daysRestrictedDuty', parseInt(e.target.value) || 0)} />
                            </div>
                          </div>
                        )}
                      </div>
                    ))}
                  </div>
                )}
              </>
            )}

            {/* WITNESSES TAB */}
            {tab === 'witnesses' && (
              <>
                <div className="flex justify-between items-center mb-4">
                  <h4 className="font-semibold text-slate-800">Witnesses ({form.witnesses?.length || 0})</h4>
                  <Button size="sm" onClick={addWitness} icon={<Icons.Plus />}>Add Witness</Button>
                </div>
                {(form.witnesses || []).length === 0 ? (
                  <div className="text-center py-8 bg-slate-50 rounded-xl text-slate-500">
                    No witnesses added yet.
                  </div>
                ) : (
                  <div className="space-y-4">
                    {(form.witnesses || []).map((w, idx) => (
                      <div key={idx} className="border border-slate-200 rounded-xl p-4 bg-slate-50">
                        <div className="flex justify-between items-start mb-3">
                          <h5 className="font-semibold text-slate-700">Witness #{idx + 1}</h5>
                          <button onClick={() => setForm(p => ({ ...p, witnesses: p.witnesses.filter((_, i) => i !== idx) }))} className="text-red-500 hover:text-red-700"><Icons.Trash /></button>
                        </div>
                        <div className="grid grid-cols-1 sm:grid-cols-4 gap-3">
                          <Input label="First Name" value={w.firstName || ''} onChange={e => updateWitness(idx, 'firstName', e.target.value)} />
                          <Input label="Last Name" value={w.lastName || ''} onChange={e => updateWitness(idx, 'lastName', e.target.value)} />
                          <Input label="Phone" value={w.phone || ''} onChange={e => updateWitness(idx, 'phone', e.target.value)} />
                          <Input label="Email" value={w.email || ''} onChange={e => updateWitness(idx, 'email', e.target.value)} />
                        </div>
                        <div className="grid grid-cols-1 sm:grid-cols-2 gap-3 mt-3">
                          <Input label="Department" value={w.department || ''} onChange={e => updateWitness(idx, 'department', e.target.value)} />
                          <Input label="Location During Incident" value={w.locationDuringIncident || ''} onChange={e => updateWitness(idx, 'locationDuringIncident', e.target.value)} />
                        </div>
                        <Textarea label="Witness Statement" value={w.statement || ''} onChange={e => updateWitness(idx, 'statement', e.target.value)} rows={3} className="mt-3" />
                        <Checkbox label="Statement taken and signed" checked={w.statementTaken || false} onChange={e => updateWitness(idx, 'statementTaken', e.target.checked)} className="mt-3" />
                      </div>
                    ))}
                  </div>
                )}
              </>
            )}

            {/* INVESTIGATION TAB */}
            {tab === 'investigation' && (
              <>
                <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                  <Checkbox label="Investigation Required" checked={form.investigation?.required !== false} onChange={e => updateNested('investigation.required', e.target.checked)} />
                  <Select label="Investigation Status" value={form.investigation?.status || 'not_started'} onChange={e => updateNested('investigation.status', e.target.value)} options={[
                    { value: 'not_started', label: 'Not Started' }, { value: 'in_progress', label: 'In Progress' }, { value: 'pending_review', label: 'Pending Review' }, { value: 'completed', label: 'Completed' }
                  ]} />
                </div>
                <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                  <Input label="Investigation Start Date" type="date" value={form.investigation?.startDate ? new Date(form.investigation.startDate).toISOString().split('T')[0] : ''} onChange={e => updateNested('investigation.startDate', e.target.value)} />
                  <Input label="Target Completion Date" type="date" value={form.investigation?.targetCompletionDate ? new Date(form.investigation.targetCompletionDate).toISOString().split('T')[0] : ''} onChange={e => updateNested('investigation.targetCompletionDate', e.target.value)} />
                </div>
                <Input label="Methodology" value={form.investigation?.methodology || ''} onChange={e => updateNested('investigation.methodology', e.target.value)} placeholder="e.g., 5 Whys, Fishbone Analysis" />
                <Textarea label="Findings" value={form.investigation?.findings || ''} onChange={e => updateNested('investigation.findings', e.target.value)} rows={3} />
                <Textarea label="Conclusions" value={form.investigation?.conclusions || ''} onChange={e => updateNested('investigation.conclusions', e.target.value)} rows={2} />
                <Textarea label="Recommendations" value={form.investigation?.recommendations || ''} onChange={e => updateNested('investigation.recommendations', e.target.value)} rows={2} />
                <Textarea label="Lessons Learned" value={form.investigation?.lessonsLearned || ''} onChange={e => updateNested('investigation.lessonsLearned', e.target.value)} rows={2} />
              </>
            )}

            {/* ROOT CAUSE TAB */}
            {tab === 'rootcause' && (
              <>
                <Select label="Root Cause Analysis Method" value={form.rootCauseAnalysis?.method || '5_whys'} onChange={e => updateNested('rootCauseAnalysis.method', e.target.value)} options={[
                  { value: '5_whys', label: '5 Whys' }, { value: 'fishbone', label: 'Fishbone (Ishikawa)' }, { value: 'fault_tree', label: 'Fault Tree' }, { value: 'taproot', label: 'TapRoot' }, { value: 'apollo', label: 'Apollo' }, { value: 'other', label: 'Other' }
                ]} />
                
                {form.rootCauseAnalysis?.method === '5_whys' && (
                  <div className="space-y-4 p-4 bg-slate-50 rounded-xl">
                    <h5 className="font-semibold text-slate-700">5 Whys Analysis</h5>
                    {[1, 2, 3, 4, 5].map(n => (
                      <div key={n} className="grid grid-cols-1 gap-2">
                        <Input label={`Why #${n}`} value={form.rootCauseAnalysis?.fiveWhys?.[`why${n}`]?.answer || ''} onChange={e => {
                          const fiveWhys = { ...form.rootCauseAnalysis?.fiveWhys };
                          fiveWhys[`why${n}`] = { ...fiveWhys[`why${n}`], answer: e.target.value };
                          updateNested('rootCauseAnalysis.fiveWhys', fiveWhys);
                        }} placeholder={`Answer to why #${n}...`} />
                      </div>
                    ))}
                    <Input label="Root Cause Identified" value={form.rootCauseAnalysis?.fiveWhys?.rootCauseIdentified || ''} onChange={e => {
                      const fiveWhys = { ...form.rootCauseAnalysis?.fiveWhys, rootCauseIdentified: e.target.value };
                      updateNested('rootCauseAnalysis.fiveWhys', fiveWhys);
                    }} placeholder="Final root cause determined..." />
                  </div>
                )}

                <Textarea label="Summary" value={form.rootCauseAnalysis?.summary || ''} onChange={e => updateNested('rootCauseAnalysis.summary', e.target.value)} rows={3} placeholder="Summary of root cause analysis..." />
                <Textarea label="Prevention Strategy" value={form.rootCauseAnalysis?.preventionStrategy || ''} onChange={e => updateNested('rootCauseAnalysis.preventionStrategy', e.target.value)} rows={3} placeholder="How to prevent recurrence..." />
              </>
            )}

            {/* OSHA TAB */}
            {tab === 'osha' && (
              <>
                <div className="p-4 bg-blue-50 rounded-xl border border-blue-200 mb-4">
                  <Checkbox label="This is an OSHA Recordable Incident" checked={form.oshaRecordability?.isRecordable || false} onChange={e => updateNested('oshaRecordability.isRecordable', e.target.checked)} />
                </div>
                
                {form.oshaRecordability?.isRecordable && (
                  <>
                    <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                      <Select label="OSHA Classification" value={form.oshaRecordability?.classification || ''} onChange={e => updateNested('oshaRecordability.classification', e.target.value)} options={[
                        { value: '', label: 'Select Classification' },
                        { value: 'fatality', label: 'Fatality' },
                        { value: 'days_away_from_work', label: 'Days Away From Work' },
                        { value: 'job_transfer_restriction', label: 'Job Transfer/Restriction' },
                        { value: 'other_recordable', label: 'Other Recordable Case' },
                        { value: 'first_aid_only', label: 'First Aid Only' }
                      ]} />
                      <Input label="Case Number" value={form.oshaRecordability?.caseNumber || ''} onChange={e => updateNested('oshaRecordability.caseNumber', e.target.value)} placeholder="OSHA 300 Case #" />
                    </div>
                    <div className="grid grid-cols-1 sm:grid-cols-3 gap-4">
                      <Input label="Date of Injury" type="date" value={form.oshaRecordability?.dateOfInjury ? new Date(form.oshaRecordability.dateOfInjury).toISOString().split('T')[0] : ''} onChange={e => updateNested('oshaRecordability.dateOfInjury', e.target.value)} />
                      <Input label="Date Employer Notified" type="date" value={form.oshaRecordability?.dateEmployerNotified ? new Date(form.oshaRecordability.dateEmployerNotified).toISOString().split('T')[0] : ''} onChange={e => updateNested('oshaRecordability.dateEmployerNotified', e.target.value)} />
                      <Input label="Date Began Work" type="date" value={form.oshaRecordability?.dateBeganWork ? new Date(form.oshaRecordability.dateBeganWork).toISOString().split('T')[0] : ''} onChange={e => updateNested('oshaRecordability.dateBeganWork', e.target.value)} />
                    </div>
                    <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                      <div>
                        <label className="block text-sm font-medium text-slate-700 mb-1">Days Away From Work</label>
                        <div className="flex gap-2 items-center">
                          <Input type="number" value={form.oshaRecordability?.daysAwayFromWork?.count || 0} onChange={e => updateNested('oshaRecordability.daysAwayFromWork', { ...form.oshaRecordability?.daysAwayFromWork, count: parseInt(e.target.value) || 0 })} className="w-24" />
                          <Checkbox label="Ongoing" checked={form.oshaRecordability?.daysAwayFromWork?.ongoing || false} onChange={e => updateNested('oshaRecordability.daysAwayFromWork', { ...form.oshaRecordability?.daysAwayFromWork, ongoing: e.target.checked })} />
                        </div>
                      </div>
                      <div>
                        <label className="block text-sm font-medium text-slate-700 mb-1">Days Job Transfer/Restriction</label>
                        <div className="flex gap-2 items-center">
                          <Input type="number" value={form.oshaRecordability?.daysJobTransferRestriction?.count || 0} onChange={e => updateNested('oshaRecordability.daysJobTransferRestriction', { ...form.oshaRecordability?.daysJobTransferRestriction, count: parseInt(e.target.value) || 0 })} className="w-24" />
                          <Checkbox label="Ongoing" checked={form.oshaRecordability?.daysJobTransferRestriction?.ongoing || false} onChange={e => updateNested('oshaRecordability.daysJobTransferRestriction', { ...form.oshaRecordability?.daysJobTransferRestriction, ongoing: e.target.checked })} />
                        </div>
                      </div>
                    </div>
                    <Select label="Injury/Illness Type" value={form.oshaRecordability?.injuryType || ''} onChange={e => updateNested('oshaRecordability.injuryType', e.target.value)} options={[
                      { value: '', label: 'Select Type' },
                      { value: 'injury', label: 'Injury' },
                      { value: 'skin_disorder', label: 'Skin Disorder' },
                      { value: 'respiratory_condition', label: 'Respiratory Condition' },
                      { value: 'poisoning', label: 'Poisoning' },
                      { value: 'hearing_loss', label: 'Hearing Loss' },
                      { value: 'other_illness', label: 'All Other Illnesses' }
                    ]} />
                    <Checkbox label="Privacy Case (do not record name)" checked={form.oshaRecordability?.privacyCase || false} onChange={e => updateNested('oshaRecordability.privacyCase', e.target.checked)} />
                  </>
                )}
              </>
            )}

            {/* COSTS TAB */}
            {tab === 'costs' && (
              <>
                <h5 className="font-semibold text-slate-700 mb-3">Direct Costs</h5>
                <div className="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-6">
                  <Input label="Medical Costs" type="number" value={form.costs?.direct?.medical?.amount || ''} onChange={e => updateNested('costs.direct.medical', { amount: parseFloat(e.target.value) || 0 })} placeholder="$0.00" />
                  <Input label="Workers Comp" type="number" value={form.costs?.direct?.workersComp?.amount || ''} onChange={e => updateNested('costs.direct.workersComp', { amount: parseFloat(e.target.value) || 0 })} placeholder="$0.00" />
                  <Input label="Property Damage" type="number" value={form.costs?.direct?.propertyDamage?.amount || ''} onChange={e => updateNested('costs.direct.propertyDamage', { amount: parseFloat(e.target.value) || 0 })} placeholder="$0.00" />
                  <Input label="Equipment Damage" type="number" value={form.costs?.direct?.equipmentDamage?.amount || ''} onChange={e => updateNested('costs.direct.equipmentDamage', { amount: parseFloat(e.target.value) || 0 })} placeholder="$0.00" />
                  <Input label="Legal Costs" type="number" value={form.costs?.direct?.legal?.amount || ''} onChange={e => updateNested('costs.direct.legal', { amount: parseFloat(e.target.value) || 0 })} placeholder="$0.00" />
                  <Input label="Fines/Penalties" type="number" value={form.costs?.direct?.fines?.amount || ''} onChange={e => updateNested('costs.direct.fines', { amount: parseFloat(e.target.value) || 0 })} placeholder="$0.00" />
                </div>
                
                <h5 className="font-semibold text-slate-700 mb-3">Indirect Costs</h5>
                <div className="grid grid-cols-1 sm:grid-cols-3 gap-4">
                  <Input label="Lost Productivity" type="number" value={form.costs?.indirect?.lostProductivity?.amount || ''} onChange={e => updateNested('costs.indirect.lostProductivity', { amount: parseFloat(e.target.value) || 0 })} placeholder="$0.00" />
                  <Input label="Overtime" type="number" value={form.costs?.indirect?.overtime?.amount || ''} onChange={e => updateNested('costs.indirect.overtime', { amount: parseFloat(e.target.value) || 0 })} placeholder="$0.00" />
                  <Input label="Temporary Workers" type="number" value={form.costs?.indirect?.temporaryWorkers?.amount || ''} onChange={e => updateNested('costs.indirect.temporaryWorkers', { amount: parseFloat(e.target.value) || 0 })} placeholder="$0.00" />
                  <Input label="Training/Replacement" type="number" value={form.costs?.indirect?.trainingReplacement?.amount || ''} onChange={e => updateNested('costs.indirect.trainingReplacement', { amount: parseFloat(e.target.value) || 0 })} placeholder="$0.00" />
                  <Input label="Investigation Time" type="number" value={form.costs?.indirect?.investigationTime?.amount || ''} onChange={e => updateNested('costs.indirect.investigationTime', { amount: parseFloat(e.target.value) || 0 })} placeholder="$0.00" />
                  <Input label="Administrative Time" type="number" value={form.costs?.indirect?.administrativeTime?.amount || ''} onChange={e => updateNested('costs.indirect.administrativeTime', { amount: parseFloat(e.target.value) || 0 })} placeholder="$0.00" />
                </div>

                <div className="mt-6 p-4 bg-slate-100 rounded-xl">
                  <div className="flex justify-between text-lg font-semibold">
                    <span>Estimated Total Cost:</span>
                    <span className="text-primary-600">${(
                      (form.costs?.direct?.medical?.amount || 0) +
                      (form.costs?.direct?.workersComp?.amount || 0) +
                      (form.costs?.direct?.propertyDamage?.amount || 0) +
                      (form.costs?.direct?.equipmentDamage?.amount || 0) +
                      (form.costs?.direct?.legal?.amount || 0) +
                      (form.costs?.direct?.fines?.amount || 0) +
                      (form.costs?.indirect?.lostProductivity?.amount || 0) +
                      (form.costs?.indirect?.overtime?.amount || 0) +
                      (form.costs?.indirect?.temporaryWorkers?.amount || 0) +
                      (form.costs?.indirect?.trainingReplacement?.amount || 0) +
                      (form.costs?.indirect?.investigationTime?.amount || 0) +
                      (form.costs?.indirect?.administrativeTime?.amount || 0)
                    ).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</span>
                  </div>
                </div>
              </>
            )}

            {/* LIFECYCLE TAB */}
            {tab === 'lifecycle' && (
              <>
                {/* Current Status */}
                <div className="p-4 bg-slate-50 rounded-xl">
                  <h4 className="font-semibold text-slate-800 mb-4">Current Status</h4>
                  <div className="flex items-center gap-4 mb-6">
                    <div className={`px-4 py-2 rounded-xl font-bold text-lg ${
                      form.status === 'closed' || form.status === 'approved' ? 'bg-green-100 text-green-700' :
                      form.status === 'investigating' ? 'bg-blue-100 text-blue-700' :
                      form.status === 'pending_review' || form.status === 'pending_approval' ? 'bg-yellow-100 text-yellow-700' :
                      'bg-gray-100 text-gray-700'
                    }`}>
                      {(form.status || 'draft').replace(/_/g, ' ').toUpperCase()}
                    </div>
                    {form.status !== 'closed' && form.status !== 'archived' && (
                      <span className="text-sm text-slate-500">Use the actions below to progress the incident through the workflow</span>
                    )}
                  </div>
                  
                  {/* Lifecycle Progress */}
                  <div className="mb-6">
                    <div className="flex items-center justify-between">
                      {['draft', 'submitted', 'investigating', 'pending_review', 'approved', 'closed'].map((s, i, arr) => {
                        const statusIndex = arr.indexOf(form.status || 'draft');
                        const isCompleted = i < statusIndex;
                        const isCurrent = i === statusIndex;
                        return (
                          <React.Fragment key={s}>
                            <div className={`flex flex-col items-center ${i === 0 ? 'flex-shrink-0' : ''}`}>
                              <div className={`w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold ${
                                isCompleted ? 'bg-green-500 text-white' : isCurrent ? 'bg-primary-500 text-white' : 'bg-slate-200 text-slate-500'
                              }`}>
                                {isCompleted ? '‚úì' : i + 1}
                              </div>
                              <span className={`text-xs mt-1 text-center ${isCurrent ? 'text-primary-600 font-semibold' : 'text-slate-500'}`}>
                                {s.replace(/_/g, ' ')}
                              </span>
                            </div>
                            {i < arr.length - 1 && (
                              <div className={`flex-1 h-1 mx-2 rounded ${isCompleted ? 'bg-green-500' : 'bg-slate-200'}`} />
                            )}
                          </React.Fragment>
                        );
                      })}
                    </div>
                  </div>

                  {/* Lifecycle Actions */}
                  {item?._id && (
                    <div className="space-y-3">
                      <h5 className="font-medium text-slate-700">Available Actions</h5>
                      <div className="flex flex-wrap gap-2">
                        {form.status === 'draft' && (
                          <Button size="sm" onClick={async () => {
                            try {
                              await api.post('/incidents/' + item._id + '/transition', { action: 'submit' });
                              setForm(p => ({ ...p, status: 'submitted' }));
                            } catch (e) { console.error(e); }
                          }}>Submit for Review</Button>
                        )}
                        {form.status === 'submitted' && (
                          <>
                            <Button size="sm" onClick={async () => {
                              try {
                                await api.post('/incidents/' + item._id + '/transition', { action: 'acknowledge' });
                                setForm(p => ({ ...p, status: 'acknowledged' }));
                              } catch (e) { console.error(e); }
                            }}>Acknowledge</Button>
                            <Button size="sm" variant="secondary" onClick={async () => {
                              try {
                                await api.post('/incidents/' + item._id + '/transition', { action: 'return', returnReason: 'Needs more info' });
                                setForm(p => ({ ...p, status: 'draft' }));
                              } catch (e) { console.error(e); }
                            }}>Return to Draft</Button>
                          </>
                        )}
                        {(form.status === 'acknowledged' || form.status === 'submitted') && (
                          <Button size="sm" onClick={async () => {
                            try {
                              await api.post('/incidents/' + item._id + '/transition', { action: 'start_investigation' });
                              setForm(p => ({ ...p, status: 'investigating' }));
                            } catch (e) { console.error(e); }
                          }}>Start Investigation</Button>
                        )}
                        {form.status === 'investigating' && (
                          <Button size="sm" onClick={async () => {
                            try {
                              await api.post('/incidents/' + item._id + '/transition', { action: 'complete_investigation' });
                              setForm(p => ({ ...p, status: 'pending_review' }));
                            } catch (e) { console.error(e); }
                          }}>Complete Investigation</Button>
                        )}
                        {form.status === 'pending_review' && (
                          <>
                            <Button size="sm" onClick={async () => {
                              try {
                                await api.post('/incidents/' + item._id + '/transition', { action: 'approve_review' });
                                setForm(p => ({ ...p, status: 'pending_approval' }));
                              } catch (e) { console.error(e); }
                            }}>Approve Review</Button>
                            <Button size="sm" variant="secondary" onClick={async () => {
                              try {
                                await api.post('/incidents/' + item._id + '/transition', { action: 'reject' });
                                setForm(p => ({ ...p, status: 'investigating' }));
                              } catch (e) { console.error(e); }
                            }}>Return for More Investigation</Button>
                          </>
                        )}
                        {form.status === 'pending_approval' && (
                          <>
                            <Button size="sm" onClick={async () => {
                              try {
                                await api.post('/incidents/' + item._id + '/transition', { action: 'approve' });
                                setForm(p => ({ ...p, status: 'approved' }));
                              } catch (e) { console.error(e); }
                            }}>Final Approval</Button>
                            <Button size="sm" variant="secondary" onClick={async () => {
                              try {
                                await api.post('/incidents/' + item._id + '/transition', { action: 'reject' });
                                setForm(p => ({ ...p, status: 'pending_review' }));
                              } catch (e) { console.error(e); }
                            }}>Reject</Button>
                          </>
                        )}
                        {form.status === 'approved' && (
                          <Button size="sm" onClick={async () => {
                            try {
                              await api.post('/incidents/' + item._id + '/transition', { action: 'complete' });
                              setForm(p => ({ ...p, status: 'closed' }));
                            } catch (e) { console.error(e); }
                          }}>Close Incident</Button>
                        )}
                        {form.status === 'closed' && (
                          <Button size="sm" variant="secondary" onClick={async () => {
                            try {
                              await api.post('/incidents/' + item._id + '/transition', { action: 'reopen' });
                              setForm(p => ({ ...p, status: 'reopened' }));
                            } catch (e) { console.error(e); }
                          }}>Reopen</Button>
                        )}
                      </div>
                    </div>
                  )}
                </div>

                {/* Lifecycle History */}
                <div>
                  <h4 className="font-semibold text-slate-800 mb-3">Lifecycle History</h4>
                  <div className="border border-slate-200 rounded-xl overflow-hidden">
                    <div className="divide-y divide-slate-100">
                      {/* This would be populated from API - showing demo data */}
                      <div className="p-3 flex items-center gap-4 bg-slate-50">
                        <div className="w-10 h-10 bg-green-100 text-green-600 rounded-full flex items-center justify-center">‚úì</div>
                        <div className="flex-1">
                          <p className="font-medium text-slate-800">Incident Created</p>
                          <p className="text-sm text-slate-500">by {item?.reportedBy?.firstName || 'User'} ‚Ä¢ {new Date(item?.createdAt || Date.now()).toLocaleString()}</p>
                        </div>
                        <Badge color="gray">draft</Badge>
                      </div>
                      {form.status !== 'draft' && (
                        <div className="p-3 flex items-center gap-4">
                          <div className="w-10 h-10 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center">üì§</div>
                          <div className="flex-1">
                            <p className="font-medium text-slate-800">Submitted for Review</p>
                            <p className="text-sm text-slate-500">Status changed to submitted</p>
                          </div>
                          <Badge color="blue">submitted</Badge>
                        </div>
                      )}
                    </div>
                  </div>
                </div>
              </>
            )}

            {/* DOCUMENTS TAB */}
            {tab === 'documents' && (
              <>
                {/* Upload Section */}
                <div className="p-4 bg-slate-50 rounded-xl border-2 border-dashed border-slate-300">
                  <div className="text-center">
                    <Icons.Upload />
                    <h4 className="font-semibold text-slate-800 mt-2">Upload Documents</h4>
                    <p className="text-sm text-slate-500 mb-4">Upload incident photos, medical records, witness statements, and other documentation</p>
                    <div className="flex justify-center gap-3">
                      <Button variant="secondary" size="sm" onClick={() => {
                        const input = document.createElement('input');
                        input.type = 'file';
                        input.accept = 'image/*,.pdf,.doc,.docx';
                        input.multiple = true;
                        input.onchange = async (e) => {
                          const files = e.target.files;
                          for (const file of files) {
                            const formData = new FormData();
                            formData.append('file', file);
                            formData.append('entityType', 'incident');
                            formData.append('entityId', item?._id || 'pending');
                            formData.append('documentType', 'incident_report');
                            try {
                              await fetch(API + '/documents/upload', {
                                method: 'POST',
                                headers: { 'Authorization': 'Bearer ' + localStorage.getItem('token') },
                                body: formData
                              });
                            } catch (e) { console.error(e); }
                          }
                          alert('Documents uploaded successfully');
                        };
                        input.click();
                      }}>Upload Files</Button>
                    </div>
                  </div>
                </div>

                {/* Document Type Quick Upload */}
                <div className="grid grid-cols-2 sm:grid-cols-4 gap-3">
                  {[
                    { type: 'photo', label: 'Photos', icon: 'üì∑' },
                    { type: 'witness_statement', label: 'Witness Statement', icon: 'üìù' },
                    { type: 'medical_record', label: 'Medical Records', icon: 'üè•' },
                    { type: 'investigation_report', label: 'Investigation', icon: 'üîç' },
                    { type: 'first_report_injury', label: 'First Report of Injury', icon: 'üìã' },
                    { type: 'lti_documentation', label: 'LTI Documentation', icon: '‚è±Ô∏è' },
                    { type: 'ri_documentation', label: 'RI Documentation', icon: 'ü©π' },
                    { type: 'return_to_work', label: 'Return to Work', icon: '‚úÖ' }
                  ].map(docType => (
                    <div key={docType.type} className="p-3 bg-white rounded-xl border border-slate-200 hover:border-primary-300 hover:shadow-sm cursor-pointer transition-all text-center"
                      onClick={() => {
                        const input = document.createElement('input');
                        input.type = 'file';
                        input.accept = docType.type === 'photo' ? 'image/*' : '.pdf,.doc,.docx,.jpg,.jpeg,.png';
                        input.onchange = async (e) => {
                          const file = e.target.files[0];
                          if (!file) return;
                          const formData = new FormData();
                          formData.append('file', file);
                          formData.append('entityType', 'incident');
                          formData.append('entityId', item?._id || 'pending');
                          formData.append('documentType', docType.type);
                          try {
                            await fetch(API + '/documents/upload', {
                              method: 'POST',
                              headers: { 'Authorization': 'Bearer ' + localStorage.getItem('token') },
                              body: formData
                            });
                            alert('Document uploaded');
                          } catch (e) { console.error(e); }
                        };
                        input.click();
                      }}>
                      <span className="text-2xl">{docType.icon}</span>
                      <p className="text-xs text-slate-600 mt-1">{docType.label}</p>
                    </div>
                  ))}
                </div>

                {/* Uploaded Documents List */}
                <div>
                  <h4 className="font-semibold text-slate-800 mb-3">Uploaded Documents</h4>
                  {item?._id ? (
                    <IncidentDocumentsList incidentId={item._id} />
                  ) : (
                    <p className="text-sm text-slate-500 text-center py-8">Save the incident first to upload documents</p>
                  )}
                </div>
              </>
            )}
          </div>
        </Modal>
      );
    };

    // Incident Documents List Component
    const IncidentDocumentsList = ({ incidentId }) => {
      const [documents, setDocuments] = useState([]);
      const [loading, setLoading] = useState(true);

      useEffect(() => {
        fetchDocuments();
      }, [incidentId]);

      const fetchDocuments = async () => {
        try {
          const data = await api.get('/incidents/' + incidentId + '/documents');
          setDocuments(data.documents || []);
        } catch (e) {
          console.error(e);
          setDocuments([]);
        }
        setLoading(false);
      };

      if (loading) return <div className="text-center py-4"><Spinner /></div>;

      if (documents.length === 0) {
        return <p className="text-sm text-slate-500 text-center py-8">No documents uploaded yet</p>;
      }

      const typeLabels = {
        incident_report: 'Incident Report', photo: 'Photo', witness_statement: 'Witness Statement',
        medical_record: 'Medical Record', investigation_report: 'Investigation', first_report_injury: 'First Report',
        lti_documentation: 'LTI Docs', ri_documentation: 'RI Docs', return_to_work: 'Return to Work', other: 'Other'
      };

      return (
        <div className="space-y-2">
          {documents.map(doc => (
            <div key={doc._id} className="flex items-center justify-between p-3 bg-white rounded-xl border border-slate-200 hover:shadow-sm">
              <div className="flex items-center gap-3">
                <div className="w-10 h-10 bg-slate-100 rounded-lg flex items-center justify-center">
                  {doc.mimeType?.startsWith('image/') ? 'üñºÔ∏è' : 'üìÑ'}
                </div>
                <div>
                  <p className="font-medium text-slate-800 text-sm">{doc.originalName}</p>
                  <p className="text-xs text-slate-500">
                    {typeLabels[doc.documentType] || doc.documentType} ‚Ä¢ {(doc.size / 1024).toFixed(1)} KB ‚Ä¢ {new Date(doc.uploadedAt).toLocaleDateString()}
                  </p>
                </div>
              </div>
              <Button size="sm" variant="secondary" onClick={() => window.open(API + '/documents/' + doc._id + '/download', '_blank')}>
                <Icons.Download />
              </Button>
            </div>
          ))}
        </div>
      );
    };

    // ========== ACTION ITEM MODAL ==========
    const ActionModal = ({ isOpen, onClose, item, onSave, onDelete }) => {
      const [form, setForm] = useState({});
      const [loading, setLoading] = useState(false);
      
      useEffect(() => { 
        if (item) {
          setForm({ ...item, dueDate: item.dueDate ? new Date(item.dueDate).toISOString().split('T')[0] : '' }); 
        } else {
          setForm({ title: '', description: '', type: 'corrective', priority: 'medium', status: 'open', dueDate: '' }); 
        }
      }, [item, isOpen]);

      const handleSubmit = async () => { 
        if (!form.title) return;
        setLoading(true); 
        try { 
          item?._id ? await api.put('/action-items/' + item._id, form) : await api.post('/action-items', form); 
          onSave(); 
        } catch (e) { console.error(e); } 
        finally { setLoading(false); } 
      };

      return (
        <Modal 
          isOpen={isOpen} 
          onClose={onClose} 
          title={item ? 'Edit Action Item' : 'New Action Item'}
          footer={
            <>
              {item && onDelete && <Button variant="danger" onClick={onDelete} icon={<Icons.Trash />}>Delete</Button>}
              <div className="flex-1" />
              <Button variant="secondary" onClick={onClose}>Cancel</Button>
              <Button onClick={handleSubmit} loading={loading}>{item ? 'Update' : 'Create'}</Button>
            </>
          }
        >
          <div className="space-y-5">
            <Input label="Title *" value={form.title || ''} onChange={e => setForm(p => ({ ...p, title: e.target.value }))} placeholder="Action item title" />
            <Textarea label="Description" value={form.description || ''} onChange={e => setForm(p => ({ ...p, description: e.target.value }))} rows={3} placeholder="Detailed description of the action required..." />
            <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
              <Select label="Type" value={form.type || 'corrective'} onChange={e => setForm(p => ({ ...p, type: e.target.value }))} options={[
                { value: 'corrective', label: 'Corrective' }, 
                { value: 'preventive', label: 'Preventive' }, 
                { value: 'improvement', label: 'Improvement' }
              ]} />
              <Select label="Priority" value={form.priority || 'medium'} onChange={e => setForm(p => ({ ...p, priority: e.target.value }))} options={[
                { value: 'low', label: 'Low' }, 
                { value: 'medium', label: 'Medium' }, 
                { value: 'high', label: 'High' }, 
                { value: 'critical', label: 'Critical' }
              ]} />
              <Select label="Status" value={form.status || 'open'} onChange={e => setForm(p => ({ ...p, status: e.target.value }))} options={[
                { value: 'open', label: 'Open' }, 
                { value: 'in_progress', label: 'In Progress' }, 
                { value: 'pending_verification', label: 'Pending Verification' },
                { value: 'completed', label: 'Completed' }
              ]} />
              <Input label="Due Date" type="date" value={form.dueDate || ''} onChange={e => setForm(p => ({ ...p, dueDate: e.target.value }))} />
            </div>
          </div>
        </Modal>
      );
    };

    // ========== RISK ASSESSMENT MODAL ==========
    const RiskModal = ({ isOpen, onClose, item, onSave }) => {
      const [form, setForm] = useState({});
      const [loading, setLoading] = useState(false);
      
      useEffect(() => { 
        setForm(item || { title: '', description: '', type: 'general', status: 'draft', location: '', department: '' }); 
      }, [item, isOpen]);

      const handleSubmit = async () => { 
        setLoading(true); 
        try { 
          item?._id ? await api.put('/risk-assessments/' + item._id, form) : await api.post('/risk-assessments', form); 
          onSave(); 
        } catch (e) { console.error(e); } 
        finally { setLoading(false); } 
      };

      return (
        <Modal isOpen={isOpen} onClose={onClose} title={item ? 'Edit Risk Assessment' : 'New Risk Assessment'} size="lg"
          footer={<><Button variant="secondary" onClick={onClose}>Cancel</Button><Button onClick={handleSubmit} loading={loading}>{item ? 'Update' : 'Create'}</Button></>}
        >
          <div className="space-y-5">
            <Input label="Assessment Title *" value={form.title || ''} onChange={e => setForm(p => ({ ...p, title: e.target.value }))} />
            <Textarea label="Description" value={form.description || ''} onChange={e => setForm(p => ({ ...p, description: e.target.value }))} rows={3} />
            <div className="grid grid-cols-1 sm:grid-cols-3 gap-4">
              <Select label="Type" value={form.type || 'general'} onChange={e => setForm(p => ({ ...p, type: e.target.value }))} options={[
                { value: 'general', label: 'General' }, { value: 'job_task', label: 'Job/Task' }, { value: 'process', label: 'Process' },
                { value: 'equipment', label: 'Equipment' }, { value: 'chemical', label: 'Chemical' }, { value: 'ergonomic', label: 'Ergonomic' }
              ]} />
              <Select label="Status" value={form.status || 'draft'} onChange={e => setForm(p => ({ ...p, status: e.target.value }))} options={[
                { value: 'draft', label: 'Draft' }, { value: 'pending_review', label: 'Pending Review' }, 
                { value: 'approved', label: 'Approved' }, { value: 'active', label: 'Active' }
              ]} />
              <Select label="Risk Level" value={form.overallRiskLevel || ''} onChange={e => setForm(p => ({ ...p, overallRiskLevel: e.target.value }))} options={[
                { value: '', label: 'Select Level' }, { value: 'low', label: 'Low' }, { value: 'medium', label: 'Medium' }, 
                { value: 'high', label: 'High' }, { value: 'critical', label: 'Critical' }
              ]} />
            </div>
            <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
              <Input label="Location" value={form.location || ''} onChange={e => setForm(p => ({ ...p, location: e.target.value }))} />
              <Input label="Department" value={form.department || ''} onChange={e => setForm(p => ({ ...p, department: e.target.value }))} />
            </div>
          </div>
        </Modal>
      );
    };

    // ========== JSA MODAL ==========
    const JSAModal = ({ isOpen, onClose, item, onSave }) => {
      const [form, setForm] = useState({});
      const [loading, setLoading] = useState(false);
      
      useEffect(() => { setForm(item || { title: '', jobDescription: '', department: '', location: '', status: 'draft' }); }, [item, isOpen]);

      const handleSubmit = async () => { 
        setLoading(true); 
        try { item?._id ? await api.put('/jsa/' + item._id, form) : await api.post('/jsa', form); onSave(); } 
        catch (e) { console.error(e); } finally { setLoading(false); } 
      };

      return (
        <Modal isOpen={isOpen} onClose={onClose} title={item ? 'Edit JSA' : 'New Job Safety Analysis'} size="lg"
          footer={<><Button variant="secondary" onClick={onClose}>Cancel</Button><Button onClick={handleSubmit} loading={loading}>{item ? 'Update' : 'Create'}</Button></>}
        >
          <div className="space-y-5">
            <Input label="JSA Title *" value={form.title || ''} onChange={e => setForm(p => ({ ...p, title: e.target.value }))} placeholder="e.g., Forklift Operation" />
            <Textarea label="Job Description" value={form.jobDescription || ''} onChange={e => setForm(p => ({ ...p, jobDescription: e.target.value }))} rows={3} />
            <div className="grid grid-cols-1 sm:grid-cols-3 gap-4">
              <Input label="Department" value={form.department || ''} onChange={e => setForm(p => ({ ...p, department: e.target.value }))} />
              <Input label="Location" value={form.location || ''} onChange={e => setForm(p => ({ ...p, location: e.target.value }))} />
              <Select label="Status" value={form.status || 'draft'} onChange={e => setForm(p => ({ ...p, status: e.target.value }))} options={[
                { value: 'draft', label: 'Draft' }, { value: 'pending_review', label: 'Pending Review' }, 
                { value: 'approved', label: 'Approved' }, { value: 'active', label: 'Active' }
              ]} />
            </div>
          </div>
        </Modal>
      );
    };

    // ========== PERMIT MODAL ==========
    const PermitModal = ({ isOpen, onClose, item, onSave }) => {
      const [form, setForm] = useState({});
      const [loading, setLoading] = useState(false);
      
      useEffect(() => { 
        setForm(item || { 
          title: '', type: 'general', status: 'draft', workDescription: '', 
          startDateTime: '', endDateTime: '', priority: 'routine',
          location: { site: '', area: '', specificLocation: '' }
        }); 
      }, [item, isOpen]);

      const handleSubmit = async () => { 
        setLoading(true); 
        try { item?._id ? await api.put('/permits/' + item._id, form) : await api.post('/permits', form); onSave(); } 
        catch (e) { console.error(e); } finally { setLoading(false); } 
      };

      return (
        <Modal isOpen={isOpen} onClose={onClose} title={item ? 'Edit Permit' : 'New Permit to Work'} size="lg"
          footer={<><Button variant="secondary" onClick={onClose}>Cancel</Button><Button onClick={handleSubmit} loading={loading}>{item ? 'Update' : 'Create'}</Button></>}
        >
          <div className="space-y-5">
            <Input label="Permit Title *" value={form.title || ''} onChange={e => setForm(p => ({ ...p, title: e.target.value }))} />
            <div className="grid grid-cols-1 sm:grid-cols-3 gap-4">
              <Select label="Permit Type" value={form.type || 'general'} onChange={e => setForm(p => ({ ...p, type: e.target.value }))} options={[
                { value: 'general', label: 'General' }, { value: 'hot_work', label: 'Hot Work' }, { value: 'confined_space', label: 'Confined Space' },
                { value: 'electrical', label: 'Electrical' }, { value: 'excavation', label: 'Excavation' }, { value: 'height_work', label: 'Working at Height' },
                { value: 'lockout_tagout', label: 'Lockout/Tagout' }, { value: 'chemical', label: 'Chemical' }
              ]} />
              <Select label="Priority" value={form.priority || 'routine'} onChange={e => setForm(p => ({ ...p, priority: e.target.value }))} options={[
                { value: 'routine', label: 'Routine' }, { value: 'urgent', label: 'Urgent' }, { value: 'emergency', label: 'Emergency' }
              ]} />
              <Select label="Status" value={form.status || 'draft'} onChange={e => setForm(p => ({ ...p, status: e.target.value }))} options={[
                { value: 'draft', label: 'Draft' }, { value: 'pending_approval', label: 'Pending Approval' }, 
                { value: 'approved', label: 'Approved' }, { value: 'active', label: 'Active' }, { value: 'completed', label: 'Completed' }
              ]} />
            </div>
            <Textarea label="Work Description" value={form.workDescription || ''} onChange={e => setForm(p => ({ ...p, workDescription: e.target.value }))} rows={3} />
            <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
              <Input label="Start Date/Time" type="datetime-local" value={form.startDateTime || ''} onChange={e => setForm(p => ({ ...p, startDateTime: e.target.value }))} />
              <Input label="End Date/Time" type="datetime-local" value={form.endDateTime || ''} onChange={e => setForm(p => ({ ...p, endDateTime: e.target.value }))} />
            </div>
          </div>
        </Modal>
      );
    };

    // ========== CONTRACTOR MODAL ==========
    const ContractorModal = ({ isOpen, onClose, item, onSave }) => {
      const [form, setForm] = useState({});
      const [loading, setLoading] = useState(false);
      
      useEffect(() => { 
        setForm(item || { 
          companyName: '', type: 'general', status: 'pending',
          contact: { primaryName: '', primaryEmail: '', primaryPhone: '' }
        }); 
      }, [item, isOpen]);

      const handleSubmit = async () => { 
        setLoading(true); 
        try { item?._id ? await api.put('/contractors/' + item._id, form) : await api.post('/contractors', form); onSave(); } 
        catch (e) { console.error(e); } finally { setLoading(false); } 
      };

      return (
        <Modal isOpen={isOpen} onClose={onClose} title={item ? 'Edit Contractor' : 'Add Contractor'} size="lg"
          footer={<><Button variant="secondary" onClick={onClose}>Cancel</Button><Button onClick={handleSubmit} loading={loading}>{item ? 'Update' : 'Create'}</Button></>}
        >
          <div className="space-y-5">
            <Input label="Company Name *" value={form.companyName || ''} onChange={e => setForm(p => ({ ...p, companyName: e.target.value }))} />
            <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
              <Select label="Type" value={form.type || 'general'} onChange={e => setForm(p => ({ ...p, type: e.target.value }))} options={[
                { value: 'general', label: 'General' }, { value: 'electrical', label: 'Electrical' }, { value: 'mechanical', label: 'Mechanical' },
                { value: 'construction', label: 'Construction' }, { value: 'cleaning', label: 'Cleaning' }, { value: 'security', label: 'Security' }
              ]} />
              <Select label="Status" value={form.status || 'pending'} onChange={e => setForm(p => ({ ...p, status: e.target.value }))} options={[
                { value: 'pending', label: 'Pending' }, { value: 'approved', label: 'Approved' }, 
                { value: 'suspended', label: 'Suspended' }, { value: 'expired', label: 'Expired' }
              ]} />
            </div>
            <div className="grid grid-cols-1 sm:grid-cols-3 gap-4">
              <Input label="Contact Name" value={form.contact?.primaryName || ''} onChange={e => setForm(p => ({ ...p, contact: { ...p.contact, primaryName: e.target.value } }))} />
              <Input label="Contact Email" type="email" value={form.contact?.primaryEmail || ''} onChange={e => setForm(p => ({ ...p, contact: { ...p.contact, primaryEmail: e.target.value } }))} />
              <Input label="Contact Phone" type="tel" value={form.contact?.primaryPhone || ''} onChange={e => setForm(p => ({ ...p, contact: { ...p.contact, primaryPhone: e.target.value } }))} />
            </div>
          </div>
        </Modal>
      );
    };

    // ========== CHEMICAL MODAL ==========
    const ChemicalModal = ({ isOpen, onClose, item, onSave }) => {
      const [form, setForm] = useState({});
      const [loading, setLoading] = useState(false);
      
      useEffect(() => { setForm(item || { productName: '', manufacturer: '', casNumber: '', status: 'active' }); }, [item, isOpen]);

      const handleSubmit = async () => { 
        setLoading(true); 
        try { item?._id ? await api.put('/chemicals/' + item._id, form) : await api.post('/chemicals', form); onSave(); } 
        catch (e) { console.error(e); } finally { setLoading(false); } 
      };

      return (
        <Modal isOpen={isOpen} onClose={onClose} title={item ? 'Edit Chemical' : 'Add Chemical'} size="lg"
          footer={<><Button variant="secondary" onClick={onClose}>Cancel</Button><Button onClick={handleSubmit} loading={loading}>{item ? 'Update' : 'Create'}</Button></>}
        >
          <div className="space-y-5">
            <Input label="Product Name *" value={form.productName || ''} onChange={e => setForm(p => ({ ...p, productName: e.target.value }))} />
            <div className="grid grid-cols-1 sm:grid-cols-3 gap-4">
              <Input label="Manufacturer" value={form.manufacturer || ''} onChange={e => setForm(p => ({ ...p, manufacturer: e.target.value }))} />
              <Input label="CAS Number" value={form.casNumber || ''} onChange={e => setForm(p => ({ ...p, casNumber: e.target.value }))} />
              <Select label="Status" value={form.status || 'active'} onChange={e => setForm(p => ({ ...p, status: e.target.value }))} options={[
                { value: 'active', label: 'Active' }, { value: 'inactive', label: 'Inactive' }, { value: 'discontinued', label: 'Discontinued' }
              ]} />
            </div>
            <Input label="Supplier" value={form.supplier || ''} onChange={e => setForm(p => ({ ...p, supplier: e.target.value }))} />
          </div>
        </Modal>
      );
    };

    // ========== EMERGENCY PLAN MODAL ==========
    const EmergencyModal = ({ isOpen, onClose, item, onSave }) => {
      const [form, setForm] = useState({});
      const [loading, setLoading] = useState(false);
      
      useEffect(() => { setForm(item || { title: '', type: 'general', status: 'draft', location: '', purpose: '' }); }, [item, isOpen]);

      const handleSubmit = async () => { 
        setLoading(true); 
        try { item?._id ? await api.put('/emergency-plans/' + item._id, form) : await api.post('/emergency-plans', form); onSave(); } 
        catch (e) { console.error(e); } finally { setLoading(false); } 
      };

      return (
        <Modal isOpen={isOpen} onClose={onClose} title={item ? 'Edit Emergency Plan' : 'New Emergency Plan'} size="lg"
          footer={<><Button variant="secondary" onClick={onClose}>Cancel</Button><Button onClick={handleSubmit} loading={loading}>{item ? 'Update' : 'Create'}</Button></>}
        >
          <div className="space-y-5">
            <Input label="Plan Title *" value={form.title || ''} onChange={e => setForm(p => ({ ...p, title: e.target.value }))} />
            <div className="grid grid-cols-1 sm:grid-cols-3 gap-4">
              <Select label="Type" value={form.type || 'general'} onChange={e => setForm(p => ({ ...p, type: e.target.value }))} options={[
                { value: 'general', label: 'General' }, { value: 'fire', label: 'Fire' }, { value: 'chemical_spill', label: 'Chemical Spill' },
                { value: 'medical', label: 'Medical' }, { value: 'natural_disaster', label: 'Natural Disaster' }, { value: 'active_shooter', label: 'Active Shooter' },
                { value: 'evacuation', label: 'Evacuation' }, { value: 'pandemic', label: 'Pandemic' }
              ]} />
              <Select label="Status" value={form.status || 'draft'} onChange={e => setForm(p => ({ ...p, status: e.target.value }))} options={[
                { value: 'draft', label: 'Draft' }, { value: 'active', label: 'Active' }, { value: 'under_review', label: 'Under Review' }
              ]} />
              <Input label="Location" value={form.location || ''} onChange={e => setForm(p => ({ ...p, location: e.target.value }))} />
            </div>
            <Textarea label="Purpose" value={form.purpose || ''} onChange={e => setForm(p => ({ ...p, purpose: e.target.value }))} rows={3} />
          </div>
        </Modal>
      );
    };

    // ========== INSPECTION MODAL ==========
    const InspectionModal = ({ isOpen, onClose, item, onSave }) => {
      const [form, setForm] = useState({});
      const [saving, setSaving] = useState(false);

      useEffect(() => {
        setForm(item || { title: '', type: 'safety', location: '', scheduledDate: '', status: 'scheduled', findings: '' });
      }, [item, isOpen]);

      const handleSave = async () => {
        if (!form.title) return;
        setSaving(true);
        try {
          item?._id ? await api.put('/inspections/' + item._id, form) : await api.post('/inspections', form);
          onSave();
          onClose();
        } catch (e) { console.error(e); }
        setSaving(false);
      };

      return (
        <Modal isOpen={isOpen} onClose={onClose} title={item ? 'Edit Inspection' : 'New Inspection'} size="lg"
          footer={<><Button variant="secondary" onClick={onClose}>Cancel</Button><Button onClick={handleSave} loading={saving}>{item ? 'Save Changes' : 'Create Inspection'}</Button></>}>
          <div className="space-y-4">
            <Input label="Title *" value={form.title || ''} onChange={e => setForm(p => ({ ...p, title: e.target.value }))} placeholder="Inspection title" />
            <div className="grid grid-cols-2 gap-4">
              <Select label="Type" value={form.type || 'safety'} onChange={e => setForm(p => ({ ...p, type: e.target.value }))} options={[
                { value: 'safety', label: 'Safety Inspection' }, { value: 'environmental', label: 'Environmental' },
                { value: 'equipment', label: 'Equipment' }, { value: 'facility', label: 'Facility' },
                { value: 'fire', label: 'Fire Safety' }, { value: 'electrical', label: 'Electrical' }
              ]} />
              <Select label="Status" value={form.status || 'scheduled'} onChange={e => setForm(p => ({ ...p, status: e.target.value }))} options={[
                { value: 'scheduled', label: 'Scheduled' }, { value: 'in_progress', label: 'In Progress' },
                { value: 'completed', label: 'Completed' }, { value: 'cancelled', label: 'Cancelled' }
              ]} />
            </div>
            <div className="grid grid-cols-2 gap-4">
              <Input label="Location" value={form.location || ''} onChange={e => setForm(p => ({ ...p, location: e.target.value }))} placeholder="Inspection location" />
              <Input label="Scheduled Date" type="date" value={form.scheduledDate?.split('T')[0] || ''} onChange={e => setForm(p => ({ ...p, scheduledDate: e.target.value }))} />
            </div>
            <Textarea label="Findings / Notes" value={form.findings || ''} onChange={e => setForm(p => ({ ...p, findings: e.target.value }))} rows={4} placeholder="Document any findings or observations..." />
          </div>
        </Modal>
      );
    };

    // ========== TRAINING MODAL ==========
    const TrainingModal = ({ isOpen, onClose, item, onSave }) => {
      const [form, setForm] = useState({});
      const [saving, setSaving] = useState(false);

      useEffect(() => {
        setForm(item || { title: '', type: 'safety', description: '', duration: { hours: 1, minutes: 0 }, isRequired: true, recurrenceMonths: 12 });
      }, [item, isOpen]);

      const handleSave = async () => {
        if (!form.title) return;
        setSaving(true);
        try {
          item?._id ? await api.put('/training/' + item._id, form) : await api.post('/training', form);
          onSave();
          onClose();
        } catch (e) { console.error(e); }
        setSaving(false);
      };

      return (
        <Modal isOpen={isOpen} onClose={onClose} title={item ? 'Edit Training Course' : 'New Training Course'} size="lg"
          footer={<><Button variant="secondary" onClick={onClose}>Cancel</Button><Button onClick={handleSave} loading={saving}>{item ? 'Save Changes' : 'Create Course'}</Button></>}>
          <div className="space-y-4">
            <Input label="Course Title *" value={form.title || ''} onChange={e => setForm(p => ({ ...p, title: e.target.value }))} placeholder="Training course title" />
            <div className="grid grid-cols-2 gap-4">
              <Select label="Type" value={form.type || 'safety'} onChange={e => setForm(p => ({ ...p, type: e.target.value }))} options={[
                { value: 'safety', label: 'Safety' }, { value: 'compliance', label: 'Compliance' },
                { value: 'technical', label: 'Technical' }, { value: 'onboarding', label: 'Onboarding' },
                { value: 'certification', label: 'Certification' }, { value: 'emergency', label: 'Emergency Response' }
              ]} />
              <Input label="Recurrence (months)" type="number" value={form.recurrenceMonths || 12} onChange={e => setForm(p => ({ ...p, recurrenceMonths: parseInt(e.target.value) }))} />
            </div>
            <div className="grid grid-cols-2 gap-4">
              <Input label="Duration (hours)" type="number" value={form.duration?.hours || 1} onChange={e => setForm(p => ({ ...p, duration: { ...p.duration, hours: parseInt(e.target.value) } }))} />
              <Input label="Duration (minutes)" type="number" value={form.duration?.minutes || 0} onChange={e => setForm(p => ({ ...p, duration: { ...p.duration, minutes: parseInt(e.target.value) } }))} />
            </div>
            <Textarea label="Description" value={form.description || ''} onChange={e => setForm(p => ({ ...p, description: e.target.value }))} rows={3} placeholder="Course description and learning objectives..." />
            <label className="flex items-center gap-2 cursor-pointer">
              <input type="checkbox" checked={form.isRequired || false} onChange={e => setForm(p => ({ ...p, isRequired: e.target.checked }))} className="w-4 h-4 rounded border-slate-300" />
              <span className="text-sm text-slate-700">Required training for all employees</span>
            </label>
          </div>
        </Modal>
      );
    };

    // ========== DOCUMENT MODAL ==========
    const DocumentModal = ({ isOpen, onClose, item, onSave }) => {
      const [form, setForm] = useState({});
      const [saving, setSaving] = useState(false);

      useEffect(() => {
        setForm(item || { title: '', category: 'policy', description: '', version: '1.0', status: 'draft' });
      }, [item, isOpen]);

      const handleSave = async () => {
        if (!form.title) return;
        setSaving(true);
        try {
          item?._id ? await api.put('/documents/' + item._id, form) : await api.post('/documents', form);
          onSave();
          onClose();
        } catch (e) { console.error(e); }
        setSaving(false);
      };

      return (
        <Modal isOpen={isOpen} onClose={onClose} title={item ? 'Edit Document' : 'New Document'} size="lg"
          footer={<><Button variant="secondary" onClick={onClose}>Cancel</Button><Button onClick={handleSave} loading={saving}>{item ? 'Save Changes' : 'Create Document'}</Button></>}>
          <div className="space-y-4">
            <Input label="Document Title *" value={form.title || ''} onChange={e => setForm(p => ({ ...p, title: e.target.value }))} placeholder="Document title" />
            <div className="grid grid-cols-2 gap-4">
              <Select label="Category" value={form.category || 'policy'} onChange={e => setForm(p => ({ ...p, category: e.target.value }))} options={[
                { value: 'policy', label: 'Policy' }, { value: 'procedure', label: 'Procedure' },
                { value: 'sds', label: 'Safety Data Sheet' }, { value: 'form', label: 'Form/Template' },
                { value: 'manual', label: 'Manual' }, { value: 'guideline', label: 'Guideline' }
              ]} />
              <Select label="Status" value={form.status || 'draft'} onChange={e => setForm(p => ({ ...p, status: e.target.value }))} options={[
                { value: 'draft', label: 'Draft' }, { value: 'review', label: 'Under Review' },
                { value: 'approved', label: 'Approved' }, { value: 'archived', label: 'Archived' }
              ]} />
            </div>
            <Input label="Version" value={form.version || '1.0'} onChange={e => setForm(p => ({ ...p, version: e.target.value }))} placeholder="1.0" />
            <Textarea label="Description" value={form.description || ''} onChange={e => setForm(p => ({ ...p, description: e.target.value }))} rows={3} placeholder="Document description..." />
          </div>
        </Modal>
      );
    };

    // ========== HEALTH MODAL ==========
    const HealthModal = ({ isOpen, onClose, item, onSave }) => {
      const [form, setForm] = useState({});
      const [saving, setSaving] = useState(false);

      useEffect(() => {
        setForm(item || { employeeName: '', recordType: 'medical_exam', date: '', status: 'scheduled', notes: '' });
      }, [item, isOpen]);

      const handleSave = async () => {
        if (!form.employeeName || !form.recordType) return;
        setSaving(true);
        try {
          item?._id ? await api.put('/occupational-health/' + item._id, form) : await api.post('/occupational-health', form);
          onSave();
          onClose();
        } catch (e) { console.error(e); }
        setSaving(false);
      };

      return (
        <Modal isOpen={isOpen} onClose={onClose} title={item ? 'Edit Health Record' : 'New Health Record'} size="lg"
          footer={<><Button variant="secondary" onClick={onClose}>Cancel</Button><Button onClick={handleSave} loading={saving}>{item ? 'Save Changes' : 'Create Record'}</Button></>}>
          <div className="space-y-4">
            <Input label="Employee Name *" value={form.employeeName || ''} onChange={e => setForm(p => ({ ...p, employeeName: e.target.value }))} placeholder="Employee full name" />
            <div className="grid grid-cols-2 gap-4">
              <Select label="Record Type *" value={form.recordType || 'medical_exam'} onChange={e => setForm(p => ({ ...p, recordType: e.target.value }))} options={[
                { value: 'medical_exam', label: 'Medical Examination' }, { value: 'drug_test', label: 'Drug Test' },
                { value: 'hearing_test', label: 'Hearing Test' }, { value: 'vision_test', label: 'Vision Test' },
                { value: 'respiratory_fit', label: 'Respiratory Fit Test' }, { value: 'vaccination', label: 'Vaccination' },
                { value: 'injury_followup', label: 'Injury Follow-up' }
              ]} />
              <Select label="Status" value={form.status || 'scheduled'} onChange={e => setForm(p => ({ ...p, status: e.target.value }))} options={[
                { value: 'scheduled', label: 'Scheduled' }, { value: 'completed', label: 'Completed' },
                { value: 'pending_results', label: 'Pending Results' }, { value: 'cancelled', label: 'Cancelled' }
              ]} />
            </div>
            <Input label="Date" type="date" value={form.date?.split('T')[0] || ''} onChange={e => setForm(p => ({ ...p, date: e.target.value }))} />
            <Textarea label="Notes" value={form.notes || ''} onChange={e => setForm(p => ({ ...p, notes: e.target.value }))} rows={3} placeholder="Additional notes..." />
          </div>
        </Modal>
      );
    };

    // ========== ERGONOMIC MODAL ==========
    const ErgonomicModal = ({ isOpen, onClose, item, onSave }) => {
      const [form, setForm] = useState({});
      const [saving, setSaving] = useState(false);

      useEffect(() => {
        setForm(item || { employeeName: '', type: 'workstation', location: '', status: 'scheduled', findings: '', recommendations: '' });
      }, [item, isOpen]);

      const handleSave = async () => {
        if (!form.employeeName) return;
        setSaving(true);
        try {
          item?._id ? await api.put('/ergonomic-assessments/' + item._id, form) : await api.post('/ergonomic-assessments', form);
          onSave();
          onClose();
        } catch (e) { console.error(e); }
        setSaving(false);
      };

      return (
        <Modal isOpen={isOpen} onClose={onClose} title={item ? 'Edit Ergonomic Assessment' : 'New Ergonomic Assessment'} size="lg"
          footer={<><Button variant="secondary" onClick={onClose}>Cancel</Button><Button onClick={handleSave} loading={saving}>{item ? 'Save Changes' : 'Create Assessment'}</Button></>}>
          <div className="space-y-4">
            <Input label="Employee Name *" value={form.employeeName || ''} onChange={e => setForm(p => ({ ...p, employeeName: e.target.value }))} placeholder="Employee full name" />
            <div className="grid grid-cols-2 gap-4">
              <Select label="Assessment Type" value={form.type || 'workstation'} onChange={e => setForm(p => ({ ...p, type: e.target.value }))} options={[
                { value: 'workstation', label: 'Workstation' }, { value: 'task', label: 'Task Analysis' },
                { value: 'lifting', label: 'Lifting Analysis' }, { value: 'repetitive_motion', label: 'Repetitive Motion' },
                { value: 'posture', label: 'Posture Assessment' }
              ]} />
              <Select label="Status" value={form.status || 'scheduled'} onChange={e => setForm(p => ({ ...p, status: e.target.value }))} options={[
                { value: 'scheduled', label: 'Scheduled' }, { value: 'in_progress', label: 'In Progress' },
                { value: 'completed', label: 'Completed' }, { value: 'follow_up', label: 'Follow-up Required' }
              ]} />
            </div>
            <Input label="Location / Workstation" value={form.location || ''} onChange={e => setForm(p => ({ ...p, location: e.target.value }))} placeholder="Office, warehouse, etc." />
            <Textarea label="Findings" value={form.findings || ''} onChange={e => setForm(p => ({ ...p, findings: e.target.value }))} rows={3} placeholder="Assessment findings..." />
            <Textarea label="Recommendations" value={form.recommendations || ''} onChange={e => setForm(p => ({ ...p, recommendations: e.target.value }))} rows={3} placeholder="Recommended actions..." />
          </div>
        </Modal>
      );
    };

    // ========== OBSERVATION MODAL ==========
    const ObservationModal = ({ isOpen, onClose, item, onSave }) => {
      const [form, setForm] = useState({});
      const [saving, setSaving] = useState(false);
      useEffect(() => {
        setForm(item || { description: '', type: 'unsafe_condition', location: '', status: 'open', priority: 'medium', immediateAction: '' });
      }, [item, isOpen]);
      const handleSave = async () => {
        if (!form.description) return;
        setSaving(true);
        try { item?._id ? await api.put('/observations/' + item._id, form) : await api.post('/observations', form); onSave(); onClose(); }
        catch (e) { console.error(e); }
        setSaving(false);
      };
      return (
        <Modal isOpen={isOpen} onClose={onClose} title={item ? 'Edit Observation' : 'Report Safety Observation'} size="lg"
          footer={<><Button variant="secondary" onClick={onClose}>Cancel</Button><Button onClick={handleSave} loading={saving}>{item ? 'Save Changes' : 'Submit Observation'}</Button></>}>
          <div className="space-y-4">
            <Textarea label="Description *" value={form.description || ''} onChange={e => setForm(p => ({ ...p, description: e.target.value }))} rows={3} placeholder="Describe what you observed..." />
            <div className="grid grid-cols-2 gap-4">
              <Select label="Type" value={form.type || 'unsafe_condition'} onChange={e => setForm(p => ({ ...p, type: e.target.value }))} options={[
                { value: 'unsafe_condition', label: 'Unsafe Condition' }, { value: 'unsafe_act', label: 'Unsafe Act' },
                { value: 'near_miss', label: 'Near Miss' }, { value: 'positive', label: 'Positive Observation' }, { value: 'hazard', label: 'Hazard' }
              ]} />
              <Select label="Priority" value={form.priority || 'medium'} onChange={e => setForm(p => ({ ...p, priority: e.target.value }))} options={[
                { value: 'low', label: 'Low' }, { value: 'medium', label: 'Medium' }, { value: 'high', label: 'High' }, { value: 'critical', label: 'Critical' }
              ]} />
            </div>
            <Input label="Location" value={form.location || ''} onChange={e => setForm(p => ({ ...p, location: e.target.value }))} placeholder="Where did this occur?" />
            <Textarea label="Immediate Action Taken" value={form.immediateAction || ''} onChange={e => setForm(p => ({ ...p, immediateAction: e.target.value }))} rows={2} placeholder="What actions were taken immediately?" />
            <Select label="Status" value={form.status || 'open'} onChange={e => setForm(p => ({ ...p, status: e.target.value }))} options={[
              { value: 'open', label: 'Open' }, { value: 'in_progress', label: 'In Progress' }, { value: 'closed', label: 'Closed' }
            ]} />
          </div>
        </Modal>
      );
    };

    // ========== MOC MODAL ==========
    const MOCModal = ({ isOpen, onClose, item, onSave }) => {
      const [form, setForm] = useState({});
      const [saving, setSaving] = useState(false);
      useEffect(() => {
        setForm(item || { title: '', changeType: 'process', description: '', justification: '', priority: 'medium', status: 'draft', riskAssessment: '' });
      }, [item, isOpen]);
      const handleSave = async () => {
        if (!form.title) return;
        setSaving(true);
        try { item?._id ? await api.put('/moc/' + item._id, form) : await api.post('/moc', form); onSave(); onClose(); }
        catch (e) { console.error(e); }
        setSaving(false);
      };
      return (
        <Modal isOpen={isOpen} onClose={onClose} title={item ? 'Edit Management of Change' : 'New Management of Change'} size="lg"
          footer={<><Button variant="secondary" onClick={onClose}>Cancel</Button><Button onClick={handleSave} loading={saving}>{item ? 'Save Changes' : 'Create MOC'}</Button></>}>
          <div className="space-y-4">
            <Input label="Title *" value={form.title || ''} onChange={e => setForm(p => ({ ...p, title: e.target.value }))} placeholder="Brief description of change" />
            <div className="grid grid-cols-2 gap-4">
              <Select label="Change Type" value={form.changeType || 'process'} onChange={e => setForm(p => ({ ...p, changeType: e.target.value }))} options={[
                { value: 'process', label: 'Process Change' }, { value: 'equipment', label: 'Equipment Change' },
                { value: 'personnel', label: 'Personnel Change' }, { value: 'procedure', label: 'Procedure Change' },
                { value: 'material', label: 'Material Change' }, { value: 'software', label: 'Software/Technology' }
              ]} />
              <Select label="Priority" value={form.priority || 'medium'} onChange={e => setForm(p => ({ ...p, priority: e.target.value }))} options={[
                { value: 'low', label: 'Low' }, { value: 'medium', label: 'Medium' }, { value: 'high', label: 'High' }, { value: 'critical', label: 'Critical' }
              ]} />
            </div>
            <Textarea label="Description" value={form.description || ''} onChange={e => setForm(p => ({ ...p, description: e.target.value }))} rows={3} placeholder="Detailed description of the proposed change..." />
            <Textarea label="Justification" value={form.justification || ''} onChange={e => setForm(p => ({ ...p, justification: e.target.value }))} rows={2} placeholder="Why is this change needed?" />
            <Textarea label="Risk Assessment" value={form.riskAssessment || ''} onChange={e => setForm(p => ({ ...p, riskAssessment: e.target.value }))} rows={2} placeholder="Potential risks and mitigation measures..." />
            <Select label="Status" value={form.status || 'draft'} onChange={e => setForm(p => ({ ...p, status: e.target.value }))} options={[
              { value: 'draft', label: 'Draft' }, { value: 'pending_review', label: 'Pending Review' }, { value: 'approved', label: 'Approved' },
              { value: 'in_progress', label: 'In Progress' }, { value: 'completed', label: 'Completed' }, { value: 'rejected', label: 'Rejected' }
            ]} />
          </div>
        </Modal>
      );
    };

    // ========== SUPPLIER MODAL ==========
    const SupplierModal = ({ isOpen, onClose, item, onSave }) => {
      const [form, setForm] = useState({});
      const [saving, setSaving] = useState(false);
      useEffect(() => {
        setForm(item || { name: '', category: 'materials', contactName: '', email: '', phone: '', address: '', status: 'pending', rating: 0, certifications: '' });
      }, [item, isOpen]);
      const handleSave = async () => {
        if (!form.name) return;
        setSaving(true);
        try { item?._id ? await api.put('/suppliers/' + item._id, form) : await api.post('/suppliers', form); onSave(); onClose(); }
        catch (e) { console.error(e); }
        setSaving(false);
      };
      return (
        <Modal isOpen={isOpen} onClose={onClose} title={item ? 'Edit Supplier' : 'Add Supplier'} size="lg"
          footer={<><Button variant="secondary" onClick={onClose}>Cancel</Button><Button onClick={handleSave} loading={saving}>{item ? 'Save Changes' : 'Add Supplier'}</Button></>}>
          <div className="space-y-4">
            <Input label="Supplier Name *" value={form.name || ''} onChange={e => setForm(p => ({ ...p, name: e.target.value }))} placeholder="Company name" />
            <div className="grid grid-cols-2 gap-4">
              <Select label="Category" value={form.category || 'materials'} onChange={e => setForm(p => ({ ...p, category: e.target.value }))} options={[
                { value: 'materials', label: 'Materials' }, { value: 'equipment', label: 'Equipment' },
                { value: 'services', label: 'Services' }, { value: 'ppe', label: 'PPE' }, { value: 'chemicals', label: 'Chemicals' }
              ]} />
              <Select label="Status" value={form.status || 'pending'} onChange={e => setForm(p => ({ ...p, status: e.target.value }))} options={[
                { value: 'pending', label: 'Pending Approval' }, { value: 'approved', label: 'Approved' },
                { value: 'probation', label: 'On Probation' }, { value: 'suspended', label: 'Suspended' }
              ]} />
            </div>
            <div className="grid grid-cols-2 gap-4">
              <Input label="Contact Name" value={form.contactName || ''} onChange={e => setForm(p => ({ ...p, contactName: e.target.value }))} placeholder="Primary contact" />
              <Input label="Email" type="email" value={form.email || ''} onChange={e => setForm(p => ({ ...p, email: e.target.value }))} placeholder="contact@supplier.com" />
            </div>
            <div className="grid grid-cols-2 gap-4">
              <Input label="Phone" value={form.phone || ''} onChange={e => setForm(p => ({ ...p, phone: e.target.value }))} placeholder="+1 (555) 000-0000" />
              <Input label="Rating (1-5)" type="number" min="1" max="5" value={form.rating || ''} onChange={e => setForm(p => ({ ...p, rating: parseInt(e.target.value) || 0 }))} />
            </div>
            <Input label="Address" value={form.address || ''} onChange={e => setForm(p => ({ ...p, address: e.target.value }))} placeholder="Full address" />
            <Textarea label="Certifications" value={form.certifications || ''} onChange={e => setForm(p => ({ ...p, certifications: e.target.value }))} rows={2} placeholder="ISO 9001, ISO 14001, etc." />
          </div>
        </Modal>
      );
    };

    // ========== ASSET MODAL ==========
    const AssetModal = ({ isOpen, onClose, item, onSave }) => {
      const [form, setForm] = useState({});
      const [saving, setSaving] = useState(false);
      useEffect(() => {
        setForm(item || { name: '', category: 'equipment', location: '', serialNumber: '', manufacturer: '', purchaseDate: '', lastInspection: '', nextInspection: '', status: 'active' });
      }, [item, isOpen]);
      const handleSave = async () => {
        if (!form.name) return;
        setSaving(true);
        try { item?._id ? await api.put('/assets/' + item._id, form) : await api.post('/assets', form); onSave(); onClose(); }
        catch (e) { console.error(e); }
        setSaving(false);
      };
      return (
        <Modal isOpen={isOpen} onClose={onClose} title={item ? 'Edit Asset' : 'Add Asset'} size="lg"
          footer={<><Button variant="secondary" onClick={onClose}>Cancel</Button><Button onClick={handleSave} loading={saving}>{item ? 'Save Changes' : 'Add Asset'}</Button></>}>
          <div className="space-y-4">
            <Input label="Asset Name *" value={form.name || ''} onChange={e => setForm(p => ({ ...p, name: e.target.value }))} placeholder="Equipment/asset name" />
            <div className="grid grid-cols-2 gap-4">
              <Select label="Category" value={form.category || 'equipment'} onChange={e => setForm(p => ({ ...p, category: e.target.value }))} options={[
                { value: 'equipment', label: 'Equipment' }, { value: 'vehicle', label: 'Vehicle' }, { value: 'tool', label: 'Tool' },
                { value: 'ppe', label: 'PPE' }, { value: 'safety_device', label: 'Safety Device' }, { value: 'instrument', label: 'Instrument' }
              ]} />
              <Select label="Status" value={form.status || 'active'} onChange={e => setForm(p => ({ ...p, status: e.target.value }))} options={[
                { value: 'active', label: 'Active' }, { value: 'maintenance', label: 'Under Maintenance' },
                { value: 'retired', label: 'Retired' }, { value: 'disposed', label: 'Disposed' }
              ]} />
            </div>
            <div className="grid grid-cols-2 gap-4">
              <Input label="Serial Number" value={form.serialNumber || ''} onChange={e => setForm(p => ({ ...p, serialNumber: e.target.value }))} placeholder="S/N or Asset ID" />
              <Input label="Manufacturer" value={form.manufacturer || ''} onChange={e => setForm(p => ({ ...p, manufacturer: e.target.value }))} placeholder="Brand/Manufacturer" />
            </div>
            <Input label="Location" value={form.location || ''} onChange={e => setForm(p => ({ ...p, location: e.target.value }))} placeholder="Current location" />
            <div className="grid grid-cols-3 gap-4">
              <Input label="Purchase Date" type="date" value={form.purchaseDate?.split('T')[0] || ''} onChange={e => setForm(p => ({ ...p, purchaseDate: e.target.value }))} />
              <Input label="Last Inspection" type="date" value={form.lastInspection?.split('T')[0] || ''} onChange={e => setForm(p => ({ ...p, lastInspection: e.target.value }))} />
              <Input label="Next Inspection" type="date" value={form.nextInspection?.split('T')[0] || ''} onChange={e => setForm(p => ({ ...p, nextInspection: e.target.value }))} />
            </div>
          </div>
        </Modal>
      );
    };

    // ========== ENVIRONMENTAL MODAL ==========
    const EnvironmentalModal = ({ isOpen, onClose, item, onSave }) => {
      const [form, setForm] = useState({});
      const [saving, setSaving] = useState(false);
      useEffect(() => {
        setForm(item || { type: 'air', source: '', date: '', value: '', unit: '', permitLimit: '', status: 'compliant', notes: '' });
      }, [item, isOpen]);
      const handleSave = async () => {
        if (!form.source) return;
        setSaving(true);
        try { item?._id ? await api.put('/environmental/' + item._id, form) : await api.post('/environmental', form); onSave(); onClose(); }
        catch (e) { console.error(e); }
        setSaving(false);
      };
      return (
        <Modal isOpen={isOpen} onClose={onClose} title={item ? 'Edit Environmental Record' : 'New Environmental Record'} size="lg"
          footer={<><Button variant="secondary" onClick={onClose}>Cancel</Button><Button onClick={handleSave} loading={saving}>{item ? 'Save Changes' : 'Create Record'}</Button></>}>
          <div className="space-y-4">
            <div className="grid grid-cols-2 gap-4">
              <Select label="Type" value={form.type || 'air'} onChange={e => setForm(p => ({ ...p, type: e.target.value }))} options={[
                { value: 'air', label: 'Air Emissions' }, { value: 'water', label: 'Water Discharge' },
                { value: 'waste', label: 'Waste' }, { value: 'noise', label: 'Noise' }, { value: 'spill', label: 'Spill' }
              ]} />
              <Input label="Date" type="date" value={form.date?.split('T')[0] || ''} onChange={e => setForm(p => ({ ...p, date: e.target.value }))} />
            </div>
            <Input label="Source *" value={form.source || ''} onChange={e => setForm(p => ({ ...p, source: e.target.value }))} placeholder="Emission source or location" />
            <div className="grid grid-cols-3 gap-4">
              <Input label="Value" type="number" value={form.value || ''} onChange={e => setForm(p => ({ ...p, value: e.target.value }))} placeholder="Measured value" />
              <Input label="Unit" value={form.unit || ''} onChange={e => setForm(p => ({ ...p, unit: e.target.value }))} placeholder="ppm, mg/L, kg, etc." />
              <Input label="Permit Limit" value={form.permitLimit || ''} onChange={e => setForm(p => ({ ...p, permitLimit: e.target.value }))} placeholder="Regulatory limit" />
            </div>
            <Select label="Compliance Status" value={form.status || 'compliant'} onChange={e => setForm(p => ({ ...p, status: e.target.value }))} options={[
              { value: 'compliant', label: 'Compliant' }, { value: 'non_compliant', label: 'Non-Compliant' },
              { value: 'exceedance', label: 'Exceedance' }, { value: 'pending', label: 'Pending Review' }
            ]} />
            <Textarea label="Notes" value={form.notes || ''} onChange={e => setForm(p => ({ ...p, notes: e.target.value }))} rows={2} placeholder="Additional notes..." />
          </div>
        </Modal>
      );
    };

    // ========== QUALITY/NCR MODAL ==========
    const QualityModal = ({ isOpen, onClose, item, onSave }) => {
      const [form, setForm] = useState({});
      const [saving, setSaving] = useState(false);
      useEffect(() => {
        setForm(item || { title: '', type: 'product', description: '', severity: 'minor', source: '', affectedProduct: '', status: 'open', rootCause: '', containmentAction: '' });
      }, [item, isOpen]);
      const handleSave = async () => {
        if (!form.title) return;
        setSaving(true);
        try { item?._id ? await api.put('/quality/' + item._id, form) : await api.post('/quality', form); onSave(); onClose(); }
        catch (e) { console.error(e); }
        setSaving(false);
      };
      return (
        <Modal isOpen={isOpen} onClose={onClose} title={item ? 'Edit NCR' : 'New Nonconformance Report'} size="lg"
          footer={<><Button variant="secondary" onClick={onClose}>Cancel</Button><Button onClick={handleSave} loading={saving}>{item ? 'Save Changes' : 'Create NCR'}</Button></>}>
          <div className="space-y-4">
            <Input label="Title *" value={form.title || ''} onChange={e => setForm(p => ({ ...p, title: e.target.value }))} placeholder="Brief description of nonconformance" />
            <div className="grid grid-cols-3 gap-4">
              <Select label="Type" value={form.type || 'product'} onChange={e => setForm(p => ({ ...p, type: e.target.value }))} options={[
                { value: 'product', label: 'Product' }, { value: 'process', label: 'Process' },
                { value: 'service', label: 'Service' }, { value: 'supplier', label: 'Supplier' }, { value: 'documentation', label: 'Documentation' }
              ]} />
              <Select label="Severity" value={form.severity || 'minor'} onChange={e => setForm(p => ({ ...p, severity: e.target.value }))} options={[
                { value: 'minor', label: 'Minor' }, { value: 'major', label: 'Major' }, { value: 'critical', label: 'Critical' }
              ]} />
              <Select label="Status" value={form.status || 'open'} onChange={e => setForm(p => ({ ...p, status: e.target.value }))} options={[
                { value: 'open', label: 'Open' }, { value: 'investigating', label: 'Investigating' },
                { value: 'containment', label: 'Containment' }, { value: 'closed', label: 'Closed' }
              ]} />
            </div>
            <Textarea label="Description" value={form.description || ''} onChange={e => setForm(p => ({ ...p, description: e.target.value }))} rows={3} placeholder="Detailed description of the nonconformance..." />
            <div className="grid grid-cols-2 gap-4">
              <Input label="Source" value={form.source || ''} onChange={e => setForm(p => ({ ...p, source: e.target.value }))} placeholder="How was it discovered?" />
              <Input label="Affected Product/Process" value={form.affectedProduct || ''} onChange={e => setForm(p => ({ ...p, affectedProduct: e.target.value }))} placeholder="What was affected?" />
            </div>
            <Textarea label="Root Cause" value={form.rootCause || ''} onChange={e => setForm(p => ({ ...p, rootCause: e.target.value }))} rows={2} placeholder="Root cause analysis..." />
            <Textarea label="Containment Action" value={form.containmentAction || ''} onChange={e => setForm(p => ({ ...p, containmentAction: e.target.value }))} rows={2} placeholder="Immediate containment actions..." />
          </div>
        </Modal>
      );
    };

    // ========== CAPA MODAL ==========
    const CAPAModal = ({ isOpen, onClose, item, onSave }) => {
      const [form, setForm] = useState({});
      const [saving, setSaving] = useState(false);
      useEffect(() => {
        setForm(item || { title: '', type: 'corrective', source: 'ncr', description: '', rootCause: '', action: '', dueDate: '', status: 'open', effectiveness: '' });
      }, [item, isOpen]);
      const handleSave = async () => {
        if (!form.title) return;
        setSaving(true);
        try { item?._id ? await api.put('/capa/' + item._id, form) : await api.post('/capa', form); onSave(); onClose(); }
        catch (e) { console.error(e); }
        setSaving(false);
      };
      return (
        <Modal isOpen={isOpen} onClose={onClose} title={item ? 'Edit CAPA' : 'New CAPA'} size="lg"
          footer={<><Button variant="secondary" onClick={onClose}>Cancel</Button><Button onClick={handleSave} loading={saving}>{item ? 'Save Changes' : 'Create CAPA'}</Button></>}>
          <div className="space-y-4">
            <Input label="Title *" value={form.title || ''} onChange={e => setForm(p => ({ ...p, title: e.target.value }))} placeholder="CAPA title" />
            <div className="grid grid-cols-3 gap-4">
              <Select label="Type" value={form.type || 'corrective'} onChange={e => setForm(p => ({ ...p, type: e.target.value }))} options={[
                { value: 'corrective', label: 'Corrective Action' }, { value: 'preventive', label: 'Preventive Action' }
              ]} />
              <Select label="Source" value={form.source || 'ncr'} onChange={e => setForm(p => ({ ...p, source: e.target.value }))} options={[
                { value: 'ncr', label: 'NCR' }, { value: 'audit', label: 'Audit' }, { value: 'inspection', label: 'Inspection' },
                { value: 'incident', label: 'Incident' }, { value: 'customer_complaint', label: 'Customer Complaint' }
              ]} />
              <Input label="Due Date" type="date" value={form.dueDate?.split('T')[0] || ''} onChange={e => setForm(p => ({ ...p, dueDate: e.target.value }))} />
            </div>
            <Textarea label="Description" value={form.description || ''} onChange={e => setForm(p => ({ ...p, description: e.target.value }))} rows={2} placeholder="Describe the issue..." />
            <Textarea label="Root Cause Analysis" value={form.rootCause || ''} onChange={e => setForm(p => ({ ...p, rootCause: e.target.value }))} rows={2} placeholder="What caused this issue?" />
            <Textarea label="Corrective/Preventive Action" value={form.action || ''} onChange={e => setForm(p => ({ ...p, action: e.target.value }))} rows={2} placeholder="Actions to be taken..." />
            <div className="grid grid-cols-2 gap-4">
              <Select label="Status" value={form.status || 'open'} onChange={e => setForm(p => ({ ...p, status: e.target.value }))} options={[
                { value: 'open', label: 'Open' }, { value: 'in_progress', label: 'In Progress' },
                { value: 'pending_verification', label: 'Pending Verification' }, { value: 'closed', label: 'Closed' }
              ]} />
              <Select label="Effectiveness" value={form.effectiveness || ''} onChange={e => setForm(p => ({ ...p, effectiveness: e.target.value }))} options={[
                { value: '', label: 'Not Yet Verified' }, { value: 'effective', label: 'Effective' }, { value: 'not_effective', label: 'Not Effective' }
              ]} />
            </div>
          </div>
        </Modal>
      );
    };

    // ========== MEETING MODAL ==========
    const MeetingModal = ({ isOpen, onClose, item, onSave }) => {
      const [form, setForm] = useState({});
      const [saving, setSaving] = useState(false);
      useEffect(() => {
        setForm(item || { title: '', type: 'safety_committee', date: '', location: '', agenda: '', minutes: '', attendees: [], status: 'scheduled' });
      }, [item, isOpen]);
      const handleSave = async () => {
        if (!form.title) return;
        setSaving(true);
        try { item?._id ? await api.put('/meetings/' + item._id, form) : await api.post('/meetings', form); onSave(); onClose(); }
        catch (e) { console.error(e); }
        setSaving(false);
      };
      return (
        <Modal isOpen={isOpen} onClose={onClose} title={item ? 'Edit Meeting' : 'Schedule Meeting'} size="lg"
          footer={<><Button variant="secondary" onClick={onClose}>Cancel</Button><Button onClick={handleSave} loading={saving}>{item ? 'Save Changes' : 'Schedule Meeting'}</Button></>}>
          <div className="space-y-4">
            <Input label="Meeting Title *" value={form.title || ''} onChange={e => setForm(p => ({ ...p, title: e.target.value }))} placeholder="Meeting title" />
            <div className="grid grid-cols-2 gap-4">
              <Select label="Type" value={form.type || 'safety_committee'} onChange={e => setForm(p => ({ ...p, type: e.target.value }))} options={[
                { value: 'safety_committee', label: 'Safety Committee' }, { value: 'toolbox_talk', label: 'Toolbox Talk' },
                { value: 'safety_stand_down', label: 'Safety Stand Down' }, { value: 'training_session', label: 'Training Session' },
                { value: 'incident_review', label: 'Incident Review' }, { value: 'management_review', label: 'Management Review' }
              ]} />
              <Select label="Status" value={form.status || 'scheduled'} onChange={e => setForm(p => ({ ...p, status: e.target.value }))} options={[
                { value: 'scheduled', label: 'Scheduled' }, { value: 'in_progress', label: 'In Progress' },
                { value: 'completed', label: 'Completed' }, { value: 'cancelled', label: 'Cancelled' }
              ]} />
            </div>
            <div className="grid grid-cols-2 gap-4">
              <Input label="Date & Time" type="datetime-local" value={form.date ? form.date.slice(0, 16) : ''} onChange={e => setForm(p => ({ ...p, date: e.target.value }))} />
              <Input label="Location" value={form.location || ''} onChange={e => setForm(p => ({ ...p, location: e.target.value }))} placeholder="Conference Room A" />
            </div>
            <Textarea label="Agenda" value={form.agenda || ''} onChange={e => setForm(p => ({ ...p, agenda: e.target.value }))} rows={3} placeholder="Meeting agenda items..." />
            <Textarea label="Minutes" value={form.minutes || ''} onChange={e => setForm(p => ({ ...p, minutes: e.target.value }))} rows={4} placeholder="Meeting minutes and action items..." />
          </div>
        </Modal>
      );
    };

    // ========== OSHA PAGE ==========
    const OSHAPage = () => {
      const [log, setLog] = useState(null);
      const [year, setYear] = useState(new Date().getFullYear());
      const [loading, setLoading] = useState(true);
      const [syncing, setSyncing] = useState(false);
      const [tab, setTab] = useState('log');
      const [selectedEntry, setSelectedEntry] = useState(null);
      const [entryModal, setEntryModal] = useState(false);
      const { addToast } = useContext(ToastContext) || {};
      
      useEffect(() => { 
        setLoading(true); 
        api.get('/osha-logs/' + year).then(d => setLog(d.log)).catch(console.error).finally(() => setLoading(false)); 
      }, [year]);
      
      const handleSync = async () => { 
        setSyncing(true); 
        try { 
          const d = await api.post('/osha-logs/' + year + '/sync'); 
          setLog(d.log); 
          addToast?.('OSHA log synced with incidents', 'success');
        } 
        catch (e) { console.error(e); addToast?.('Sync failed', 'error'); } 
        finally { setSyncing(false); } 
      };

      const calculateRates = () => {
        if (!log?.employment?.totalHoursWorked || !log?.entries?.length) return null;
        const hours = log.employment.totalHoursWorked;
        const totalRecordable = (log.summary?.totalDeaths || 0) + (log.summary?.totalDaysAwayFromWork || 0) + 
                                (log.summary?.totalDaysTransferRestriction || 0) + (log.summary?.totalOtherRecordable || 0);
        const dart = (log.summary?.totalDaysAwayFromWork || 0) + (log.summary?.totalDaysTransferRestriction || 0);
        
        return {
          trir: ((totalRecordable * 200000) / hours).toFixed(2),
          dart: ((dart * 200000) / hours).toFixed(2),
          ltir: (((log.summary?.totalDaysAwayFromWork || 0) * 200000) / hours).toFixed(2)
        };
      };

      const rates = calculateRates();

      // OSHA Entry Detail/Edit Modal
      const EntryModal = ({ isOpen, onClose, entry }) => {
        const [form, setForm] = useState({});
        const [entryTab, setEntryTab] = useState('basic');
        const [saving, setSaving] = useState(false);

        useEffect(() => {
          if (entry) {
            setForm({
              ...entry,
              dates: {
                ...entry.dates,
                dateOfInjuryIllness: entry.dates?.dateOfInjuryIllness ? new Date(entry.dates.dateOfInjuryIllness).toISOString().split('T')[0] : ''
              }
            });
          }
        }, [entry, isOpen]);

        if (!isOpen) return null;

        return (
          <Modal isOpen={isOpen} onClose={onClose} title={'Case: ' + (entry?.caseNumber || 'New Entry')} size="xl">
            <div className="flex gap-2 mb-6 border-b border-slate-200 pb-3 overflow-x-auto">
              {['basic', 'classification', 'form301', 'returnToWork', 'documents'].map(t => (
                <button key={t} onClick={() => setEntryTab(t)} 
                  className={`px-3 py-2 text-sm font-medium rounded-lg whitespace-nowrap capitalize ${entryTab === t ? 'bg-primary-100 text-primary-700' : 'text-slate-600 hover:bg-slate-100'}`}>
                  {t.replace(/([A-Z])/g, ' $1').trim()}
                </button>
              ))}
            </div>

            <div className="space-y-4 max-h-[60vh] overflow-y-auto">
              {entryTab === 'basic' && (
                <>
                  <div className="grid grid-cols-2 gap-4">
                    <Input label="Case Number" value={form.caseNumber || ''} disabled />
                    <Input label="Date of Injury/Illness" type="date" value={form.dates?.dateOfInjuryIllness || ''} disabled />
                  </div>
                  <div className="grid grid-cols-2 gap-4">
                    <Input label="Employee Name" value={form.employee?.name || ''} disabled />
                    <Input label="Job Title" value={form.employee?.jobTitle || ''} disabled />
                  </div>
                  <Input label="Where Occurred" value={form.whereOccurred || ''} disabled />
                  <Textarea label="Description of Injury/Illness" value={form.describeInjuryIllness || ''} disabled rows={3} />
                  <Input label="Object/Substance that Caused Harm" value={form.whatObjectSubstance || ''} disabled />
                </>
              )}

              {entryTab === 'classification' && (
                <>
                  <div className="p-4 bg-slate-50 rounded-xl">
                    <h4 className="font-semibold text-slate-700 mb-3">Case Classification</h4>
                    <div className="grid grid-cols-2 gap-4">
                      <div className="flex items-center gap-2">
                        <div className={`w-4 h-4 rounded ${form.classification?.death ? 'bg-red-500' : 'bg-slate-200'}`} />
                        <span className="text-slate-700">Death</span>
                      </div>
                      <div className="flex items-center gap-2">
                        <div className={`w-4 h-4 rounded ${form.classification?.daysAwayFromWork ? 'bg-orange-500' : 'bg-slate-200'}`} />
                        <span className="text-slate-700">Days Away from Work</span>
                      </div>
                      <div className="flex items-center gap-2">
                        <div className={`w-4 h-4 rounded ${form.classification?.jobTransferOrRestriction ? 'bg-yellow-500' : 'bg-slate-200'}`} />
                        <span className="text-slate-700">Job Transfer/Restriction</span>
                      </div>
                      <div className="flex items-center gap-2">
                        <div className={`w-4 h-4 rounded ${form.classification?.otherRecordableCase ? 'bg-blue-500' : 'bg-slate-200'}`} />
                        <span className="text-slate-700">Other Recordable Case</span>
                      </div>
                    </div>
                  </div>

                  <div className="grid grid-cols-2 gap-4">
                    <div className="p-4 bg-orange-50 rounded-xl">
                      <p className="text-sm text-orange-600 font-medium">Days Away from Work</p>
                      <p className="text-3xl font-bold text-orange-700">{form.daysCount?.daysAwayFromWork || 0}</p>
                      {form.daysCount?.ongoing && <Badge color="orange" size="sm">Ongoing</Badge>}
                    </div>
                    <div className="p-4 bg-yellow-50 rounded-xl">
                      <p className="text-sm text-yellow-600 font-medium">Days Job Transfer/Restriction</p>
                      <p className="text-3xl font-bold text-yellow-700">{form.daysCount?.daysJobTransferRestriction || 0}</p>
                    </div>
                  </div>

                  <div className="p-4 bg-slate-50 rounded-xl">
                    <h4 className="font-semibold text-slate-700 mb-3">Injury/Illness Type</h4>
                    <div className="grid grid-cols-2 gap-2">
                      {[
                        ['injury', 'Injury'],
                        ['skinDisorder', 'Skin Disorder'],
                        ['respiratoryCondition', 'Respiratory Condition'],
                        ['poisoning', 'Poisoning'],
                        ['hearingLoss', 'Hearing Loss'],
                        ['allOtherIllnesses', 'All Other Illnesses']
                      ].map(([key, label]) => (
                        <div key={key} className="flex items-center gap-2">
                          <div className={`w-4 h-4 rounded ${form.injuryIllnessType?.[key] ? 'bg-primary-500' : 'bg-slate-200'}`} />
                          <span className="text-slate-700">{label}</span>
                        </div>
                      ))}
                    </div>
                  </div>
                </>
              )}

              {entryTab === 'form301' && (
                <>
                  <div className="flex items-center gap-3 p-4 bg-blue-50 rounded-xl border border-blue-200 mb-4">
                    <div className={`w-5 h-5 rounded-full flex items-center justify-center ${form.form301?.completed ? 'bg-green-500 text-white' : 'bg-slate-200'}`}>
                      {form.form301?.completed && <Icons.Check />}
                    </div>
                    <span className="font-medium text-blue-800">Form 301 {form.form301?.completed ? 'Completed' : 'Not Completed'}</span>
                    {form.form301?.completedDate && <span className="text-sm text-blue-600 ml-auto">{new Date(form.form301.completedDate).toLocaleDateString()}</span>}
                  </div>

                  {form.form301?.completed && (
                    <>
                      <div className="p-4 bg-slate-50 rounded-xl">
                        <h4 className="font-semibold text-slate-700 mb-3">Employee Information</h4>
                        <div className="grid grid-cols-2 gap-3 text-sm">
                          <div><span className="text-slate-500">Full Name:</span> <span className="font-medium">{form.form301?.employeeInfo?.fullName || '-'}</span></div>
                          <div><span className="text-slate-500">Date of Birth:</span> <span className="font-medium">{form.form301?.employeeInfo?.dateOfBirth ? new Date(form.form301.employeeInfo.dateOfBirth).toLocaleDateString() : '-'}</span></div>
                          <div><span className="text-slate-500">Date Hired:</span> <span className="font-medium">{form.form301?.employeeInfo?.dateHired ? new Date(form.form301.employeeInfo.dateHired).toLocaleDateString() : '-'}</span></div>
                          <div><span className="text-slate-500">Gender:</span> <span className="font-medium capitalize">{form.form301?.employeeInfo?.gender || '-'}</span></div>
                        </div>
                      </div>

                      <div className="p-4 bg-slate-50 rounded-xl">
                        <h4 className="font-semibold text-slate-700 mb-3">Case Details</h4>
                        <div className="space-y-2 text-sm">
                          <div><span className="text-slate-500">What was employee doing:</span><p className="font-medium">{form.form301?.caseInfo?.whatWasEmployeeDoing || '-'}</p></div>
                          <div><span className="text-slate-500">How did incident occur:</span><p className="font-medium">{form.form301?.caseInfo?.howDidIncidentOccur || '-'}</p></div>
                          <div><span className="text-slate-500">What object/substance caused harm:</span><p className="font-medium">{form.form301?.caseInfo?.whatObjectOrSubstance || '-'}</p></div>
                        </div>
                      </div>

                      <div className="p-4 bg-slate-50 rounded-xl">
                        <h4 className="font-semibold text-slate-700 mb-3">Physician/Facility Information</h4>
                        <div className="grid grid-cols-2 gap-3 text-sm">
                          <div><span className="text-slate-500">Physician:</span> <span className="font-medium">{form.form301?.physicianInfo?.nameOfPhysician || '-'}</span></div>
                          <div><span className="text-slate-500">Facility:</span> <span className="font-medium">{form.form301?.physicianInfo?.facilityName || '-'}</span></div>
                          <div><span className="text-slate-500">Phone:</span> <span className="font-medium">{form.form301?.physicianInfo?.facilityPhone || '-'}</span></div>
                          <div><span className="text-slate-500">Hospitalized:</span> <span className="font-medium">{form.form301?.physicianInfo?.wasEmployeeHospitalized ? 'Yes' : 'No'}</span></div>
                        </div>
                      </div>
                    </>
                  )}
                </>
              )}

              {entryTab === 'returnToWork' && (
                <>
                  <div className="p-4 bg-slate-50 rounded-xl">
                    <h4 className="font-semibold text-slate-700 mb-3">Return to Work Status</h4>
                    <div className="flex items-center gap-3 mb-4">
                      <Badge color={
                        form.returnToWork?.status === 'full_duty' ? 'green' :
                        form.returnToWork?.status === 'restricted_duty' ? 'yellow' :
                        form.returnToWork?.status === 'off_work' ? 'red' : 'gray'
                      } size="md">{(form.returnToWork?.status || 'Unknown').replace(/_/g, ' ')}</Badge>
                    </div>
                    
                    <div className="grid grid-cols-2 gap-4 text-sm">
                      {form.returnToWork?.restrictedDutyStartDate && (
                        <div><span className="text-slate-500">Restricted Duty Start:</span><p className="font-medium">{new Date(form.returnToWork.restrictedDutyStartDate).toLocaleDateString()}</p></div>
                      )}
                      {form.returnToWork?.restrictedDutyEndDate && (
                        <div><span className="text-slate-500">Restricted Duty End:</span><p className="font-medium">{new Date(form.returnToWork.restrictedDutyEndDate).toLocaleDateString()}</p></div>
                      )}
                      {form.returnToWork?.fullDutyReturnDate && (
                        <div><span className="text-slate-500">Full Duty Return:</span><p className="font-medium">{new Date(form.returnToWork.fullDutyReturnDate).toLocaleDateString()}</p></div>
                      )}
                    </div>

                    {form.returnToWork?.restrictions?.length > 0 && (
                      <div className="mt-4">
                        <p className="text-slate-500 text-sm mb-2">Restrictions:</p>
                        <div className="flex flex-wrap gap-2">
                          {form.returnToWork.restrictions.map((r, i) => (
                            <Badge key={i} color="yellow">{r}</Badge>
                          ))}
                        </div>
                      </div>
                    )}
                  </div>

                  <div className="p-4 bg-green-50 rounded-xl border border-green-200">
                    <div className="flex items-center gap-2">
                      <div className={`w-5 h-5 rounded-full flex items-center justify-center ${form.returnToWork?.fitnessForDutyCleared ? 'bg-green-500 text-white' : 'bg-slate-200'}`}>
                        {form.returnToWork?.fitnessForDutyCleared && <Icons.Check />}
                      </div>
                      <span className="font-medium text-green-800">Fitness for Duty Clearance</span>
                    </div>
                    {form.returnToWork?.fitnessForDutyClearanceDate && (
                      <p className="text-sm text-green-600 mt-2">Cleared on: {new Date(form.returnToWork.fitnessForDutyClearanceDate).toLocaleDateString()}</p>
                    )}
                    {form.returnToWork?.clearingPhysician && (
                      <p className="text-sm text-green-600">Physician: {form.returnToWork.clearingPhysician}</p>
                    )}
                  </div>
                </>
              )}

              {entryTab === 'documents' && (
                <>
                  <div className="p-4 bg-blue-50 rounded-xl border border-blue-200 mb-4">
                    <p className="text-sm text-blue-700">Documents associated with this case are stored and can be accessed here.</p>
                  </div>
                  
                  {(form.documents || []).length === 0 ? (
                    <div className="text-center py-8 text-slate-500">
                      <Icons.Document />
                      <p className="mt-2">No documents uploaded for this case</p>
                    </div>
                  ) : (
                    <div className="space-y-3">
                      {(form.documents || []).map((doc, i) => (
                        <div key={i} className="flex items-center justify-between p-3 bg-slate-50 rounded-xl">
                          <div className="flex items-center gap-3">
                            <div className="w-10 h-10 bg-slate-200 rounded-lg flex items-center justify-center"><Icons.Document /></div>
                            <div>
                              <p className="font-medium text-slate-800">{doc.originalName || doc.filename}</p>
                              <p className="text-sm text-slate-500">{doc.documentType?.replace(/_/g, ' ')} ‚Ä¢ {new Date(doc.uploadedAt).toLocaleDateString()}</p>
                            </div>
                          </div>
                          <Button size="sm" variant="secondary" icon={<Icons.Download />}>Download</Button>
                        </div>
                      ))}
                    </div>
                  )}
                </>
              )}
            </div>
          </Modal>
        );
      };
      
      return (
        <div className="space-y-6 slide-up">
          <div className="flex flex-col lg:flex-row lg:items-center justify-between gap-4">
            <div>
              <h2 className="text-2xl lg:text-3xl font-bold text-slate-800">OSHA Recordkeeping</h2>
              <p className="text-slate-500">Manage OSHA 300, 300A, and 301 forms</p>
            </div>
            <div className="flex gap-3">
              <Select value={year} onChange={e => setYear(parseInt(e.target.value))} options={[...Array(5)].map((_, i) => ({ value: new Date().getFullYear() - i, label: (new Date().getFullYear() - i).toString() }))} className="w-32" />
              <Button variant="secondary" onClick={handleSync} loading={syncing} icon={<Icons.Download />}>Sync Incidents</Button>
            </div>
          </div>

          {/* Tabs */}
          <div className="flex gap-2 border-b border-slate-200 pb-2">
            {[
              { id: 'log', label: 'OSHA 300 Log' },
              { id: 'summary', label: '300A Summary' },
              { id: 'rates', label: 'Rates & Stats' },
              { id: 'certification', label: 'Certification' }
            ].map(t => (
              <button key={t.id} onClick={() => setTab(t.id)} 
                className={`px-4 py-2 text-sm font-medium rounded-lg ${tab === t.id ? 'bg-primary-100 text-primary-700' : 'text-slate-600 hover:bg-slate-100'}`}>
                {t.label}
              </button>
            ))}
          </div>
          
          {loading ? <div className="flex justify-center py-20"><Spinner size="lg" /></div> : (
            <>
              {/* OSHA 300 LOG TAB */}
              {tab === 'log' && (
                <div className="grid grid-cols-1 xl:grid-cols-4 gap-6">
                  <Card title={'OSHA 300 Log - ' + year} subtitle="Summary of work-related injuries and illnesses" className="xl:col-span-3" icon={<Icons.OSHA />}>
                    <div className="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                      {[
                        ['Deaths', log?.summary?.totalDeaths, 'red'], 
                        ['Days Away', log?.summary?.totalDaysAwayFromWork, 'orange'], 
                        ['Restricted/Transfer', log?.summary?.totalDaysTransferRestriction, 'yellow'], 
                        ['Other Recordable', log?.summary?.totalOtherRecordable, 'blue']
                      ].map(([label, val, color]) => (
                        <div key={label} className={'text-center p-4 rounded-xl border-2 bg-' + color + '-50 border-' + color + '-200'}>
                          <p className="text-3xl font-bold text-slate-800">{val || 0}</p>
                          <p className="text-sm font-medium text-slate-600">{label}</p>
                        </div>
                      ))}
                    </div>
                    
                    <h4 className="font-bold text-slate-800 mb-4">Log Entries ({log?.entries?.length || 0})</h4>
                    {log?.entries?.length ? (
                      <div className="overflow-x-auto border border-slate-200 rounded-xl">
                        <table className="w-full text-sm">
                          <thead><tr className="bg-slate-50 border-b border-slate-200">
                            <th className="px-4 py-3 text-left font-bold text-slate-600">Case #</th>
                            <th className="px-4 py-3 text-left font-bold text-slate-600">Employee</th>
                            <th className="px-4 py-3 text-left font-bold text-slate-600">Date</th>
                            <th className="px-4 py-3 text-left font-bold text-slate-600">Classification</th>
                            <th className="px-4 py-3 text-left font-bold text-slate-600">Days</th>
                            <th className="px-4 py-3 text-left font-bold text-slate-600">Status</th>
                            <th className="px-4 py-3 text-left font-bold text-slate-600"></th>
                          </tr></thead>
                          <tbody className="divide-y divide-slate-100">
                            {log.entries.map((e, i) => (
                              <tr key={i} className="hover:bg-slate-50 cursor-pointer" onClick={() => { setSelectedEntry(e); setEntryModal(true); }}>
                                <td className="px-4 py-3 font-mono text-xs">{e.caseNumber}</td>
                                <td className="px-4 py-3">
                                  <p className="font-medium">{e.privacyCase ? 'Privacy Case' : (e.employee?.name || e.employeeName)}</p>
                                  <p className="text-xs text-slate-500">{e.employee?.jobTitle || e.jobTitle}</p>
                                </td>
                                <td className="px-4 py-3 text-slate-500">{new Date(e.dates?.dateOfInjuryIllness || e.dateOfInjury).toLocaleDateString()}</td>
                                <td className="px-4 py-3">
                                  {e.classification?.death && <Badge color="red" size="sm">Death</Badge>}
                                  {e.classification?.daysAwayFromWork && <Badge color="orange" size="sm">Days Away</Badge>}
                                  {e.classification?.jobTransferOrRestriction && <Badge color="yellow" size="sm">Restricted</Badge>}
                                  {e.classification?.otherRecordableCase && <Badge color="blue" size="sm">Other</Badge>}
                                </td>
                                <td className="px-4 py-3">
                                  <span className="text-orange-600 font-semibold">{e.daysCount?.daysAwayFromWork || e.daysAwayFromWork || 0}</span>
                                  <span className="text-slate-400 mx-1">/</span>
                                  <span className="text-yellow-600 font-semibold">{e.daysCount?.daysJobTransferRestriction || e.daysJobTransferRestriction || 0}</span>
                                </td>
                                <td className="px-4 py-3">
                                  <Badge color={e.status === 'closed' ? 'green' : 'blue'}>{e.status || 'active'}</Badge>
                                </td>
                                <td className="px-4 py-3">
                                  <button className="p-2 hover:bg-primary-100 rounded-lg text-slate-500 hover:text-primary-600"><Icons.Eye /></button>
                                </td>
                              </tr>
                            ))}
                          </tbody>
                        </table>
                      </div>
                    ) : <EmptyState title="No OSHA entries" description="Sync incidents to populate this log" />}
                  </Card>
                  
                  <Card title="Export Forms" subtitle="Generate official OSHA forms" icon={<Icons.Download />}>
                    <div className="space-y-3">
                      {[['300', 'OSHA Form 300', 'Log of Work-Related Injuries'], 
                        ['300a', 'OSHA Form 300A', 'Annual Summary'], 
                        ['301', 'OSHA Form 301', 'Incident Report']].map(([form, title, desc]) => (
                        <button 
                          key={form} 
                          onClick={() => window.open(API + '/osha-logs/' + year + '/export/' + form, '_blank')} 
                          className="w-full p-4 bg-slate-50 hover:bg-primary-50 rounded-xl text-left transition-all border border-slate-200 hover:border-primary-300"
                        >
                          <p className="font-bold text-slate-800">{title}</p>
                          <p className="text-sm text-slate-500">{desc}</p>
                        </button>
                      ))}
                    </div>
                  </Card>
                </div>
              )}

              {/* 300A SUMMARY TAB */}
              {tab === 'summary' && (
                <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                  <Card title="Establishment Information">
                    <div className="grid grid-cols-2 gap-4">
                      <div>
                        <label className="text-sm text-slate-500">Establishment Name</label>
                        <p className="font-semibold text-slate-800">{log?.establishment?.name || '-'}</p>
                      </div>
                      <div>
                        <label className="text-sm text-slate-500">Industry</label>
                        <p className="font-semibold text-slate-800">{log?.establishment?.industry || '-'}</p>
                      </div>
                      <div>
                        <label className="text-sm text-slate-500">Address</label>
                        <p className="font-semibold text-slate-800">{log?.establishment?.streetAddress || '-'}</p>
                      </div>
                      <div>
                        <label className="text-sm text-slate-500">NAICS Code</label>
                        <p className="font-semibold text-slate-800">{log?.establishment?.naicsCode || '-'}</p>
                      </div>
                    </div>
                  </Card>

                  <Card title="Employment Information">
                    <div className="grid grid-cols-2 gap-4">
                      <div className="p-4 bg-slate-50 rounded-xl text-center">
                        <p className="text-3xl font-bold text-slate-800">{log?.employment?.annualAverageEmployees || '-'}</p>
                        <p className="text-sm text-slate-500">Annual Average Employees</p>
                      </div>
                      <div className="p-4 bg-slate-50 rounded-xl text-center">
                        <p className="text-3xl font-bold text-slate-800">{log?.employment?.totalHoursWorked?.toLocaleString() || '-'}</p>
                        <p className="text-sm text-slate-500">Total Hours Worked</p>
                      </div>
                    </div>
                  </Card>

                  <Card title="Injury & Illness Counts" className="lg:col-span-2">
                    <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4">
                      {[
                        ['Injuries', log?.summary?.totalInjuries, 'blue'],
                        ['Skin Disorders', log?.summary?.totalSkinDisorders, 'purple'],
                        ['Respiratory', log?.summary?.totalRespiratoryConditions, 'cyan'],
                        ['Poisonings', log?.summary?.totalPoisonings, 'red'],
                        ['Hearing Loss', log?.summary?.totalHearingLoss, 'orange'],
                        ['Other Illnesses', log?.summary?.totalOtherIllnesses, 'gray']
                      ].map(([label, val, color]) => (
                        <div key={label} className="p-4 bg-slate-50 rounded-xl text-center">
                          <p className="text-2xl font-bold text-slate-800">{val || 0}</p>
                          <p className="text-xs text-slate-500">{label}</p>
                        </div>
                      ))}
                    </div>
                  </Card>

                  <Card title="Days Counts" className="lg:col-span-2">
                    <div className="grid grid-cols-2 gap-6">
                      <div className="p-6 bg-orange-50 rounded-xl text-center">
                        <p className="text-4xl font-bold text-orange-600">{log?.summary?.totalDaysAwayFromWorkCount || 0}</p>
                        <p className="text-slate-600 mt-2">Total Days Away From Work</p>
                      </div>
                      <div className="p-6 bg-yellow-50 rounded-xl text-center">
                        <p className="text-4xl font-bold text-yellow-600">{log?.summary?.totalDaysJobTransferRestriction || 0}</p>
                        <p className="text-slate-600 mt-2">Total Days Job Transfer/Restriction</p>
                      </div>
                    </div>
                  </Card>
                </div>
              )}

              {/* RATES TAB */}
              {tab === 'rates' && (
                <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                  <Card className="text-center">
                    <div className="p-6">
                      <p className="text-5xl font-bold text-primary-600">{rates?.trir || 'N/A'}</p>
                      <p className="text-lg font-semibold text-slate-700 mt-2">TRIR</p>
                      <p className="text-sm text-slate-500">Total Recordable Incident Rate</p>
                      <p className="text-xs text-slate-400 mt-4">Formula: (Total Recordables √ó 200,000) / Hours Worked</p>
                    </div>
                  </Card>
                  <Card className="text-center">
                    <div className="p-6">
                      <p className="text-5xl font-bold text-orange-600">{rates?.dart || 'N/A'}</p>
                      <p className="text-lg font-semibold text-slate-700 mt-2">DART</p>
                      <p className="text-sm text-slate-500">Days Away, Restricted, or Transferred</p>
                      <p className="text-xs text-slate-400 mt-4">Formula: (DART Cases √ó 200,000) / Hours Worked</p>
                    </div>
                  </Card>
                  <Card className="text-center">
                    <div className="p-6">
                      <p className="text-5xl font-bold text-red-600">{rates?.ltir || 'N/A'}</p>
                      <p className="text-lg font-semibold text-slate-700 mt-2">LTIR</p>
                      <p className="text-sm text-slate-500">Lost Time Incident Rate</p>
                      <p className="text-xs text-slate-400 mt-4">Formula: (Lost Time Cases √ó 200,000) / Hours Worked</p>
                    </div>
                  </Card>

                  {!rates && (
                    <div className="lg:col-span-3 p-6 bg-amber-50 rounded-xl border border-amber-200 text-center">
                      <Icons.Incident />
                      <p className="font-semibold text-amber-800 mt-2">Cannot Calculate Rates</p>
                      <p className="text-amber-600">Please enter employment information (Annual Hours Worked) to calculate incident rates.</p>
                    </div>
                  )}
                </div>
              )}

              {/* CERTIFICATION TAB */}
              {tab === 'certification' && (
                <Card title="Form 300A Certification">
                  <div className="space-y-6">
                    <div className={'p-6 rounded-xl border-2 ' + (log?.certification?.certified ? 'bg-green-50 border-green-300' : 'bg-amber-50 border-amber-300')}>
                      <div className="flex items-center gap-3">
                        <div className={'w-10 h-10 rounded-full flex items-center justify-center text-white ' + (log?.certification?.certified ? 'bg-green-500' : 'bg-amber-500')}>
                          {log?.certification?.certified ? <Icons.Check /> : '!'}
                        </div>
                        <div>
                          <p className="font-bold text-lg">{log?.certification?.certified ? 'Log is Certified' : 'Certification Required'}</p>
                          <p className="text-sm text-slate-600">
                            {log?.certification?.certified 
                              ? `Certified by ${log.certification.certifiedBy?.name || 'Unknown'} on ${new Date(log.certification.certificationDate).toLocaleDateString()}`
                              : 'The 300A Summary must be certified and posted from Feb 1 - April 30'}
                          </p>
                        </div>
                      </div>
                    </div>

                    {log?.certification?.certified && (
                      <>
                        <div className="grid grid-cols-2 gap-4">
                          <div>
                            <label className="text-sm text-slate-500">Certified By</label>
                            <p className="font-semibold">{log.certification.certifiedBy?.name || '-'}</p>
                          </div>
                          <div>
                            <label className="text-sm text-slate-500">Title</label>
                            <p className="font-semibold">{log.certification.certifiedBy?.title || '-'}</p>
                          </div>
                          <div>
                            <label className="text-sm text-slate-500">Posted Start Date</label>
                            <p className="font-semibold">{log.certification.postedStartDate ? new Date(log.certification.postedStartDate).toLocaleDateString() : '-'}</p>
                          </div>
                          <div>
                            <label className="text-sm text-slate-500">Posted End Date</label>
                            <p className="font-semibold">{log.certification.postedEndDate ? new Date(log.certification.postedEndDate).toLocaleDateString() : '-'}</p>
                          </div>
                        </div>
                      </>
                    )}

                    <div className="flex gap-3">
                      <Button variant="secondary" icon={<Icons.Download />} onClick={() => window.open(API + '/osha-logs/' + year + '/export/300a', '_blank')}>Download 300A Form</Button>
                      {!log?.certification?.certified && (
                        <Button icon={<Icons.Check />} onClick={async () => {
                          if (confirm('Certify that this log is complete and accurate for ' + year + '?')) {
                            try {
                              await api.post('/osha-logs/' + year + '/certify');
                              addToast?.('Log certified successfully', 'success');
                              // Refresh
                              const d = await api.get('/osha-logs/' + year);
                              setLog(d.log);
                            } catch (e) { addToast?.('Certification failed', 'error'); }
                          }
                        }}>Certify Log</Button>
                      )}
                    </div>
                  </div>
                </Card>
              )}
            </>
          )}

          <EntryModal isOpen={entryModal} onClose={() => { setEntryModal(false); setSelectedEntry(null); }} entry={selectedEntry} />
        </div>
      );
    };

    // ========== INBOX PAGE ==========
    const InboxPage = () => {
      const [items, setItems] = useState([]);
      const [summary, setSummary] = useState({});
      const [loading, setLoading] = useState(true);
      const [filter, setFilter] = useState('all');
      const [dueFilter, setDueFilter] = useState('');
      
      useEffect(() => { fetchInbox(); }, [filter, dueFilter]);

      const fetchInbox = async () => {
        setLoading(true);
        try {
          const params = new URLSearchParams();
          if (filter !== 'all') params.append('view', filter);
          if (dueFilter) params.append('dueFilter', dueFilter);
          const data = await api.get('/inbox?' + params.toString());
          setItems(data.items || []);
          setSummary(data.summary || {});
        } catch (e) {
          console.error(e);
          // Demo data
          setItems([
            { id: '1', type: 'action', typeLabel: 'Action Item', number: 'ACT-001', title: 'Update safety signage in warehouse', status: 'in_progress', priority: 'high', dueDate: new Date(Date.now() + 86400000), isOverdue: false, url: '/actions/1' },
            { id: '2', type: 'inspection', typeLabel: 'Inspection', number: 'INS-015', title: 'Monthly fire extinguisher check', status: 'scheduled', priority: 'normal', dueDate: new Date(Date.now() - 86400000), isOverdue: true, url: '/inspections/2' },
            { id: '3', type: 'training', typeLabel: 'Training', title: 'Forklift Certification Renewal', status: 'assigned', priority: 'high', dueDate: new Date(Date.now() + 604800000), isOverdue: false, url: '/training/3' },
            { id: '4', type: 'incident', typeLabel: 'Incident', number: 'INC-042', title: 'Near miss - Forklift', status: 'investigating', priority: 'critical', dueDate: null, isOverdue: false, url: '/incidents/4' },
          ]);
          setSummary({ total: 4, overdue: 1, dueToday: 1, dueThisWeek: 2, byType: { actions: 1, inspections: 1, training: 1, incidents: 1 } });
        }
        setLoading(false);
      };

      const priorityColors = { critical: 'red', high: 'orange', normal: 'blue', low: 'gray' };
      const typeColors = { action: 'purple', inspection: 'blue', training: 'green', audit: 'yellow', incident: 'red', icare: 'cyan' };

      return (
        <div className="space-y-6 slide-up">
          <div className="flex flex-col lg:flex-row lg:items-center justify-between gap-4">
            <div>
              <h2 className="text-2xl lg:text-3xl font-bold text-slate-800">My Inbox</h2>
              <p className="text-slate-500">All your tasks, assignments, and items requiring attention</p>
            </div>
          </div>

          {/* Summary Cards */}
          <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
            <div className="bg-white p-4 rounded-xl shadow-sm border-l-4 border-primary-500">
              <p className="text-3xl font-bold text-slate-800">{summary.total || 0}</p>
              <p className="text-sm text-slate-500">Total Items</p>
            </div>
            <div className="bg-white p-4 rounded-xl shadow-sm border-l-4 border-red-500">
              <p className="text-3xl font-bold text-red-600">{summary.overdue || 0}</p>
              <p className="text-sm text-slate-500">Overdue</p>
            </div>
            <div className="bg-white p-4 rounded-xl shadow-sm border-l-4 border-orange-500">
              <p className="text-3xl font-bold text-orange-600">{summary.dueToday || 0}</p>
              <p className="text-sm text-slate-500">Due Today</p>
            </div>
            <div className="bg-white p-4 rounded-xl shadow-sm border-l-4 border-yellow-500">
              <p className="text-3xl font-bold text-yellow-600">{summary.dueThisWeek || 0}</p>
              <p className="text-sm text-slate-500">Due This Week</p>
            </div>
          </div>

          {/* Filters */}
          <div className="flex flex-wrap gap-3">
            <div className="flex bg-white rounded-xl p-1 shadow-sm">
              {['all', 'overdue', 'today', 'this_week'].map(f => (
                <button key={f} onClick={() => setDueFilter(f === 'all' ? '' : f)}
                  className={`px-4 py-2 text-sm font-medium rounded-lg capitalize ${(dueFilter === f || (f === 'all' && !dueFilter)) ? 'bg-primary-100 text-primary-700' : 'text-slate-600 hover:bg-slate-100'}`}>
                  {f === 'all' ? 'All' : f.replace('_', ' ')}
                </button>
              ))}
            </div>
            <div className="flex bg-white rounded-xl p-1 shadow-sm">
              {Object.entries(summary.byType || {}).map(([type, count]) => (
                <button key={type} onClick={() => setFilter(type)}
                  className={`px-3 py-2 text-sm font-medium rounded-lg capitalize flex items-center gap-2 ${filter === type ? 'bg-primary-100 text-primary-700' : 'text-slate-600 hover:bg-slate-100'}`}>
                  {type} <span className="bg-slate-200 px-2 py-0.5 rounded-full text-xs">{count}</span>
                </button>
              ))}
            </div>
          </div>

          {/* Items List */}
          <Card noPadding>
            {loading ? (
              <div className="flex justify-center py-16"><Spinner size="lg" /></div>
            ) : items.length === 0 ? (
              <EmptyState title="No items in inbox" description="You're all caught up! No pending tasks or assignments." icon={<Icons.Check />} />
            ) : (
              <div className="divide-y divide-slate-100">
                {items.map(item => (
                  <div key={item.id} onClick={() => window.location.hash = item.url} className="flex items-center justify-between p-4 hover:bg-slate-50 cursor-pointer transition-colors">
                    <div className="flex items-center gap-4">
                      <div className={`w-12 h-12 rounded-xl flex items-center justify-center ${item.isOverdue ? 'bg-red-100 text-red-600' : `bg-${typeColors[item.type] || 'gray'}-100 text-${typeColors[item.type] || 'gray'}-600`}`}>
                        {item.type === 'action' && <Icons.Action />}
                        {item.type === 'inspection' && <Icons.Inspection />}
                        {item.type === 'training' && <Icons.Training />}
                        {item.type === 'audit' && <Icons.Audit />}
                        {item.type === 'incident' && <Icons.Incident />}
                        {item.type === 'icare' && <Icons.Health />}
                      </div>
                      <div>
                        <div className="flex items-center gap-2">
                          <Badge color={typeColors[item.type] || 'gray'} size="sm">{item.typeLabel}</Badge>
                          {item.number && <span className="text-xs text-slate-400 font-mono">{item.number}</span>}
                          {item.isOverdue && <Badge color="red" size="sm">Overdue</Badge>}
                        </div>
                        <p className="font-semibold text-slate-800 mt-1">{item.title}</p>
                        <div className="flex items-center gap-3 mt-1">
                          <Badge color={priorityColors[item.priority] || 'gray'} size="sm">{item.priority}</Badge>
                          <Badge color="gray" size="sm">{item.status?.replace(/_/g, ' ')}</Badge>
                        </div>
                      </div>
                    </div>
                    <div className="text-right">
                      {item.dueDate && (
                        <p className={`text-sm font-medium ${item.isOverdue ? 'text-red-600' : 'text-slate-600'}`}>
                          {new Date(item.dueDate).toLocaleDateString()}
                        </p>
                      )}
                      <p className="text-xs text-slate-400">
                        {item.dueDate && (item.isOverdue ? 'Overdue' : 'Due')}
                      </p>
                    </div>
                  </div>
                ))}
              </div>
            )}
          </Card>
        </div>
      );
    };

    // ========== I-CARE NOTES PAGE ==========
    const ICarePage = () => {
      const [notes, setNotes] = useState([]);
      const [loading, setLoading] = useState(true);
      const [modal, setModal] = useState(false);
      const [selected, setSelected] = useState(null);
      const [stats, setStats] = useState([]);
      const { addToast } = useContext(ToastContext) || {};

      useEffect(() => { fetchNotes(); }, []);

      const fetchNotes = async () => {
        setLoading(true);
        try {
          const data = await api.get('/icare');
          setNotes(data.notes || []);
          setStats(data.stats || []);
        } catch (e) {
          console.error(e);
          setNotes([
            { _id: '1', noteNumber: 'ICARE-001', type: 'safe_behavior', observation: 'Employee wearing all required PPE while operating forklift', category: 'ppe', observer: { firstName: 'John', lastName: 'Smith' }, status: 'submitted', createdAt: new Date() },
            { _id: '2', noteNumber: 'ICARE-002', type: 'at_risk_behavior', observation: 'Worker not using handrail on stairs', category: 'body_positioning', observer: { firstName: 'Jane', lastName: 'Doe' }, followUpRequired: true, status: 'submitted', createdAt: new Date() },
          ]);
        }
        setLoading(false);
      };

      const handleSave = async (formData) => {
        try {
          if (selected?._id) {
            await api.put('/icare/' + selected._id, formData);
          } else {
            await api.post('/icare', formData);
          }
          addToast?.('I-CARE note saved', 'success');
          setModal(false);
          setSelected(null);
          fetchNotes();
        } catch (e) {
          addToast?.('Failed to save', 'error');
        }
      };

      const typeColors = { safe_behavior: 'green', at_risk_behavior: 'red', positive_recognition: 'blue', coaching_opportunity: 'yellow', safety_suggestion: 'purple', hazard_observation: 'orange' };

      return (
        <div className="space-y-6 slide-up">
          <div className="flex flex-col lg:flex-row lg:items-center justify-between gap-4">
            <div>
              <h2 className="text-2xl lg:text-3xl font-bold text-slate-800">I-CARE Notes</h2>
              <p className="text-slate-500">Behavior-based safety observations and recognition</p>
            </div>
            <Button onClick={() => { setSelected(null); setModal(true); }} icon={<Icons.Plus />}>New I-CARE Note</Button>
          </div>

          {/* Stats */}
          <div className="grid grid-cols-2 md:grid-cols-6 gap-4">
            {[
              { type: 'safe_behavior', label: 'Safe Behaviors', color: 'green' },
              { type: 'at_risk_behavior', label: 'At-Risk Behaviors', color: 'red' },
              { type: 'positive_recognition', label: 'Recognition', color: 'blue' },
              { type: 'coaching_opportunity', label: 'Coaching', color: 'yellow' },
              { type: 'safety_suggestion', label: 'Suggestions', color: 'purple' },
              { type: 'hazard_observation', label: 'Hazards', color: 'orange' }
            ].map(s => {
              const count = stats.find(st => st._id === s.type)?.count || 0;
              return (
                <div key={s.type} className={`bg-white p-4 rounded-xl shadow-sm border-l-4 border-${s.color}-500`}>
                  <p className="text-2xl font-bold text-slate-800">{count}</p>
                  <p className="text-xs text-slate-500">{s.label}</p>
                </div>
              );
            })}
          </div>

          <Card noPadding>
            {loading ? (
              <div className="flex justify-center py-16"><Spinner size="lg" /></div>
            ) : notes.length === 0 ? (
              <EmptyState title="No I-CARE notes" description="Start recognizing safe behaviors and coaching opportunities" icon={<Icons.Health />} action={<Button onClick={() => setModal(true)} icon={<Icons.Plus />}>Create First Note</Button>} />
            ) : (
              <div className="divide-y divide-slate-100">
                {notes.map(note => (
                  <div key={note._id} onClick={() => { setSelected(note); setModal(true); }} className="flex items-center justify-between p-4 hover:bg-slate-50 cursor-pointer transition-colors">
                    <div className="flex items-center gap-4">
                      <div className={`w-12 h-12 rounded-xl flex items-center justify-center bg-${typeColors[note.type] || 'gray'}-100 text-${typeColors[note.type] || 'gray'}-600`}>
                        <Icons.Health />
                      </div>
                      <div>
                        <div className="flex items-center gap-2">
                          <span className="text-xs text-slate-400 font-mono">{note.noteNumber}</span>
                          <Badge color={typeColors[note.type] || 'gray'}>{note.type?.replace(/_/g, ' ')}</Badge>
                          {note.followUpRequired && <Badge color="orange" size="sm">Follow-up Required</Badge>}
                        </div>
                        <p className="font-medium text-slate-800 mt-1 line-clamp-1">{note.observation}</p>
                        <p className="text-sm text-slate-500">by {note.observer?.firstName} {note.observer?.lastName} ‚Ä¢ {note.category?.replace(/_/g, ' ')}</p>
                      </div>
                    </div>
                    <div className="text-right">
                      <Badge color="gray">{note.status}</Badge>
                      <p className="text-xs text-slate-400 mt-1">{new Date(note.createdAt).toLocaleDateString()}</p>
                    </div>
                  </div>
                ))}
              </div>
            )}
          </Card>

          {/* I-CARE Modal */}
          {modal && (
            <ICareModal isOpen={modal} onClose={() => { setModal(false); setSelected(null); }} note={selected} onSave={handleSave} />
          )}
        </div>
      );
    };

    // I-CARE Modal Component
    const ICareModal = ({ isOpen, onClose, note, onSave }) => {
      const [form, setForm] = useState({
        type: 'safe_behavior', category: '', observation: '', location: '', department: '',
        conversationHeld: false, conversationNotes: '', recognitionType: 'none',
        followUpRequired: false, followUpType: '', followUpDescription: '', followUpDueDate: ''
      });
      const [saving, setSaving] = useState(false);

      useEffect(() => {
        if (note) {
          setForm({ ...note, followUpDueDate: note.followUpDueDate ? new Date(note.followUpDueDate).toISOString().split('T')[0] : '' });
        } else {
          setForm({ type: 'safe_behavior', category: '', observation: '', location: '', department: '', conversationHeld: false, conversationNotes: '', recognitionType: 'none', followUpRequired: false, followUpType: '', followUpDescription: '', followUpDueDate: '' });
        }
      }, [note, isOpen]);

      const handleSubmit = async () => {
        if (!form.observation) return;
        setSaving(true);
        await onSave(form);
        setSaving(false);
      };

      return (
        <Modal isOpen={isOpen} onClose={onClose} title={note ? 'Edit I-CARE Note' : 'New I-CARE Note'} size="lg"
          footer={<><Button variant="secondary" onClick={onClose}>Cancel</Button><Button onClick={handleSubmit} loading={saving}>{note ? 'Update' : 'Submit'}</Button></>}
        >
          <div className="space-y-5">
            <div className="grid grid-cols-2 gap-4">
              <Select label="Observation Type *" value={form.type} onChange={e => setForm(p => ({ ...p, type: e.target.value }))} options={[
                { value: 'safe_behavior', label: '‚úÖ Safe Behavior' },
                { value: 'at_risk_behavior', label: '‚ö†Ô∏è At-Risk Behavior' },
                { value: 'positive_recognition', label: 'üåü Positive Recognition' },
                { value: 'coaching_opportunity', label: 'üìö Coaching Opportunity' },
                { value: 'safety_suggestion', label: 'üí° Safety Suggestion' },
                { value: 'hazard_observation', label: 'üö® Hazard Observation' }
              ]} />
              <Select label="Category" value={form.category} onChange={e => setForm(p => ({ ...p, category: e.target.value }))} options={[
                { value: '', label: 'Select Category' },
                { value: 'ppe', label: 'PPE' },
                { value: 'body_positioning', label: 'Body Positioning' },
                { value: 'tool_equipment', label: 'Tool/Equipment Use' },
                { value: 'housekeeping', label: 'Housekeeping' },
                { value: 'procedures', label: 'Procedures' },
                { value: 'communication', label: 'Communication' },
                { value: 'awareness', label: 'Awareness' },
                { value: 'line_of_fire', label: 'Line of Fire' },
                { value: 'ergonomics', label: 'Ergonomics' },
                { value: 'lifting', label: 'Lifting' },
                { value: 'driving', label: 'Driving' },
                { value: 'other', label: 'Other' }
              ]} />
            </div>
            <div className="grid grid-cols-2 gap-4">
              <Input label="Location" value={form.location} onChange={e => setForm(p => ({ ...p, location: e.target.value }))} />
              <Input label="Department" value={form.department} onChange={e => setForm(p => ({ ...p, department: e.target.value }))} />
            </div>
            <Textarea label="Observation Details *" value={form.observation} onChange={e => setForm(p => ({ ...p, observation: e.target.value }))} rows={4} placeholder="Describe what you observed..." />
            
            <div className="p-4 bg-blue-50 rounded-xl border border-blue-200">
              <Checkbox label="I had a conversation with the person observed" checked={form.conversationHeld} onChange={e => setForm(p => ({ ...p, conversationHeld: e.target.checked }))} />
              {form.conversationHeld && (
                <Textarea label="Conversation Notes" value={form.conversationNotes} onChange={e => setForm(p => ({ ...p, conversationNotes: e.target.value }))} rows={2} className="mt-3" placeholder="What was discussed?" />
              )}
            </div>

            {(form.type === 'safe_behavior' || form.type === 'positive_recognition') && (
              <Select label="Recognition Given" value={form.recognitionType} onChange={e => setForm(p => ({ ...p, recognitionType: e.target.value }))} options={[
                { value: 'none', label: 'No Recognition Given' },
                { value: 'verbal', label: 'Verbal Recognition' },
                { value: 'written', label: 'Written Recognition' },
                { value: 'award', label: 'Award/Certificate' }
              ]} />
            )}

            <div className="p-4 bg-amber-50 rounded-xl border border-amber-200">
              <Checkbox label="Follow-up action required" checked={form.followUpRequired} onChange={e => setForm(p => ({ ...p, followUpRequired: e.target.checked }))} />
              {form.followUpRequired && (
                <div className="space-y-3 mt-3">
                  <div className="grid grid-cols-2 gap-4">
                    <Select label="Follow-up Type" value={form.followUpType} onChange={e => setForm(p => ({ ...p, followUpType: e.target.value }))} options={[
                      { value: '', label: 'Select Type' },
                      { value: 'training', label: 'Training' },
                      { value: 'coaching', label: 'Coaching' },
                      { value: 'investigation', label: 'Investigation' },
                      { value: 'equipment', label: 'Equipment Change' },
                      { value: 'procedure', label: 'Procedure Update' },
                      { value: 'other', label: 'Other' }
                    ]} />
                    <Input label="Due Date" type="date" value={form.followUpDueDate} onChange={e => setForm(p => ({ ...p, followUpDueDate: e.target.value }))} />
                  </div>
                  <Textarea label="Follow-up Description" value={form.followUpDescription} onChange={e => setForm(p => ({ ...p, followUpDescription: e.target.value }))} rows={2} />
                </div>
              )}
            </div>
          </div>
        </Modal>
      );
    };

    // ========== SCHEDULED AUDITS PAGE ==========
    const ScheduledAuditsPage = () => {
      const [audits, setAudits] = useState([]);
      const [loading, setLoading] = useState(true);
      const [modal, setModal] = useState(false);
      const [selected, setSelected] = useState(null);
      const { addToast } = useContext(ToastContext) || {};

      useEffect(() => { fetchAudits(); }, []);

      const fetchAudits = async () => {
        setLoading(true);
        try {
          const data = await api.get('/scheduled-audits');
          setAudits(data.audits || []);
        } catch (e) {
          console.error(e);
          setAudits([
            { _id: '1', auditNumber: 'AUD-001', title: 'ISO 45001 Internal Audit', auditType: 'internal', standard: 'ISO 45001', scheduledDate: new Date(Date.now() + 604800000), status: 'scheduled', leadAuditor: { firstName: 'John', lastName: 'Smith' } },
            { _id: '2', auditNumber: 'AUD-002', title: 'Monthly Safety Walkthrough', auditType: 'safety', scheduledDate: new Date(Date.now() - 86400000), status: 'in_progress', leadAuditor: { firstName: 'Jane', lastName: 'Doe' } },
          ]);
        }
        setLoading(false);
      };

      const statusColors = { scheduled: 'blue', in_preparation: 'yellow', in_progress: 'orange', pending_report: 'purple', pending_review: 'cyan', completed: 'green', cancelled: 'gray' };
      const typeColors = { internal: 'blue', external: 'purple', regulatory: 'red', compliance: 'orange', safety: 'green', environmental: 'cyan', quality: 'yellow' };

      return (
        <div className="space-y-6 slide-up">
          <div className="flex flex-col lg:flex-row lg:items-center justify-between gap-4">
            <div>
              <h2 className="text-2xl lg:text-3xl font-bold text-slate-800">Scheduled Audits</h2>
              <p className="text-slate-500">Plan and manage safety, compliance, and quality audits</p>
            </div>
            <Button onClick={() => { setSelected(null); setModal(true); }} icon={<Icons.Plus />}>Schedule Audit</Button>
          </div>

          <Card noPadding>
            {loading ? (
              <div className="flex justify-center py-16"><Spinner size="lg" /></div>
            ) : audits.length === 0 ? (
              <EmptyState title="No audits scheduled" description="Create your first audit schedule" icon={<Icons.Audit />} action={<Button onClick={() => setModal(true)} icon={<Icons.Plus />}>Schedule Audit</Button>} />
            ) : (
              <div className="divide-y divide-slate-100">
                {audits.map(audit => (
                  <div key={audit._id} onClick={() => { setSelected(audit); setModal(true); }} className="flex items-center justify-between p-4 hover:bg-slate-50 cursor-pointer transition-colors">
                    <div className="flex items-center gap-4">
                      <div className="w-12 h-12 rounded-xl flex items-center justify-center bg-blue-100 text-blue-600">
                        <Icons.Audit />
                      </div>
                      <div>
                        <div className="flex items-center gap-2">
                          <span className="text-xs text-slate-400 font-mono">{audit.auditNumber}</span>
                          <Badge color={typeColors[audit.auditType] || 'gray'}>{audit.auditType}</Badge>
                        </div>
                        <p className="font-semibold text-slate-800 mt-1">{audit.title}</p>
                        <p className="text-sm text-slate-500">
                          Lead: {audit.leadAuditor?.firstName} {audit.leadAuditor?.lastName}
                          {audit.standard && ` ‚Ä¢ ${audit.standard}`}
                        </p>
                      </div>
                    </div>
                    <div className="text-right">
                      <Badge color={statusColors[audit.status] || 'gray'}>{audit.status?.replace(/_/g, ' ')}</Badge>
                      <p className="text-sm text-slate-600 mt-1">{new Date(audit.scheduledDate).toLocaleDateString()}</p>
                    </div>
                  </div>
                ))}
              </div>
            )}
          </Card>

          {modal && <AuditModal isOpen={modal} onClose={() => { setModal(false); setSelected(null); }} audit={selected} onSave={() => { setModal(false); fetchAudits(); }} />}
        </div>
      );
    };

    // ========== AUDIT MODAL ==========
    const AuditModal = ({ isOpen, onClose, audit, onSave }) => {
      const [form, setForm] = useState({});
      const [saving, setSaving] = useState(false);
      const [tab, setTab] = useState('basic');
      const [users, setUsers] = useState([]);
      const { addToast } = useContext(ToastContext) || {};

      useEffect(() => {
        if (audit) {
          setForm({
            ...audit,
            scheduledDate: audit.scheduledDate ? new Date(audit.scheduledDate).toISOString().split('T')[0] : '',
            scheduledEndDate: audit.scheduledEndDate ? new Date(audit.scheduledEndDate).toISOString().split('T')[0] : '',
            checklist: audit.checklist || []
          });
        } else {
          setForm({
            title: '', description: '', auditType: 'internal', standard: '', scheduledDate: '',
            scheduledEndDate: '', duration: 4, scope: '', departments: [], locations: [],
            leadAuditor: '', auditTeam: [], status: 'scheduled', checklist: [],
            isRecurring: false, recurrence: { frequency: 'monthly', interval: 1 }
          });
        }
        setTab('basic');
        fetchUsers();
      }, [audit, isOpen]);

      const fetchUsers = async () => {
        try {
          const data = await api.get('/users');
          setUsers(data.users || []);
        } catch (e) {}
      };

      const handleSubmit = async () => {
        if (!form.title || !form.scheduledDate) return;
        setSaving(true);
        try {
          if (audit?._id) {
            await api.put('/scheduled-audits/' + audit._id, form);
          } else {
            await api.post('/scheduled-audits', form);
          }
          addToast?.('Audit saved', 'success');
          onSave();
        } catch (e) {
          addToast?.('Failed to save', 'error');
        }
        setSaving(false);
      };

      const addChecklistItem = () => {
        setForm(p => ({
          ...p,
          checklist: [...(p.checklist || []), { section: '', question: '', expectedEvidence: '', weight: 1, response: 'pending' }]
        }));
      };

      const updateChecklistItem = (index, field, value) => {
        setForm(p => {
          const checklist = [...(p.checklist || [])];
          checklist[index] = { ...checklist[index], [field]: value };
          return { ...p, checklist };
        });
      };

      return (
        <Modal isOpen={isOpen} onClose={onClose} title={audit ? 'Edit Audit' : 'Schedule New Audit'} size="xl"
          footer={<><Button variant="secondary" onClick={onClose}>Cancel</Button><Button onClick={handleSubmit} loading={saving}>{audit ? 'Update' : 'Schedule Audit'}</Button></>}
        >
          <div className="flex flex-wrap gap-1 mb-6 border-b border-slate-200 pb-3">
            {['basic', 'team', 'checklist', 'recurrence'].map(t => (
              <button key={t} onClick={() => setTab(t)}
                className={`px-3 py-2 text-sm font-medium rounded-lg capitalize ${tab === t ? 'bg-primary-100 text-primary-700' : 'text-slate-600 hover:bg-slate-100'}`}>
                {t === 'recurrence' ? 'Recurrence' : t}
              </button>
            ))}
          </div>

          <div className="space-y-5 max-h-[60vh] overflow-y-auto pr-2">
            {tab === 'basic' && (
              <>
                <Input label="Audit Title *" value={form.title || ''} onChange={e => setForm(p => ({ ...p, title: e.target.value }))} placeholder="e.g., Q1 ISO 45001 Internal Audit" />
                <div className="grid grid-cols-2 gap-4">
                  <Select label="Audit Type" value={form.auditType || 'internal'} onChange={e => setForm(p => ({ ...p, auditType: e.target.value }))} options={[
                    { value: 'internal', label: 'Internal Audit' },
                    { value: 'external', label: 'External Audit' },
                    { value: 'regulatory', label: 'Regulatory Audit' },
                    { value: 'compliance', label: 'Compliance Audit' },
                    { value: 'safety', label: 'Safety Audit' },
                    { value: 'environmental', label: 'Environmental Audit' },
                    { value: 'quality', label: 'Quality Audit' },
                    { value: 'supplier', label: 'Supplier Audit' },
                    { value: 'management_system', label: 'Management System Audit' }
                  ]} />
                  <Input label="Standard/Framework" value={form.standard || ''} onChange={e => setForm(p => ({ ...p, standard: e.target.value }))} placeholder="e.g., ISO 45001, OSHA" />
                </div>
                <div className="grid grid-cols-3 gap-4">
                  <Input label="Scheduled Date *" type="date" value={form.scheduledDate || ''} onChange={e => setForm(p => ({ ...p, scheduledDate: e.target.value }))} />
                  <Input label="End Date" type="date" value={form.scheduledEndDate || ''} onChange={e => setForm(p => ({ ...p, scheduledEndDate: e.target.value }))} />
                  <Input label="Duration (hours)" type="number" value={form.duration || ''} onChange={e => setForm(p => ({ ...p, duration: parseInt(e.target.value) || 0 }))} />
                </div>
                <Textarea label="Scope" value={form.scope || ''} onChange={e => setForm(p => ({ ...p, scope: e.target.value }))} rows={3} placeholder="Define the scope and objectives of this audit..." />
                <Textarea label="Description" value={form.description || ''} onChange={e => setForm(p => ({ ...p, description: e.target.value }))} rows={2} />
                <Select label="Status" value={form.status || 'scheduled'} onChange={e => setForm(p => ({ ...p, status: e.target.value }))} options={[
                  { value: 'scheduled', label: 'Scheduled' },
                  { value: 'in_preparation', label: 'In Preparation' },
                  { value: 'in_progress', label: 'In Progress' },
                  { value: 'pending_report', label: 'Pending Report' },
                  { value: 'pending_review', label: 'Pending Review' },
                  { value: 'completed', label: 'Completed' },
                  { value: 'cancelled', label: 'Cancelled' }
                ]} />
              </>
            )}

            {tab === 'team' && (
              <>
                <Select label="Lead Auditor *" value={form.leadAuditor || ''} onChange={e => setForm(p => ({ ...p, leadAuditor: e.target.value }))} options={[
                  { value: '', label: 'Select Lead Auditor' },
                  ...users.map(u => ({ value: u._id, label: u.firstName + ' ' + u.lastName }))
                ]} />
                <div>
                  <label className="block text-sm font-medium text-slate-700 mb-2">Audit Team Members</label>
                  <div className="flex flex-wrap gap-2 mb-2">
                    {(form.auditTeam || []).map(memberId => {
                      const user = users.find(u => u._id === memberId);
                      return user ? (
                        <Badge key={memberId} color="blue">
                          {user.firstName} {user.lastName}
                          <button onClick={() => setForm(p => ({ ...p, auditTeam: p.auditTeam.filter(id => id !== memberId) }))} className="ml-1">√ó</button>
                        </Badge>
                      ) : null;
                    })}
                  </div>
                  <Select value="" onChange={e => {
                    if (e.target.value && !form.auditTeam?.includes(e.target.value)) {
                      setForm(p => ({ ...p, auditTeam: [...(p.auditTeam || []), e.target.value] }));
                    }
                  }} options={[
                    { value: '', label: 'Add team member...' },
                    ...users.filter(u => !form.auditTeam?.includes(u._id)).map(u => ({ value: u._id, label: u.firstName + ' ' + u.lastName }))
                  ]} />
                </div>
                <Input label="Departments (comma separated)" value={(form.departments || []).join(', ')} onChange={e => setForm(p => ({ ...p, departments: e.target.value.split(',').map(s => s.trim()).filter(Boolean) }))} />
                <Input label="Locations (comma separated)" value={(form.locations || []).join(', ')} onChange={e => setForm(p => ({ ...p, locations: e.target.value.split(',').map(s => s.trim()).filter(Boolean) }))} />
              </>
            )}

            {tab === 'checklist' && (
              <>
                <div className="flex items-center justify-between mb-4">
                  <h4 className="font-semibold text-slate-800">Audit Checklist</h4>
                  <Button size="sm" onClick={addChecklistItem} icon={<Icons.Plus />}>Add Item</Button>
                </div>
                {(form.checklist || []).length === 0 ? (
                  <div className="text-center py-8 text-slate-500">
                    <p>No checklist items yet. Add items to create your audit checklist.</p>
                  </div>
                ) : (
                  <div className="space-y-3">
                    {(form.checklist || []).map((item, i) => (
                      <div key={i} className="p-4 bg-slate-50 rounded-xl border border-slate-200">
                        <div className="flex justify-between mb-3">
                          <span className="font-medium text-slate-700">Item {i + 1}</span>
                          <button onClick={() => setForm(p => ({ ...p, checklist: p.checklist.filter((_, idx) => idx !== i) }))} className="text-red-500 hover:text-red-700">Remove</button>
                        </div>
                        <div className="space-y-3">
                          <div className="grid grid-cols-2 gap-3">
                            <Input label="Section" value={item.section || ''} onChange={e => updateChecklistItem(i, 'section', e.target.value)} placeholder="e.g., Documentation" />
                            <Input label="Weight" type="number" value={item.weight || 1} onChange={e => updateChecklistItem(i, 'weight', parseInt(e.target.value) || 1)} />
                          </div>
                          <Textarea label="Question/Requirement" value={item.question || ''} onChange={e => updateChecklistItem(i, 'question', e.target.value)} rows={2} />
                          <Input label="Expected Evidence" value={item.expectedEvidence || ''} onChange={e => updateChecklistItem(i, 'expectedEvidence', e.target.value)} />
                        </div>
                      </div>
                    ))}
                  </div>
                )}
              </>
            )}

            {tab === 'recurrence' && (
              <>
                <Checkbox label="This is a recurring audit" checked={form.isRecurring || false} onChange={e => setForm(p => ({ ...p, isRecurring: e.target.checked }))} />
                {form.isRecurring && (
                  <div className="p-4 bg-blue-50 rounded-xl border border-blue-200 space-y-4">
                    <div className="grid grid-cols-2 gap-4">
                      <Select label="Frequency" value={form.recurrence?.frequency || 'monthly'} onChange={e => setForm(p => ({ ...p, recurrence: { ...p.recurrence, frequency: e.target.value } }))} options={[
                        { value: 'weekly', label: 'Weekly' },
                        { value: 'monthly', label: 'Monthly' },
                        { value: 'quarterly', label: 'Quarterly' },
                        { value: 'annually', label: 'Annually' }
                      ]} />
                      <Input label="Every X periods" type="number" value={form.recurrence?.interval || 1} onChange={e => setForm(p => ({ ...p, recurrence: { ...p.recurrence, interval: parseInt(e.target.value) || 1 } }))} />
                    </div>
                    <Input label="End Date (optional)" type="date" value={form.recurrence?.endDate || ''} onChange={e => setForm(p => ({ ...p, recurrence: { ...p.recurrence, endDate: e.target.value } }))} />
                  </div>
                )}
              </>
            )}
          </div>
        </Modal>
      );
    };

    // ========== HIERARCHY PAGE ==========
    const HierarchyPage = () => {
      const [users, setUsers] = useState([]);
      const [loading, setLoading] = useState(true);
      const [selected, setSelected] = useState(null);
      const [modal, setModal] = useState(false);
      const { addToast } = useContext(ToastContext) || {};

      useEffect(() => { fetchUsers(); }, []);

      const fetchUsers = async () => {
        setLoading(true);
        try {
          const data = await api.get('/users');
          setUsers(data.users || []);
        } catch (e) {
          console.error(e);
        }
        setLoading(false);
      };

      const handleSetReportsTo = async (userId, reportsToId) => {
        try {
          await api.put('/hierarchy/' + userId, { reportsTo: reportsToId });
          addToast?.('Reporting structure updated', 'success');
          fetchUsers();
        } catch (e) {
          addToast?.('Failed to update', 'error');
        }
      };

      return (
        <div className="space-y-6 slide-up">
          <div className="flex flex-col lg:flex-row lg:items-center justify-between gap-4">
            <div>
              <h2 className="text-2xl lg:text-3xl font-bold text-slate-800">Organization Hierarchy</h2>
              <p className="text-slate-500">Define reporting structure and task assignment permissions</p>
            </div>
          </div>

          <Card title="User Reporting Structure">
            {loading ? (
              <div className="flex justify-center py-16"><Spinner size="lg" /></div>
            ) : (
              <div className="space-y-4">
                {users.map(user => (
                  <div key={user._id} className="flex items-center justify-between p-4 bg-slate-50 rounded-xl">
                    <div className="flex items-center gap-4">
                      <div className="w-12 h-12 bg-primary-100 text-primary-600 rounded-full flex items-center justify-center font-bold">
                        {(user.firstName?.[0] || '') + (user.lastName?.[0] || '')}
                      </div>
                      <div>
                        <p className="font-semibold text-slate-800">{user.firstName} {user.lastName}</p>
                        <p className="text-sm text-slate-500">{user.jobTitle || user.role} ‚Ä¢ {user.department}</p>
                      </div>
                    </div>
                    <div className="flex items-center gap-4">
                      <Select 
                        value={user.reportsTo || ''} 
                        onChange={e => handleSetReportsTo(user._id, e.target.value || null)}
                        options={[
                          { value: '', label: 'No Supervisor' },
                          ...users.filter(u => u._id !== user._id).map(u => ({ value: u._id, label: u.firstName + ' ' + u.lastName }))
                        ]} 
                        className="w-48"
                      />
                      <Badge color={user.role === 'admin' ? 'purple' : user.role === 'manager' ? 'blue' : 'gray'}>{user.role}</Badge>
                    </div>
                  </div>
                ))}
              </div>
            )}
          </Card>
        </div>
      );
    };

    // ========== ARCHIVED INCIDENTS PAGE ==========
    const ArchivedPage = () => {
      const [archived, setArchived] = useState([]);
      const [loading, setLoading] = useState(true);
      const { addToast } = useContext(ToastContext) || {};

      useEffect(() => { fetchArchived(); }, []);

      const fetchArchived = async () => {
        setLoading(true);
        try {
          const data = await api.get('/archived-incidents');
          setArchived(data.archived || []);
        } catch (e) {
          console.error(e);
          setArchived([]);
        }
        setLoading(false);
      };

      const handleRestore = async (id) => {
        if (!confirm('Restore this incident?')) return;
        try {
          await api.post('/archived-incidents/' + id + '/restore');
          addToast?.('Incident restored', 'success');
          fetchArchived();
        } catch (e) {
          addToast?.('Restore failed', 'error');
        }
      };

      return (
        <div className="space-y-6 slide-up">
          <div>
            <h2 className="text-2xl lg:text-3xl font-bold text-slate-800">Archived Incidents</h2>
            <p className="text-slate-500">View and restore archived incident records</p>
          </div>

          <Card noPadding>
            {loading ? (
              <div className="flex justify-center py-16"><Spinner size="lg" /></div>
            ) : archived.length === 0 ? (
              <EmptyState title="No archived incidents" description="Closed incidents that have been archived will appear here" icon={<Icons.Document />} />
            ) : (
              <div className="divide-y divide-slate-100">
                {archived.map(item => (
                  <div key={item._id} className="flex items-center justify-between p-4 hover:bg-slate-50">
                    <div>
                      <div className="flex items-center gap-2">
                        <span className="text-xs text-slate-400 font-mono">{item.incidentNumber}</span>
                      </div>
                      <p className="font-semibold text-slate-800 mt-1">{item.incidentData?.title}</p>
                      <p className="text-sm text-slate-500">
                        Archived by {item.archivedBy?.firstName} {item.archivedBy?.lastName} on {new Date(item.archivedAt).toLocaleDateString()}
                      </p>
                      {item.archiveReason && <p className="text-sm text-slate-400 mt-1">Reason: {item.archiveReason}</p>}
                    </div>
                    <div className="flex gap-2">
                      {item.canRestore && (
                        <Button size="sm" variant="secondary" onClick={() => handleRestore(item._id)}>Restore</Button>
                      )}
                    </div>
                  </div>
                ))}
              </div>
            )}
          </Card>
        </div>
      );
    };

    // ========== CUSTOM REPORTS PAGE ==========
    const CustomReportsPage = () => {
      const [reports, setReports] = useState([]);
      const [loading, setLoading] = useState(true);
      const [modal, setModal] = useState(false);
      const [selected, setSelected] = useState(null);
      const { addToast } = useContext(ToastContext) || {};

      useEffect(() => { fetchReports(); }, []);

      const fetchReports = async () => {
        setLoading(true);
        try {
          const data = await api.get('/custom-reports');
          setReports(data.reports || []);
        } catch (e) {
          console.error(e);
          setReports([
            { _id: '1', name: 'Monthly Incident Summary', description: 'Summary of all incidents by type and severity', primarySource: 'incidents', reportType: 'summary', createdBy: { firstName: 'Admin' }, isScheduled: true, runCount: 12 },
            { _id: '2', name: 'Training Compliance Report', description: 'Employee training status and overdue items', primarySource: 'training', reportType: 'tabular', createdBy: { firstName: 'Admin' }, runCount: 5 },
          ]);
        }
        setLoading(false);
      };

      const handleRun = async (reportId) => {
        try {
          const data = await api.post('/custom-reports/' + reportId + '/run');
          addToast?.(`Report generated: ${data.rowCount} rows in ${data.executionTime}ms`, 'success');
          // Could open results in modal or download
        } catch (e) {
          addToast?.('Failed to run report', 'error');
        }
      };

      return (
        <div className="space-y-6 slide-up">
          <div className="flex flex-col lg:flex-row lg:items-center justify-between gap-4">
            <div>
              <h2 className="text-2xl lg:text-3xl font-bold text-slate-800">Report Builder</h2>
              <p className="text-slate-500">Create custom reports from your safety data</p>
            </div>
            <Button onClick={() => { setSelected(null); setModal(true); }} icon={<Icons.Plus />}>Create Report</Button>
          </div>

          <Card noPadding>
            {loading ? (
              <div className="flex justify-center py-16"><Spinner size="lg" /></div>
            ) : reports.length === 0 ? (
              <EmptyState title="No custom reports" description="Build your first custom report" icon={<Icons.Reports />} action={<Button onClick={() => setModal(true)} icon={<Icons.Plus />}>Create Report</Button>} />
            ) : (
              <div className="divide-y divide-slate-100">
                {reports.map(report => (
                  <div key={report._id} className="flex items-center justify-between p-4 hover:bg-slate-50">
                    <div className="flex items-center gap-4">
                      <div className="w-12 h-12 rounded-xl flex items-center justify-center bg-purple-100 text-purple-600">
                        <Icons.Reports />
                      </div>
                      <div>
                        <div className="flex items-center gap-2">
                          <Badge color="purple">{report.primarySource}</Badge>
                          <Badge color="gray">{report.reportType}</Badge>
                          {report.isScheduled && <Badge color="blue" size="sm">Scheduled</Badge>}
                        </div>
                        <p className="font-semibold text-slate-800 mt-1">{report.name}</p>
                        <p className="text-sm text-slate-500">{report.description}</p>
                      </div>
                    </div>
                    <div className="flex items-center gap-3">
                      <span className="text-sm text-slate-400">{report.runCount || 0} runs</span>
                      <Button size="sm" variant="secondary" onClick={() => handleRun(report._id)} icon={<Icons.Download />}>Run</Button>
                      <button onClick={() => { setSelected(report); setModal(true); }} className="p-2 hover:bg-primary-100 rounded-lg text-slate-500 hover:text-primary-600"><Icons.Edit /></button>
                    </div>
                  </div>
                ))}
              </div>
            )}
          </Card>

          {modal && <ReportBuilderModal isOpen={modal} onClose={() => { setModal(false); setSelected(null); }} report={selected} onSave={() => { setModal(false); fetchReports(); }} />}
        </div>
      );
    };

    // ========== REPORT BUILDER MODAL ==========
    const ReportBuilderModal = ({ isOpen, onClose, report, onSave }) => {
      const [form, setForm] = useState({});
      const [saving, setSaving] = useState(false);
      const [tab, setTab] = useState('basic');
      const { addToast } = useContext(ToastContext) || {};

      useEffect(() => {
        if (report) {
          setForm({ ...report });
        } else {
          setForm({
            name: '', description: '', reportType: 'tabular', primarySource: 'incidents',
            columns: [], filters: [], userFilters: [], groupBy: [], sortBy: [],
            showSummary: false, summaryFields: [], isScheduled: false, schedule: {},
            deliveryMethod: ['download'], exportFormats: ['excel'], isPublic: false
          });
        }
        setTab('basic');
      }, [report, isOpen]);

      const handleSubmit = async () => {
        if (!form.name) return;
        setSaving(true);
        try {
          if (report?._id) {
            await api.put('/custom-reports/' + report._id, form);
          } else {
            await api.post('/custom-reports', form);
          }
          addToast?.('Report saved', 'success');
          onSave();
        } catch (e) {
          addToast?.('Failed to save', 'error');
        }
        setSaving(false);
      };

      const sourceFields = {
        incidents: [
          { field: 'incidentNumber', label: 'Incident Number', type: 'text' },
          { field: 'title', label: 'Title', type: 'text' },
          { field: 'type', label: 'Type', type: 'text' },
          { field: 'severity', label: 'Severity', type: 'text' },
          { field: 'status', label: 'Status', type: 'text' },
          { field: 'dateOccurred', label: 'Date Occurred', type: 'date' },
          { field: 'location.department', label: 'Department', type: 'text' },
          { field: 'location.site', label: 'Site', type: 'text' },
          { field: 'oshaRecordability.isRecordable', label: 'OSHA Recordable', type: 'boolean' },
          { field: 'costs.grandTotal', label: 'Total Cost', type: 'number' },
          { field: 'createdAt', label: 'Created Date', type: 'date' }
        ],
        actions: [
          { field: 'actionNumber', label: 'Action Number', type: 'text' },
          { field: 'title', label: 'Title', type: 'text' },
          { field: 'type', label: 'Type', type: 'text' },
          { field: 'priority', label: 'Priority', type: 'text' },
          { field: 'status', label: 'Status', type: 'text' },
          { field: 'dueDate', label: 'Due Date', type: 'date' },
          { field: 'completedDate', label: 'Completed Date', type: 'date' }
        ],
        training: [
          { field: 'course.title', label: 'Course Title', type: 'text' },
          { field: 'status', label: 'Status', type: 'text' },
          { field: 'dueDate', label: 'Due Date', type: 'date' },
          { field: 'completedDate', label: 'Completed Date', type: 'date' },
          { field: 'score', label: 'Score', type: 'number' }
        ],
        inspections: [
          { field: 'inspectionNumber', label: 'Inspection Number', type: 'text' },
          { field: 'title', label: 'Title', type: 'text' },
          { field: 'type', label: 'Type', type: 'text' },
          { field: 'status', label: 'Status', type: 'text' },
          { field: 'scheduledDate', label: 'Scheduled Date', type: 'date' },
          { field: 'score', label: 'Score', type: 'number' }
        ],
        icare: [
          { field: 'noteNumber', label: 'Note Number', type: 'text' },
          { field: 'type', label: 'Type', type: 'text' },
          { field: 'category', label: 'Category', type: 'text' },
          { field: 'observation', label: 'Observation', type: 'text' },
          { field: 'followUpRequired', label: 'Follow-up Required', type: 'boolean' },
          { field: 'createdAt', label: 'Created Date', type: 'date' }
        ]
      };

      const availableFields = sourceFields[form.primarySource] || [];

      const addColumn = (field) => {
        const fieldDef = availableFields.find(f => f.field === field);
        if (!fieldDef) return;
        if (form.columns?.some(c => c.field === field)) return;
        setForm(p => ({
          ...p,
          columns: [...(p.columns || []), { field: fieldDef.field, label: fieldDef.label, type: fieldDef.type, visible: true, sortable: true, order: (p.columns?.length || 0) }]
        }));
      };

      const removeColumn = (field) => {
        setForm(p => ({ ...p, columns: p.columns.filter(c => c.field !== field) }));
      };

      const addFilter = () => {
        setForm(p => ({
          ...p,
          filters: [...(p.filters || []), { field: '', operator: 'equals', value: '' }]
        }));
      };

      return (
        <Modal isOpen={isOpen} onClose={onClose} title={report ? 'Edit Report' : 'Create Custom Report'} size="xl"
          footer={<><Button variant="secondary" onClick={onClose}>Cancel</Button><Button onClick={handleSubmit} loading={saving}>{report ? 'Update' : 'Create Report'}</Button></>}
        >
          <div className="flex flex-wrap gap-1 mb-6 border-b border-slate-200 pb-3">
            {['basic', 'columns', 'filters', 'schedule'].map(t => (
              <button key={t} onClick={() => setTab(t)}
                className={`px-3 py-2 text-sm font-medium rounded-lg capitalize ${tab === t ? 'bg-primary-100 text-primary-700' : 'text-slate-600 hover:bg-slate-100'}`}>
                {t}
              </button>
            ))}
          </div>

          <div className="space-y-5 max-h-[60vh] overflow-y-auto pr-2">
            {tab === 'basic' && (
              <>
                <Input label="Report Name *" value={form.name || ''} onChange={e => setForm(p => ({ ...p, name: e.target.value }))} placeholder="e.g., Monthly Incident Summary" />
                <Textarea label="Description" value={form.description || ''} onChange={e => setForm(p => ({ ...p, description: e.target.value }))} rows={2} />
                <div className="grid grid-cols-2 gap-4">
                  <Select label="Data Source *" value={form.primarySource || 'incidents'} onChange={e => setForm(p => ({ ...p, primarySource: e.target.value, columns: [] }))} options={[
                    { value: 'incidents', label: 'Incidents' },
                    { value: 'actions', label: 'Action Items' },
                    { value: 'inspections', label: 'Inspections' },
                    { value: 'training', label: 'Training Records' },
                    { value: 'icare', label: 'I-CARE Notes' },
                    { value: 'audits', label: 'Audits' }
                  ]} />
                  <Select label="Report Type" value={form.reportType || 'tabular'} onChange={e => setForm(p => ({ ...p, reportType: e.target.value }))} options={[
                    { value: 'tabular', label: 'Tabular (List)' },
                    { value: 'summary', label: 'Summary' },
                    { value: 'trend', label: 'Trend Analysis' },
                    { value: 'comparison', label: 'Comparison' },
                    { value: 'kpi', label: 'KPI Dashboard' }
                  ]} />
                </div>
                <div>
                  <label className="block text-sm font-medium text-slate-700 mb-2">Export Formats</label>
                  <div className="flex gap-3">
                    {['excel', 'pdf', 'csv'].map(fmt => (
                      <Checkbox key={fmt} label={fmt.toUpperCase()} checked={(form.exportFormats || []).includes(fmt)} 
                        onChange={e => {
                          if (e.target.checked) {
                            setForm(p => ({ ...p, exportFormats: [...(p.exportFormats || []), fmt] }));
                          } else {
                            setForm(p => ({ ...p, exportFormats: (p.exportFormats || []).filter(f => f !== fmt) }));
                          }
                        }} />
                    ))}
                  </div>
                </div>
                <Checkbox label="Make this report public (visible to all users)" checked={form.isPublic || false} onChange={e => setForm(p => ({ ...p, isPublic: e.target.checked }))} />
              </>
            )}

            {tab === 'columns' && (
              <>
                <div className="grid grid-cols-2 gap-6">
                  <div>
                    <h4 className="font-semibold text-slate-800 mb-3">Available Fields</h4>
                    <div className="border border-slate-200 rounded-xl max-h-64 overflow-y-auto">
                      {availableFields.map(f => (
                        <div key={f.field} onClick={() => addColumn(f.field)}
                          className={`p-3 border-b border-slate-100 cursor-pointer hover:bg-slate-50 flex justify-between items-center ${form.columns?.some(c => c.field === f.field) ? 'bg-green-50' : ''}`}>
                          <span className="text-sm">{f.label}</span>
                          {form.columns?.some(c => c.field === f.field) ? (
                            <Badge color="green" size="sm">Added</Badge>
                          ) : (
                            <span className="text-primary-600 text-sm">+ Add</span>
                          )}
                        </div>
                      ))}
                    </div>
                  </div>
                  <div>
                    <h4 className="font-semibold text-slate-800 mb-3">Selected Columns ({(form.columns || []).length})</h4>
                    <div className="border border-slate-200 rounded-xl max-h-64 overflow-y-auto">
                      {(form.columns || []).length === 0 ? (
                        <p className="p-4 text-sm text-slate-500 text-center">Click fields on the left to add columns</p>
                      ) : (
                        form.columns.map((col, i) => (
                          <div key={col.field} className="p-3 border-b border-slate-100 flex justify-between items-center">
                            <span className="text-sm font-medium">{col.label}</span>
                            <button onClick={() => removeColumn(col.field)} className="text-red-500 hover:text-red-700 text-sm">Remove</button>
                          </div>
                        ))
                      )}
                    </div>
                  </div>
                </div>
                <Checkbox label="Show summary row with totals" checked={form.showSummary || false} onChange={e => setForm(p => ({ ...p, showSummary: e.target.checked }))} />
              </>
            )}

            {tab === 'filters' && (
              <>
                <div className="flex items-center justify-between mb-4">
                  <h4 className="font-semibold text-slate-800">Report Filters</h4>
                  <Button size="sm" onClick={addFilter} icon={<Icons.Plus />}>Add Filter</Button>
                </div>
                {(form.filters || []).length === 0 ? (
                  <p className="text-sm text-slate-500 text-center py-8">No filters. This report will include all records.</p>
                ) : (
                  <div className="space-y-3">
                    {(form.filters || []).map((filter, i) => (
                      <div key={i} className="flex gap-3 items-end">
                        <Select label={i === 0 ? 'Field' : ''} value={filter.field} onChange={e => {
                          const filters = [...form.filters];
                          filters[i] = { ...filters[i], field: e.target.value };
                          setForm(p => ({ ...p, filters }));
                        }} options={[{ value: '', label: 'Select field...' }, ...availableFields.map(f => ({ value: f.field, label: f.label }))]} className="flex-1" />
                        <Select label={i === 0 ? 'Operator' : ''} value={filter.operator} onChange={e => {
                          const filters = [...form.filters];
                          filters[i] = { ...filters[i], operator: e.target.value };
                          setForm(p => ({ ...p, filters }));
                        }} options={[
                          { value: 'equals', label: 'Equals' },
                          { value: 'not_equals', label: 'Not Equals' },
                          { value: 'contains', label: 'Contains' },
                          { value: 'greater_than', label: 'Greater Than' },
                          { value: 'less_than', label: 'Less Than' }
                        ]} className="w-40" />
                        <Input label={i === 0 ? 'Value' : ''} value={filter.value || ''} onChange={e => {
                          const filters = [...form.filters];
                          filters[i] = { ...filters[i], value: e.target.value };
                          setForm(p => ({ ...p, filters }));
                        }} className="flex-1" />
                        <button onClick={() => setForm(p => ({ ...p, filters: p.filters.filter((_, idx) => idx !== i) }))} className="p-2 text-red-500 hover:bg-red-50 rounded-lg mb-1"><Icons.Trash /></button>
                      </div>
                    ))}
                  </div>
                )}
              </>
            )}

            {tab === 'schedule' && (
              <>
                <Checkbox label="Schedule this report to run automatically" checked={form.isScheduled || false} onChange={e => setForm(p => ({ ...p, isScheduled: e.target.checked }))} />
                {form.isScheduled && (
                  <div className="p-4 bg-blue-50 rounded-xl border border-blue-200 space-y-4">
                    <div className="grid grid-cols-2 gap-4">
                      <Select label="Frequency" value={form.schedule?.frequency || 'weekly'} onChange={e => setForm(p => ({ ...p, schedule: { ...p.schedule, frequency: e.target.value } }))} options={[
                        { value: 'daily', label: 'Daily' },
                        { value: 'weekly', label: 'Weekly' },
                        { value: 'monthly', label: 'Monthly' },
                        { value: 'quarterly', label: 'Quarterly' }
                      ]} />
                      <Input label="Time" type="time" value={form.schedule?.time || '09:00'} onChange={e => setForm(p => ({ ...p, schedule: { ...p.schedule, time: e.target.value } }))} />
                    </div>
                    <div>
                      <label className="block text-sm font-medium text-slate-700 mb-2">Delivery Method</label>
                      <div className="flex gap-3">
                        {['email', 'dashboard'].map(method => (
                          <Checkbox key={method} label={method.charAt(0).toUpperCase() + method.slice(1)} checked={(form.deliveryMethod || []).includes(method)} 
                            onChange={e => {
                              if (e.target.checked) {
                                setForm(p => ({ ...p, deliveryMethod: [...(p.deliveryMethod || []), method] }));
                              } else {
                                setForm(p => ({ ...p, deliveryMethod: (p.deliveryMethod || []).filter(m => m !== method) }));
                              }
                            }} />
                        ))}
                      </div>
                    </div>
                    <Input label="Recipient Emails (comma separated)" value={(form.recipientEmails || []).join(', ')} onChange={e => setForm(p => ({ ...p, recipientEmails: e.target.value.split(',').map(s => s.trim()).filter(Boolean) }))} />
                  </div>
                )}
              </>
            )}
          </div>
        </Modal>
      );
    };

    // ========== SETTINGS PAGE ==========
    const SettingsPage = () => {
      const { user } = useContext(AuthContext);
      const [org, setOrg] = useState(null);
      const [sub, setSub] = useState(null);
      const [loading, setLoading] = useState(true);
      const [saving, setSaving] = useState(false);
      const [tab, setTab] = useState('organization');
      const { addToast } = useContext(ToastContext) || {};

      useEffect(() => { 
        Promise.all([api.get('/organization'), api.get('/subscription')])
          .then(([o, s]) => { setOrg(o.organization); setSub(s); })
          .catch(console.error)
          .finally(() => setLoading(false)); 
      }, []);

      const handleSave = async () => { 
        setSaving(true); 
        try { 
          await api.put('/organization', org); 
          addToast?.('Settings saved successfully!', 'success'); 
        } catch (e) { 
          addToast?.('Failed to save settings', 'error'); 
        } finally { setSaving(false); } 
      };

      if (loading) return <div className="flex justify-center py-20"><Spinner size="lg" /></div>;

      return (
        <div className="space-y-6 slide-up">
          <div>
            <h2 className="text-2xl lg:text-3xl font-bold text-slate-800">Settings</h2>
            <p className="text-slate-500 mt-1">Manage your organization and subscription</p>
          </div>
          
          <Tabs tabs={[{ id: 'organization', label: 'Organization' }, { id: 'subscription', label: 'Subscription' }, { id: 'notifications', label: 'Notifications' }]} active={tab} onChange={setTab} />
          
          {tab === 'organization' && (
            <Card title="Organization Details" icon={<Icons.Contractor />}>
              <div className="space-y-5 max-w-2xl">
                <Input label="Organization Name" value={org?.name || ''} onChange={e => setOrg(p => ({ ...p, name: e.target.value }))} />
                <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                  <Input label="Phone" type="tel" value={org?.phone || ''} onChange={e => setOrg(p => ({ ...p, phone: e.target.value }))} />
                  <Input label="Email" type="email" value={org?.email || ''} onChange={e => setOrg(p => ({ ...p, email: e.target.value }))} />
                </div>
                <Input label="NAICS Code" value={org?.settings?.naicsCode || ''} onChange={e => setOrg(p => ({ ...p, settings: { ...p.settings, naicsCode: e.target.value } }))} helper="North American Industry Classification System code" />
                <Button onClick={handleSave} loading={saving}>Save Changes</Button>
              </div>
            </Card>
          )}
          
          {tab === 'subscription' && sub && (
            <div className="space-y-6">
              <div className="bg-gradient-to-r from-primary-600 to-primary-700 rounded-2xl p-6 text-white">
                <div className="flex flex-col md:flex-row md:items-center justify-between gap-4">
                  <div>
                    <p className="text-primary-100 font-medium">Current Plan</p>
                    <h3 className="text-2xl font-bold mt-1">{PRICING[sub.subscription?.tier]?.name || 'Starter'}</h3>
                    <p className="text-primary-100 mt-2">${PRICING[sub.subscription?.tier]?.price || 199}/month ‚Ä¢ {PRICING[sub.subscription?.tier]?.users || 10} users</p>
                  </div>
                  <Button variant="secondary" className="!bg-white !text-primary-700">Manage Billing</Button>
                </div>
              </div>
              
              <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                {Object.entries(sub.availableTiers || PRICING).map(([k, t]) => {
                  const isCurrent = sub.subscription?.tier === k;
                  return (
                    <Card key={k} className={isCurrent ? 'ring-2 ring-primary-500 shadow-lg shadow-primary-500/20' : ''}>
                      <div className="text-center">
                        {isCurrent && <Badge color="blue">Current Plan</Badge>}
                        <h3 className="text-xl font-bold text-slate-800 mt-3">{t.name}</h3>
                        <div className="mt-4">
                          <span className="text-4xl font-bold text-slate-800">${t.price}</span>
                          <span className="text-slate-500">/month</span>
                        </div>
                        <p className="text-slate-500 mt-2">{t.maxUsers === -1 ? 'Unlimited' : t.maxUsers} users</p>
                        
                        <div className="mt-6 space-y-3 text-left">
                          {[
                            ['Incidents & Actions', true],
                            ['Inspections & Training', true],
                            ['OSHA 300 Logs', true],
                            ['Risk Assessments', t.riskAssessment],
                            ['Job Safety Analysis', t.jsaModule],
                            ['Permits to Work', t.permitToWork],
                            ['Contractor Management', t.contractorManagement],
                            ['Chemical/SDS', t.chemicalManagement],
                            ['SSO Integration', t.ssoIntegration],
                          ].map(([f, has]) => (
                            <div key={f} className="flex items-center gap-2 text-sm">
                              <span className={has ? 'text-emerald-500' : 'text-slate-300'}>{has ? '‚úì' : '‚úó'}</span>
                              <span className={has ? 'text-slate-700' : 'text-slate-400'}>{f}</span>
                            </div>
                          ))}
                        </div>
                        
                        {!isCurrent && (
                          <Button 
                            className="w-full mt-6" 
                            variant={k === 'enterprise' ? 'primary' : 'outline'}
                            onClick={async () => { 
                              if (confirm('Upgrade to ' + t.name + ' ($' + t.price + '/mo)?')) { 
                                await api.post('/subscription/upgrade', { tier: k }); 
                                window.location.reload(); 
                              } 
                            }}
                          >
                            {t.price > (PRICING[sub.subscription?.tier]?.price || 0) ? 'Upgrade' : 'Switch'} to {t.name}
                          </Button>
                        )}
                      </div>
                    </Card>
                  );
                })}
              </div>
            </div>
          )}
          
          {tab === 'notifications' && (
            <Card title="Notification Preferences" icon={<Icons.Bell />}>
              <div className="space-y-4 max-w-xl">
                <Checkbox label="Email notifications for new incidents" checked={true} onChange={() => {}} />
                <Checkbox label="Email notifications for overdue action items" checked={true} onChange={() => {}} />
                <Checkbox label="Daily summary digest" checked={false} onChange={() => {}} />
                <Checkbox label="Weekly safety report" checked={true} onChange={() => {}} />
                <Button className="mt-4">Save Preferences</Button>
              </div>
            </Card>
          )}
        </div>
      );
    };

    // ========== USER MODAL ==========
    const UserModal = ({ isOpen, onClose, user: editUser, onSave }) => {
      const [form, setForm] = useState({});
      const [loading, setLoading] = useState(false);
      const [errors, setErrors] = useState({});
      
      useEffect(() => {
        if (editUser) {
          setForm({ ...editUser, password: '' });
        } else {
          setForm({ firstName: '', lastName: '', email: '', password: '', role: 'employee', department: '', phone: '', isActive: true });
        }
        setErrors({});
      }, [editUser, isOpen]);

      const validate = () => {
        const errs = {};
        if (!form.firstName?.trim()) errs.firstName = 'First name is required';
        if (!form.lastName?.trim()) errs.lastName = 'Last name is required';
        if (!form.email?.trim()) errs.email = 'Email is required';
        else if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(form.email)) errs.email = 'Invalid email format';
        if (!editUser && !form.password) errs.password = 'Password is required for new users';
        else if (form.password && form.password.length < 8) errs.password = 'Password must be at least 8 characters';
        setErrors(errs);
        return Object.keys(errs).length === 0;
      };

      const handleSubmit = async () => {
        if (!validate()) return;
        setLoading(true);
        try {
          const payload = { ...form };
          if (!payload.password) delete payload.password;
          if (editUser?._id) {
            await api.put('/users/' + editUser._id, payload);
          } else {
            await api.post('/users', payload);
          }
          onSave();
        } catch (e) {
          setErrors({ submit: e.message });
        } finally {
          setLoading(false);
        }
      };

      const roles = [
        { value: 'employee', label: 'Employee', desc: 'Can report incidents and view assigned items' },
        { value: 'safety_officer', label: 'Safety Officer', desc: 'Can manage incidents, inspections, and training' },
        { value: 'supervisor', label: 'Supervisor', desc: 'Can manage team safety and approve actions' },
        { value: 'manager', label: 'Manager', desc: 'Full department access and reporting' },
        { value: 'admin', label: 'Administrator', desc: 'Full system access including user management' }
      ];

      return (
        <Modal isOpen={isOpen} onClose={onClose} title={editUser ? 'Edit User' : 'Add New User'} size="lg"
          footer={
            <>
              <Button variant="secondary" onClick={onClose}>Cancel</Button>
              <Button onClick={handleSubmit} loading={loading}>{editUser ? 'Update User' : 'Create User'}</Button>
            </>
          }
        >
          {errors.submit && <div className="mb-4 p-3 bg-red-50 border border-red-200 text-red-700 rounded-xl text-sm">{errors.submit}</div>}
          <div className="space-y-5">
            <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
              <Input label="First Name *" value={form.firstName || ''} onChange={e => setForm(p => ({ ...p, firstName: e.target.value }))} error={errors.firstName} placeholder="John" />
              <Input label="Last Name *" value={form.lastName || ''} onChange={e => setForm(p => ({ ...p, lastName: e.target.value }))} error={errors.lastName} placeholder="Smith" />
            </div>
            <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
              <Input label="Email Address *" type="email" value={form.email || ''} onChange={e => setForm(p => ({ ...p, email: e.target.value }))} error={errors.email} placeholder="john@company.com" />
              <Input label="Phone" type="tel" value={form.phone || ''} onChange={e => setForm(p => ({ ...p, phone: e.target.value }))} placeholder="+1 (555) 000-0000" />
            </div>
            <Input label={editUser ? 'New Password (leave blank to keep current)' : 'Password *'} type="password" value={form.password || ''} onChange={e => setForm(p => ({ ...p, password: e.target.value }))} error={errors.password} placeholder="Min 8 characters" />
            <Input label="Department" value={form.department || ''} onChange={e => setForm(p => ({ ...p, department: e.target.value }))} placeholder="Operations, Safety, etc." />
            
            <div>
              <label className="block text-sm font-semibold text-slate-700 mb-3">User Role *</label>
              <div className="grid gap-3">
                {roles.map(r => (
                  <label key={r.value} className={'flex items-start gap-3 p-4 border-2 rounded-xl cursor-pointer transition-all ' + (form.role === r.value ? 'border-primary-500 bg-primary-50' : 'border-slate-200 hover:border-slate-300')}>
                    <input type="radio" name="role" value={r.value} checked={form.role === r.value} onChange={e => setForm(p => ({ ...p, role: e.target.value }))} className="mt-1" />
                    <div>
                      <p className="font-semibold text-slate-800">{r.label}</p>
                      <p className="text-sm text-slate-500">{r.desc}</p>
                    </div>
                  </label>
                ))}
              </div>
            </div>

            <div className="flex items-center gap-3 p-4 bg-slate-50 rounded-xl">
              <input type="checkbox" id="isActive" checked={form.isActive !== false} onChange={e => setForm(p => ({ ...p, isActive: e.target.checked }))} className="w-5 h-5 text-primary-600 rounded" />
              <label htmlFor="isActive" className="font-medium text-slate-700 cursor-pointer">User account is active</label>
            </div>
          </div>
        </Modal>
      );
    };

    // ========== USERS PAGE ==========
    const UsersPage = () => {
      const [users, setUsers] = useState([]);
      const [loading, setLoading] = useState(true);
      const [modal, setModal] = useState(false);
      const [selected, setSelected] = useState(null);
      const [search, setSearch] = useState('');
      const { addToast } = useContext(ToastContext) || {};

      const fetchUsers = useCallback(() => {
        setLoading(true);
        api.get('/users').then(d => setUsers(d.users || [])).catch(console.error).finally(() => setLoading(false));
      }, []);

      useEffect(() => { fetchUsers(); }, [fetchUsers]);

      const handleSave = () => {
        setModal(false);
        setSelected(null);
        fetchUsers();
        addToast?.('User saved successfully!', 'success');
      };

      const handleDelete = async (user) => {
        if (!confirm('Are you sure you want to delete ' + user.firstName + ' ' + user.lastName + '?')) return;
        try {
          await api.del('/users/' + user._id);
          fetchUsers();
          addToast?.('User deleted', 'success');
        } catch (e) {
          addToast?.('Failed to delete user: ' + e.message, 'error');
        }
      };

      const handleToggleActive = async (user) => {
        try {
          await api.put('/users/' + user._id, { isActive: !user.isActive });
          fetchUsers();
          addToast?.(user.isActive ? 'User deactivated' : 'User activated', 'success');
        } catch (e) {
          addToast?.('Failed to update user', 'error');
        }
      };

      const filteredUsers = users.filter(u => 
        !search || 
        (u.firstName + ' ' + u.lastName).toLowerCase().includes(search.toLowerCase()) ||
        u.email.toLowerCase().includes(search.toLowerCase()) ||
        u.role?.toLowerCase().includes(search.toLowerCase())
      );

      const roleColors = { employee: 'gray', safety_officer: 'blue', supervisor: 'cyan', manager: 'purple', admin: 'red' };

      return (
        <div className="space-y-6 slide-up">
          <div className="flex flex-col lg:flex-row lg:items-center justify-between gap-4">
            <div>
              <h2 className="text-2xl lg:text-3xl font-bold text-slate-800">Team Members</h2>
              <p className="text-slate-500">Manage users and their access permissions</p>
            </div>
            <div className="flex gap-3">
              <div className="relative">
                <input type="text" placeholder="Search users..." value={search} onChange={e => setSearch(e.target.value)} className="pl-10 pr-4 py-2.5 bg-white border-2 border-slate-200 rounded-xl focus:border-primary-500 w-full sm:w-64" />
                <div className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400"><Icons.Search /></div>
              </div>
              <Button onClick={() => { setSelected(null); setModal(true); }} icon={<Icons.Plus />}>Add User</Button>
            </div>
          </div>

          <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
            <StatCard title="Total Users" value={users.length} icon={<Icons.Users />} color="blue" />
            <StatCard title="Admins" value={users.filter(u => u.role === 'admin').length} icon={<Icons.Settings />} color="purple" />
            <StatCard title="Active" value={users.filter(u => u.isActive).length} icon={<Icons.Check />} color="green" />
            <StatCard title="Inactive" value={users.filter(u => !u.isActive).length} icon={<Icons.X />} color="gray" />
          </div>

          <Card noPadding>
            {loading ? (
              <div className="flex justify-center py-16"><Spinner size="lg" /></div>
            ) : filteredUsers.length === 0 ? (
              <EmptyState title="No users found" description={search ? 'Try a different search term' : 'Add your first team member to get started'} action={<Button onClick={() => setModal(true)} icon={<Icons.Plus />}>Add User</Button>} />
            ) : (
              <div className="divide-y divide-slate-100">
                {filteredUsers.map(user => (
                  <div key={user._id} className="flex items-center justify-between p-4 hover:bg-slate-50 transition-colors">
                    <div className="flex items-center gap-4">
                      <div className={'w-12 h-12 rounded-full flex items-center justify-center font-bold text-white ' + (user.isActive ? 'bg-gradient-to-br from-primary-400 to-primary-600' : 'bg-slate-400')}>
                        {user.firstName?.[0]}{user.lastName?.[0]}
                      </div>
                      <div>
                        <p className="font-semibold text-slate-800">{user.firstName} {user.lastName}</p>
                        <p className="text-sm text-slate-500">{user.email}</p>
                        {user.department && <p className="text-xs text-slate-400">{user.department}</p>}
                      </div>
                    </div>
                    <div className="flex items-center gap-3">
                      <Badge color={roleColors[user.role] || 'gray'}>{user.role?.replace('_', ' ')}</Badge>
                      <Badge color={user.isActive ? 'green' : 'gray'}>{user.isActive ? 'Active' : 'Inactive'}</Badge>
                      <div className="flex gap-1">
                        <button onClick={() => { setSelected(user); setModal(true); }} className="p-2 hover:bg-primary-100 rounded-lg text-slate-500 hover:text-primary-600 transition-colors" title="Edit"><Icons.Edit /></button>
                        <button onClick={() => handleToggleActive(user)} className="p-2 hover:bg-slate-100 rounded-lg text-slate-500 hover:text-slate-700 transition-colors" title={user.isActive ? 'Deactivate' : 'Activate'}>{user.isActive ? <Icons.X /> : <Icons.Check />}</button>
                        <button onClick={() => handleDelete(user)} className="p-2 hover:bg-red-100 rounded-lg text-slate-500 hover:text-red-600 transition-colors" title="Delete"><Icons.Trash /></button>
                      </div>
                    </div>
                  </div>
                ))}
              </div>
            )}
          </Card>

          <UserModal isOpen={modal} onClose={() => { setModal(false); setSelected(null); }} user={selected} onSave={handleSave} />
        </div>
      );
    };

    // ========== CUSTOM FORM BUILDER ==========
    const FormBuilderPage = () => {
      const [forms, setForms] = useState([]);
      const [loading, setLoading] = useState(true);
      const [builderOpen, setBuilderOpen] = useState(false);
      const [selectedForm, setSelectedForm] = useState(null);
      const { addToast } = useContext(ToastContext) || {};

      useEffect(() => { fetchForms(); }, []);

      const fetchForms = async () => {
        setLoading(true);
        try {
          const data = await api.get('/incident-forms');
          setForms(data.forms || []);
        } catch (e) {
          console.error(e);
          // Demo data
          setForms([
            { _id: '1', name: 'Standard Incident Report', description: 'Default incident reporting form', status: 'active', incidentTypes: ['injury', 'illness'], isDefault: true, version: 1, createdAt: new Date() },
            { _id: '2', name: 'Vehicle Accident Form', description: 'Specific form for vehicle incidents', status: 'active', incidentTypes: ['vehicle'], isDefault: false, version: 2, createdAt: new Date() }
          ]);
        }
        setLoading(false);
      };

      const handleDelete = async (id) => {
        if (!confirm('Delete this form?')) return;
        try {
          await api.del('/incident-forms/' + id);
          addToast?.('Form deleted', 'success');
          fetchForms();
        } catch (e) { addToast?.('Delete failed', 'error'); }
      };

      const statusColors = { draft: 'gray', active: 'green', inactive: 'yellow', archived: 'red' };

      return (
        <div className="space-y-6 slide-up">
          <div className="flex flex-col lg:flex-row lg:items-center justify-between gap-4">
            <div>
              <h2 className="text-2xl lg:text-3xl font-bold text-slate-800">Custom Form Builder</h2>
              <p className="text-slate-500">Create and manage custom incident reporting forms</p>
            </div>
            <Button onClick={() => { setSelectedForm(null); setBuilderOpen(true); }} icon={<Icons.Plus />}>Create New Form</Button>
          </div>

          <Card noPadding>
            {loading ? (
              <div className="flex justify-center py-16"><Spinner size="lg" /></div>
            ) : forms.length === 0 ? (
              <EmptyState title="No custom forms" description="Create your first custom incident form" icon={<Icons.Document />} />
            ) : (
              <div className="divide-y divide-slate-100">
                {forms.map(form => (
                  <div key={form._id} className="flex items-center justify-between p-4 hover:bg-slate-50 transition-colors">
                    <div className="flex items-center gap-4">
                      <div className="w-12 h-12 bg-primary-100 text-primary-600 rounded-xl flex items-center justify-center">
                        <Icons.Document />
                      </div>
                      <div>
                        <div className="flex items-center gap-2">
                          <p className="font-semibold text-slate-800">{form.name}</p>
                          {form.isDefault && <Badge color="purple" size="sm">Default</Badge>}
                        </div>
                        <p className="text-sm text-slate-500">{form.description || 'No description'}</p>
                        <div className="flex gap-2 mt-1">
                          {(form.incidentTypes || []).slice(0, 3).map(t => (
                            <Badge key={t} color="blue" size="sm">{t.replace(/_/g, ' ')}</Badge>
                          ))}
                          {(form.incidentTypes || []).length > 3 && <Badge color="gray" size="sm">+{form.incidentTypes.length - 3}</Badge>}
                        </div>
                      </div>
                    </div>
                    <div className="flex items-center gap-3">
                      <Badge color={statusColors[form.status] || 'gray'}>{form.status}</Badge>
                      <span className="text-sm text-slate-500">v{form.version || 1}</span>
                      <button onClick={() => { setSelectedForm(form); setBuilderOpen(true); }} className="p-2 hover:bg-primary-100 rounded-lg text-slate-500 hover:text-primary-600"><Icons.Edit /></button>
                      <button onClick={() => handleDelete(form._id)} className="p-2 hover:bg-red-100 rounded-lg text-slate-500 hover:text-red-600"><Icons.Trash /></button>
                    </div>
                  </div>
                ))}
              </div>
            )}
          </Card>

          {builderOpen && <FormBuilder isOpen={builderOpen} onClose={() => { setBuilderOpen(false); setSelectedForm(null); }} form={selectedForm} onSave={() => { setBuilderOpen(false); fetchForms(); addToast?.('Form saved', 'success'); }} />}
        </div>
      );
    };

    // ========== FORM BUILDER MODAL ==========
    const FormBuilder = ({ isOpen, onClose, form, onSave }) => {
      const [formData, setFormData] = useState({
        name: '', description: '', status: 'draft', incidentTypes: [], isDefault: false, sections: [], settings: {}
      });
      const [activeSection, setActiveSection] = useState(0);
      const [activeField, setActiveField] = useState(null);
      const [tab, setTab] = useState('design');
      const [saving, setSaving] = useState(false);
      const [draggedField, setDraggedField] = useState(null);

      useEffect(() => {
        if (form) {
          setFormData({ ...form, sections: form.sections || [{ name: 'Main Section', order: 0, fields: [] }] });
        } else {
          setFormData({
            name: '', description: '', status: 'draft', incidentTypes: [], isDefault: false,
            sections: [{ name: 'Main Section', description: '', order: 0, collapsible: false, fields: [] }],
            settings: { allowDraft: true, allowEdit: true, requireApproval: false }
          });
        }
        setActiveSection(0);
        setActiveField(null);
      }, [form, isOpen]);

      const fieldTypes = [
        { type: 'text', label: 'Text Input', icon: 'T' },
        { type: 'textarea', label: 'Text Area', icon: '¬∂' },
        { type: 'number', label: 'Number', icon: '#' },
        { type: 'date', label: 'Date', icon: 'üìÖ' },
        { type: 'time', label: 'Time', icon: 'üïê' },
        { type: 'datetime', label: 'Date & Time', icon: 'üìÜ' },
        { type: 'select', label: 'Dropdown', icon: '‚ñº' },
        { type: 'multiselect', label: 'Multi-Select', icon: '‚òë' },
        { type: 'radio', label: 'Radio Buttons', icon: '‚óâ' },
        { type: 'checkbox', label: 'Checkbox', icon: '‚òë' },
        { type: 'checkboxgroup', label: 'Checkbox Group', icon: '‚òë‚òë' },
        { type: 'file', label: 'File Upload', icon: 'üìé' },
        { type: 'image', label: 'Image Upload', icon: 'üñº' },
        { type: 'signature', label: 'Signature', icon: '‚úç' },
        { type: 'email', label: 'Email', icon: '@' },
        { type: 'phone', label: 'Phone', icon: 'üìû' },
        { type: 'location', label: 'Location', icon: 'üìç' },
        { type: 'user_lookup', label: 'User Lookup', icon: 'üë§' },
        { type: 'employee_lookup', label: 'Employee Lookup', icon: 'üë•' },
        { type: 'equipment_lookup', label: 'Equipment Lookup', icon: '‚öô' },
        { type: 'rating', label: 'Rating', icon: '‚≠ê' },
        { type: 'scale', label: 'Scale (1-10)', icon: 'üìä' },
        { type: 'header', label: 'Header', icon: 'H' },
        { type: 'divider', label: 'Divider', icon: '‚Äî' },
        { type: 'instructions', label: 'Instructions', icon: '‚Ñπ' }
      ];

      const incidentTypes = ['injury', 'illness', 'near_miss', 'first_aid', 'property_damage', 'environmental', 'security', 'vehicle', 'fire', 'chemical_exposure', 'ergonomic', 'slip_trip_fall', 'struck_by', 'caught_in', 'electrical', 'other'];

      const addSection = () => {
        setFormData(prev => ({
          ...prev,
          sections: [...prev.sections, { name: 'New Section', description: '', order: prev.sections.length, collapsible: true, fields: [] }]
        }));
        setActiveSection(formData.sections.length);
      };

      const updateSection = (index, field, value) => {
        setFormData(prev => {
          const sections = [...prev.sections];
          sections[index] = { ...sections[index], [field]: value };
          return { ...prev, sections };
        });
      };

      const removeSection = (index) => {
        if (formData.sections.length <= 1) return;
        setFormData(prev => ({
          ...prev,
          sections: prev.sections.filter((_, i) => i !== index)
        }));
        if (activeSection >= index && activeSection > 0) setActiveSection(activeSection - 1);
      };

      const addField = (type) => {
        const newField = {
          fieldId: 'field_' + Date.now(),
          label: fieldTypes.find(f => f.type === type)?.label || 'New Field',
          type,
          placeholder: '',
          helpText: '',
          required: false,
          width: 'full',
          order: (formData.sections[activeSection]?.fields || []).length,
          options: ['select', 'multiselect', 'radio', 'checkboxgroup'].includes(type) ? [{ value: 'option1', label: 'Option 1', order: 0 }] : [],
          validation: {}
        };
        setFormData(prev => {
          const sections = [...prev.sections];
          sections[activeSection] = {
            ...sections[activeSection],
            fields: [...(sections[activeSection].fields || []), newField]
          };
          return { ...prev, sections };
        });
        setActiveField(newField.fieldId);
      };

      const updateField = (fieldId, updates) => {
        setFormData(prev => {
          const sections = [...prev.sections];
          sections[activeSection] = {
            ...sections[activeSection],
            fields: sections[activeSection].fields.map(f => f.fieldId === fieldId ? { ...f, ...updates } : f)
          };
          return { ...prev, sections };
        });
      };

      const removeField = (fieldId) => {
        setFormData(prev => {
          const sections = [...prev.sections];
          sections[activeSection] = {
            ...sections[activeSection],
            fields: sections[activeSection].fields.filter(f => f.fieldId !== fieldId)
          };
          return { ...prev, sections };
        });
        setActiveField(null);
      };

      const moveField = (fieldId, direction) => {
        setFormData(prev => {
          const sections = [...prev.sections];
          const fields = [...sections[activeSection].fields];
          const idx = fields.findIndex(f => f.fieldId === fieldId);
          if ((direction === 'up' && idx === 0) || (direction === 'down' && idx === fields.length - 1)) return prev;
          const newIdx = direction === 'up' ? idx - 1 : idx + 1;
          [fields[idx], fields[newIdx]] = [fields[newIdx], fields[idx]];
          sections[activeSection] = { ...sections[activeSection], fields };
          return { ...prev, sections };
        });
      };

      const handleSave = async () => {
        if (!formData.name) return;
        setSaving(true);
        try {
          if (form?._id) {
            await api.put('/incident-forms/' + form._id, formData);
          } else {
            await api.post('/incident-forms', formData);
          }
          onSave();
        } catch (e) { console.error(e); }
        setSaving(false);
      };

      const currentSection = formData.sections[activeSection] || { fields: [] };
      const currentField = currentSection.fields?.find(f => f.fieldId === activeField);

      if (!isOpen) return null;

      return (
        <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
          <div className="bg-white rounded-2xl w-full max-w-7xl h-[90vh] flex flex-col overflow-hidden shadow-2xl">
            {/* Header */}
            <div className="flex items-center justify-between px-6 py-4 border-b border-slate-200 bg-slate-50">
              <div className="flex items-center gap-4">
                <h2 className="text-xl font-bold text-slate-800">{form ? 'Edit Form' : 'Create New Form'}</h2>
                <Badge color={formData.status === 'active' ? 'green' : 'gray'}>{formData.status}</Badge>
              </div>
              <div className="flex items-center gap-3">
                <Button variant="secondary" onClick={onClose}>Cancel</Button>
                <Button onClick={handleSave} loading={saving}>Save Form</Button>
              </div>
            </div>

            {/* Tabs */}
            <div className="flex gap-2 px-6 py-3 border-b border-slate-200">
              {['design', 'settings', 'preview'].map(t => (
                <button key={t} onClick={() => setTab(t)} 
                  className={`px-4 py-2 text-sm font-medium rounded-lg capitalize ${tab === t ? 'bg-primary-100 text-primary-700' : 'text-slate-600 hover:bg-slate-100'}`}>
                  {t}
                </button>
              ))}
            </div>

            <div className="flex-1 flex overflow-hidden">
              {/* DESIGN TAB */}
              {tab === 'design' && (
                <>
                  {/* Left Panel - Field Types */}
                  <div className="w-56 border-r border-slate-200 bg-slate-50 overflow-y-auto p-3">
                    <h3 className="font-semibold text-slate-700 mb-3 px-2">Add Fields</h3>
                    <div className="space-y-1">
                      {fieldTypes.map(ft => (
                        <button key={ft.type} onClick={() => addField(ft.type)} 
                          className="w-full flex items-center gap-2 px-3 py-2 text-sm text-slate-700 hover:bg-white hover:shadow-sm rounded-lg transition-all text-left">
                          <span className="w-6 text-center">{ft.icon}</span>
                          <span>{ft.label}</span>
                        </button>
                      ))}
                    </div>
                  </div>

                  {/* Center - Form Canvas */}
                  <div className="flex-1 overflow-y-auto p-6 bg-slate-100">
                    {/* Form Info */}
                    <div className="bg-white rounded-xl p-4 mb-4 shadow-sm">
                      <div className="grid grid-cols-2 gap-4">
                        <Input label="Form Name *" value={formData.name} onChange={e => setFormData(p => ({ ...p, name: e.target.value }))} placeholder="e.g., Vehicle Accident Report" />
                        <Select label="Status" value={formData.status} onChange={e => setFormData(p => ({ ...p, status: e.target.value }))} options={[
                          { value: 'draft', label: 'Draft' }, { value: 'active', label: 'Active' }, { value: 'inactive', label: 'Inactive' }, { value: 'archived', label: 'Archived' }
                        ]} />
                      </div>
                      <Textarea label="Description" value={formData.description} onChange={e => setFormData(p => ({ ...p, description: e.target.value }))} rows={2} className="mt-4" />
                      <div className="mt-4">
                        <label className="block text-sm font-medium text-slate-700 mb-2">Incident Types (apply to)</label>
                        <div className="flex flex-wrap gap-2">
                          {incidentTypes.map(t => (
                            <label key={t} className={`px-3 py-1.5 rounded-full text-sm cursor-pointer border-2 transition-colors ${formData.incidentTypes?.includes(t) ? 'bg-primary-100 border-primary-500 text-primary-700' : 'bg-white border-slate-200 text-slate-600 hover:border-slate-300'}`}>
                              <input type="checkbox" className="hidden" checked={formData.incidentTypes?.includes(t)} onChange={e => {
                                if (e.target.checked) {
                                  setFormData(p => ({ ...p, incidentTypes: [...(p.incidentTypes || []), t] }));
                                } else {
                                  setFormData(p => ({ ...p, incidentTypes: (p.incidentTypes || []).filter(x => x !== t) }));
                                }
                              }} />
                              {t.replace(/_/g, ' ')}
                            </label>
                          ))}
                        </div>
                      </div>
                    </div>

                    {/* Sections Tabs */}
                    <div className="flex items-center gap-2 mb-4 overflow-x-auto pb-2">
                      {formData.sections.map((section, i) => (
                        <button key={i} onClick={() => { setActiveSection(i); setActiveField(null); }}
                          className={`flex items-center gap-2 px-4 py-2 rounded-lg text-sm font-medium whitespace-nowrap ${activeSection === i ? 'bg-primary-500 text-white shadow-lg' : 'bg-white text-slate-600 hover:bg-slate-50'}`}>
                          {section.name}
                          {formData.sections.length > 1 && (
                            <span onClick={(e) => { e.stopPropagation(); removeSection(i); }} className="ml-1 hover:text-red-300">√ó</span>
                          )}
                        </button>
                      ))}
                      <button onClick={addSection} className="px-3 py-2 rounded-lg text-sm font-medium bg-white text-primary-600 hover:bg-primary-50 border-2 border-dashed border-primary-300">
                        + Add Section
                      </button>
                    </div>

                    {/* Section Settings */}
                    <div className="bg-white rounded-xl p-4 mb-4 shadow-sm">
                      <div className="grid grid-cols-3 gap-4">
                        <Input label="Section Name" value={currentSection.name || ''} onChange={e => updateSection(activeSection, 'name', e.target.value)} />
                        <Input label="Description" value={currentSection.description || ''} onChange={e => updateSection(activeSection, 'description', e.target.value)} />
                        <div className="flex items-center pt-6">
                          <Checkbox label="Collapsible" checked={currentSection.collapsible || false} onChange={e => updateSection(activeSection, 'collapsible', e.target.checked)} />
                        </div>
                      </div>
                    </div>

                    {/* Fields */}
                    <div className="bg-white rounded-xl p-4 shadow-sm min-h-64">
                      <h4 className="font-semibold text-slate-700 mb-4">Fields ({currentSection.fields?.length || 0})</h4>
                      {(!currentSection.fields || currentSection.fields.length === 0) ? (
                        <div className="border-2 border-dashed border-slate-300 rounded-xl p-8 text-center text-slate-500">
                          <p className="mb-2">No fields yet</p>
                          <p className="text-sm">Click a field type on the left to add it here</p>
                        </div>
                      ) : (
                        <div className="space-y-2">
                          {currentSection.fields.map((field, idx) => (
                            <div key={field.fieldId} onClick={() => setActiveField(field.fieldId)}
                              className={`flex items-center gap-3 p-3 rounded-xl border-2 cursor-pointer transition-all ${activeField === field.fieldId ? 'border-primary-500 bg-primary-50' : 'border-slate-200 hover:border-slate-300 bg-white'}`}>
                              <div className="flex flex-col gap-1">
                                <button onClick={(e) => { e.stopPropagation(); moveField(field.fieldId, 'up'); }} disabled={idx === 0} className="text-slate-400 hover:text-slate-600 disabled:opacity-30">‚ñ≤</button>
                                <button onClick={(e) => { e.stopPropagation(); moveField(field.fieldId, 'down'); }} disabled={idx === currentSection.fields.length - 1} className="text-slate-400 hover:text-slate-600 disabled:opacity-30">‚ñº</button>
                              </div>
                              <div className="w-10 h-10 bg-slate-100 rounded-lg flex items-center justify-center text-lg">
                                {fieldTypes.find(f => f.type === field.type)?.icon || '?'}
                              </div>
                              <div className="flex-1 min-w-0">
                                <p className="font-medium text-slate-800 truncate">{field.label}</p>
                                <p className="text-sm text-slate-500">{field.type} {field.required && <span className="text-red-500">*</span>}</p>
                              </div>
                              <Badge color="gray" size="sm">{field.width}</Badge>
                              <button onClick={(e) => { e.stopPropagation(); removeField(field.fieldId); }} className="p-2 hover:bg-red-100 rounded-lg text-slate-400 hover:text-red-600"><Icons.Trash /></button>
                            </div>
                          ))}
                        </div>
                      )}
                    </div>
                  </div>

                  {/* Right Panel - Field Properties */}
                  <div className="w-72 border-l border-slate-200 bg-white overflow-y-auto p-4">
                    {currentField ? (
                      <>
                        <h3 className="font-semibold text-slate-800 mb-4">Field Properties</h3>
                        <div className="space-y-4">
                          <Input label="Label *" value={currentField.label} onChange={e => updateField(activeField, { label: e.target.value })} />
                          <Input label="Placeholder" value={currentField.placeholder || ''} onChange={e => updateField(activeField, { placeholder: e.target.value })} />
                          <Textarea label="Help Text" value={currentField.helpText || ''} onChange={e => updateField(activeField, { helpText: e.target.value })} rows={2} />
                          <Select label="Width" value={currentField.width || 'full'} onChange={e => updateField(activeField, { width: e.target.value })} options={[
                            { value: 'full', label: 'Full Width' }, { value: 'half', label: 'Half Width' }, { value: 'third', label: 'Third Width' }, { value: 'quarter', label: 'Quarter Width' }
                          ]} />
                          <div className="space-y-2">
                            <Checkbox label="Required" checked={currentField.required || false} onChange={e => updateField(activeField, { required: e.target.checked })} />
                            <Checkbox label="Read Only" checked={currentField.readOnly || false} onChange={e => updateField(activeField, { readOnly: e.target.checked })} />
                            <Checkbox label="Hidden" checked={currentField.hidden || false} onChange={e => updateField(activeField, { hidden: e.target.checked })} />
                          </div>

                          {/* Options for select/radio/checkbox */}
                          {['select', 'multiselect', 'radio', 'checkboxgroup'].includes(currentField.type) && (
                            <div>
                              <label className="block text-sm font-medium text-slate-700 mb-2">Options</label>
                              <div className="space-y-2">
                                {(currentField.options || []).map((opt, i) => (
                                  <div key={i} className="flex gap-2">
                                    <input type="text" value={opt.label} onChange={e => {
                                      const options = [...(currentField.options || [])];
                                      options[i] = { ...options[i], label: e.target.value, value: e.target.value.toLowerCase().replace(/\s+/g, '_') };
                                      updateField(activeField, { options });
                                    }} className="flex-1 px-2 py-1 border border-slate-300 rounded-lg text-sm" />
                                    <button onClick={() => {
                                      const options = (currentField.options || []).filter((_, idx) => idx !== i);
                                      updateField(activeField, { options });
                                    }} className="text-red-500 hover:text-red-700">√ó</button>
                                  </div>
                                ))}
                                <button onClick={() => {
                                  const options = [...(currentField.options || []), { value: 'option' + ((currentField.options?.length || 0) + 1), label: 'Option ' + ((currentField.options?.length || 0) + 1), order: (currentField.options?.length || 0) }];
                                  updateField(activeField, { options });
                                }} className="text-sm text-primary-600 hover:text-primary-700">+ Add Option</button>
                              </div>
                            </div>
                          )}

                          {/* Validation */}
                          <div className="pt-4 border-t border-slate-200">
                            <h4 className="font-medium text-slate-700 mb-3">Validation</h4>
                            {['text', 'textarea', 'email', 'phone'].includes(currentField.type) && (
                              <div className="grid grid-cols-2 gap-2">
                                <Input label="Min Length" type="number" value={currentField.validation?.minLength || ''} onChange={e => updateField(activeField, { validation: { ...currentField.validation, minLength: parseInt(e.target.value) || null } })} />
                                <Input label="Max Length" type="number" value={currentField.validation?.maxLength || ''} onChange={e => updateField(activeField, { validation: { ...currentField.validation, maxLength: parseInt(e.target.value) || null } })} />
                              </div>
                            )}
                            {['number', 'scale', 'rating'].includes(currentField.type) && (
                              <div className="grid grid-cols-2 gap-2">
                                <Input label="Min Value" type="number" value={currentField.validation?.min || ''} onChange={e => updateField(activeField, { validation: { ...currentField.validation, min: parseInt(e.target.value) || null } })} />
                                <Input label="Max Value" type="number" value={currentField.validation?.max || ''} onChange={e => updateField(activeField, { validation: { ...currentField.validation, max: parseInt(e.target.value) || null } })} />
                              </div>
                            )}
                          </div>

                          {/* Map to Core Field */}
                          <div className="pt-4 border-t border-slate-200">
                            <Select label="Map to Core Field" value={currentField.mapsToField || ''} onChange={e => updateField(activeField, { mapsToField: e.target.value })} options={[
                              { value: '', label: 'None (custom data)' },
                              { value: 'title', label: 'Incident Title' },
                              { value: 'description', label: 'Description' },
                              { value: 'location.site', label: 'Location - Site' },
                              { value: 'location.department', label: 'Location - Department' },
                              { value: 'location.specificLocation', label: 'Location - Specific' },
                              { value: 'environmentalConditions.weather', label: 'Weather' },
                              { value: 'environmentalConditions.lighting', label: 'Lighting' }
                            ]} />
                            <p className="text-xs text-slate-500 mt-1">Map this field to a core incident field</p>
                          </div>
                        </div>
                      </>
                    ) : (
                      <div className="text-center text-slate-500 py-12">
                        <Icons.Settings />
                        <p className="mt-2">Select a field to edit its properties</p>
                      </div>
                    )}
                  </div>
                </>
              )}

              {/* SETTINGS TAB */}
              {tab === 'settings' && (
                <div className="flex-1 overflow-y-auto p-6">
                  <div className="max-w-2xl mx-auto space-y-6">
                    <Card title="Form Behavior">
                      <div className="space-y-4">
                        <Checkbox label="Allow saving as draft" checked={formData.settings?.allowDraft !== false} onChange={e => setFormData(p => ({ ...p, settings: { ...p.settings, allowDraft: e.target.checked } }))} />
                        <Checkbox label="Allow editing after submission" checked={formData.settings?.allowEdit !== false} onChange={e => setFormData(p => ({ ...p, settings: { ...p.settings, allowEdit: e.target.checked } }))} />
                        {formData.settings?.allowEdit && (
                          <Input label="Edit time limit (hours)" type="number" value={formData.settings?.editTimeLimit || ''} onChange={e => setFormData(p => ({ ...p, settings: { ...p.settings, editTimeLimit: parseInt(e.target.value) || null } }))} placeholder="Leave empty for no limit" className="ml-6 w-48" />
                        )}
                        <Checkbox label="Require signature" checked={formData.settings?.requireSignature || false} onChange={e => setFormData(p => ({ ...p, settings: { ...p.settings, requireSignature: e.target.checked } }))} />
                        <Checkbox label="Require witness" checked={formData.settings?.requireWitness || false} onChange={e => setFormData(p => ({ ...p, settings: { ...p.settings, requireWitness: e.target.checked } }))} />
                      </div>
                    </Card>

                    <Card title="Approval Workflow">
                      <div className="space-y-4">
                        <Checkbox label="Require approval before closing" checked={formData.settings?.requireApproval || false} onChange={e => setFormData(p => ({ ...p, settings: { ...p.settings, requireApproval: e.target.checked } }))} />
                      </div>
                    </Card>

                    <Card title="Auto-Assignment">
                      <div className="space-y-4">
                        <Checkbox label="Enable auto-assignment" checked={formData.settings?.autoAssign?.enabled || false} onChange={e => setFormData(p => ({ ...p, settings: { ...p.settings, autoAssign: { ...p.settings?.autoAssign, enabled: e.target.checked } } }))} />
                        {formData.settings?.autoAssign?.enabled && (
                          <Select label="Assign to" value={formData.settings?.autoAssign?.assignTo || 'supervisor'} onChange={e => setFormData(p => ({ ...p, settings: { ...p.settings, autoAssign: { ...p.settings?.autoAssign, assignTo: e.target.value } } }))} options={[
                            { value: 'supervisor', label: 'Reporter\'s Supervisor' },
                            { value: 'safety_manager', label: 'Safety Manager' },
                            { value: 'specific_user', label: 'Specific User' },
                            { value: 'round_robin', label: 'Round Robin' }
                          ]} className="ml-6 w-64" />
                        )}
                      </div>
                    </Card>

                    <Card title="Default Form">
                      <Checkbox label="Set as default form for selected incident types" checked={formData.isDefault || false} onChange={e => setFormData(p => ({ ...p, isDefault: e.target.checked }))} />
                      <p className="text-sm text-slate-500 mt-2">If enabled, this form will be automatically used when creating incidents of the selected types.</p>
                    </Card>
                  </div>
                </div>
              )}

              {/* PREVIEW TAB */}
              {tab === 'preview' && (
                <div className="flex-1 overflow-y-auto p-6 bg-slate-100">
                  <div className="max-w-3xl mx-auto">
                    <div className="bg-white rounded-2xl shadow-lg overflow-hidden">
                      <div className="bg-primary-600 text-white px-6 py-4">
                        <h3 className="text-xl font-bold">{formData.name || 'Untitled Form'}</h3>
                        {formData.description && <p className="text-primary-100 mt-1">{formData.description}</p>}
                      </div>
                      <div className="p-6 space-y-6">
                        {formData.sections.map((section, sIdx) => (
                          <div key={sIdx} className={section.collapsible ? 'border border-slate-200 rounded-xl overflow-hidden' : ''}>
                            {(section.name || section.description) && (
                              <div className={section.collapsible ? 'bg-slate-50 px-4 py-3 border-b border-slate-200' : 'mb-4'}>
                                <h4 className="font-semibold text-slate-800">{section.name}</h4>
                                {section.description && <p className="text-sm text-slate-500">{section.description}</p>}
                              </div>
                            )}
                            <div className={section.collapsible ? 'p-4' : ''}>
                              <div className="grid grid-cols-12 gap-4">
                                {(section.fields || []).filter(f => !f.hidden).map(field => {
                                  const widthClass = { full: 'col-span-12', half: 'col-span-6', third: 'col-span-4', quarter: 'col-span-3' }[field.width] || 'col-span-12';
                                  return (
                                    <div key={field.fieldId} className={widthClass}>
                                      {field.type === 'header' ? (
                                        <h5 className="font-semibold text-lg text-slate-800 border-b border-slate-200 pb-2">{field.label}</h5>
                                      ) : field.type === 'divider' ? (
                                        <hr className="border-slate-200" />
                                      ) : field.type === 'instructions' ? (
                                        <div className="p-3 bg-blue-50 rounded-lg text-sm text-blue-700">{field.label}</div>
                                      ) : (
                                        <>
                                          <label className="block text-sm font-medium text-slate-700 mb-1">
                                            {field.label} {field.required && <span className="text-red-500">*</span>}
                                          </label>
                                          {['text', 'email', 'phone', 'number'].includes(field.type) && (
                                            <input type={field.type === 'number' ? 'number' : 'text'} placeholder={field.placeholder} disabled={field.readOnly} className="w-full px-3 py-2 border border-slate-300 rounded-lg bg-white" />
                                          )}
                                          {field.type === 'textarea' && (
                                            <textarea placeholder={field.placeholder} rows={3} disabled={field.readOnly} className="w-full px-3 py-2 border border-slate-300 rounded-lg bg-white" />
                                          )}
                                          {['date', 'time', 'datetime'].includes(field.type) && (
                                            <input type={field.type === 'datetime' ? 'datetime-local' : field.type} disabled={field.readOnly} className="w-full px-3 py-2 border border-slate-300 rounded-lg bg-white" />
                                          )}
                                          {field.type === 'select' && (
                                            <select disabled={field.readOnly} className="w-full px-3 py-2 border border-slate-300 rounded-lg bg-white">
                                              <option value="">Select...</option>
                                              {(field.options || []).map(opt => <option key={opt.value} value={opt.value}>{opt.label}</option>)}
                                            </select>
                                          )}
                                          {field.type === 'radio' && (
                                            <div className="space-y-2">
                                              {(field.options || []).map(opt => (
                                                <label key={opt.value} className="flex items-center gap-2">
                                                  <input type="radio" name={field.fieldId} value={opt.value} disabled={field.readOnly} />
                                                  <span>{opt.label}</span>
                                                </label>
                                              ))}
                                            </div>
                                          )}
                                          {field.type === 'checkbox' && (
                                            <label className="flex items-center gap-2">
                                              <input type="checkbox" disabled={field.readOnly} />
                                              <span className="text-slate-600">{field.placeholder || 'Yes'}</span>
                                            </label>
                                          )}
                                          {field.type === 'checkboxgroup' && (
                                            <div className="space-y-2">
                                              {(field.options || []).map(opt => (
                                                <label key={opt.value} className="flex items-center gap-2">
                                                  <input type="checkbox" value={opt.value} disabled={field.readOnly} />
                                                  <span>{opt.label}</span>
                                                </label>
                                              ))}
                                            </div>
                                          )}
                                          {field.type === 'file' && (
                                            <input type="file" disabled={field.readOnly} className="w-full px-3 py-2 border border-slate-300 rounded-lg bg-white" />
                                          )}
                                          {field.type === 'signature' && (
                                            <div className="h-24 border-2 border-dashed border-slate-300 rounded-lg flex items-center justify-center text-slate-400">
                                              Click to sign
                                            </div>
                                          )}
                                          {field.type === 'rating' && (
                                            <div className="flex gap-1">
                                              {[1,2,3,4,5].map(n => <span key={n} className="text-2xl cursor-pointer text-slate-300 hover:text-yellow-400">‚òÖ</span>)}
                                            </div>
                                          )}
                                          {field.type === 'scale' && (
                                            <input type="range" min={field.validation?.min || 1} max={field.validation?.max || 10} className="w-full" />
                                          )}
                                          {field.helpText && <p className="text-xs text-slate-500 mt-1">{field.helpText}</p>}
                                        </>
                                      )}
                                    </div>
                                  );
                                })}
                              </div>
                            </div>
                          </div>
                        ))}
                        <div className="flex justify-end gap-3 pt-4 border-t border-slate-200">
                          <Button variant="secondary">Save Draft</Button>
                          <Button>Submit</Button>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              )}
            </div>
          </div>
        </div>
      );
    };

    // ========== AUDIT PAGE ==========
    const AuditPage = () => {
      const [logs, setLogs] = useState([]);
      const [loading, setLoading] = useState(true);
      useEffect(() => { api.get('/audit-logs').then(d => setLogs(d.logs || [])).catch(console.error).finally(() => setLoading(false)); }, []);
      
      return (
        <div className="space-y-6 slide-up">
          <div className="flex flex-col lg:flex-row lg:items-center justify-between gap-4">
            <div>
              <h2 className="text-2xl lg:text-3xl font-bold text-slate-800">Audit Logs</h2>
              <p className="text-slate-500">Complete activity history and compliance trail</p>
            </div>
            <Button variant="secondary" icon={<Icons.Download />} onClick={() => window.open(API + '/audit-logs/export?format=xlsx', '_blank')}>Export Logs</Button>
          </div>
          <Card noPadding icon={<Icons.Audit />}>
            <Table 
              columns={[
                { header: 'Timestamp', render: r => <span className="text-slate-600 text-sm font-mono">{new Date(r.timestamp).toLocaleString()}</span> },
                { header: 'User', render: r => r.user ? r.user.firstName + ' ' + r.user.lastName : 'System' },
                { header: 'Action', render: r => <Badge color="blue">{r.action}</Badge> },
                { header: 'Module', render: r => <Badge color="gray">{r.module}</Badge> },
                { header: 'Entity', accessor: 'entityName' },
              ]} 
              data={logs} 
              loading={loading} 
            />
          </Card>
        </div>
      );
    };

    // ========== REPORTS PAGE ==========
    const ReportsPage = () => {
      const [type, setType] = useState('incidents');
      const [data, setData] = useState(null);
      const [loading, setLoading] = useState(false);
      
      const generate = async () => { 
        setLoading(true); 
        try { const d = await api.get('/reports/' + type); setData(d.report); } 
        catch (e) { console.error(e); } 
        finally { setLoading(false); } 
      };
      
      return (
        <div className="space-y-6 slide-up">
          <div>
            <h2 className="text-2xl lg:text-3xl font-bold text-slate-800">Reports</h2>
            <p className="text-slate-500">Generate and export safety reports</p>
          </div>
          <Card icon={<Icons.Reports />}>
            <div className="flex flex-wrap gap-4 items-end">
              <Select label="Report Type" value={type} onChange={e => setType(e.target.value)} options={[
                { value: 'incidents', label: 'Incidents Report' }, 
                { value: 'action-items', label: 'Action Items Report' }, 
                { value: 'training', label: 'Training Report' }, 
                { value: 'inspections', label: 'Inspections Report' }
              ]} className="w-64" />
              <Button onClick={generate} loading={loading}>Generate Report</Button>
              <Button variant="secondary" icon={<Icons.Download />} onClick={() => window.open(API + '/reports/' + type + '?format=xlsx', '_blank')}>Export Excel</Button>
            </div>
            {data && (
              <div className="mt-6 p-4 bg-slate-50 rounded-xl border border-slate-200">
                <pre className="overflow-auto max-h-96 text-xs text-slate-600">{JSON.stringify(data, null, 2)}</pre>
              </div>
            )}
          </Card>
        </div>
      );
    };

    // ========== SUPER ADMIN PAGE (SafetyFirst Platform Admin) ==========
    const SuperAdminPage = ({ onLogout }) => {
      const [tab, setTab] = useState('dashboard');
      const [orgs, setOrgs] = useState([]);
      const [users, setUsers] = useState([]);
      const [tickets, setTickets] = useState([]);
      const [announcements, setAnnouncements] = useState([]);
      const [loading, setLoading] = useState(true);
      const [modal, setModal] = useState(null); // 'org', 'user', 'ticket', 'announcement', 'orgDetail'
      const [selected, setSelected] = useState(null);
      const [search, setSearch] = useState('');
      const [dashboard, setDashboard] = useState({
        overview: { totalOrgs: 0, activeOrgs: 0, totalUsers: 0, activeUsers: 0, trialOrgs: 0, currentMRR: 0, currentARR: 0 },
        growth: { newOrgsMonth: 0, newOrgsWeek: 0, newUsersMonth: 0, orgGrowthRate: 0 },
        tiers: { starter: 0, professional: 0, enterprise: 0 },
        activity: { incidentsMonth: 0, inspectionsMonth: 0, trainingsMonth: 0 },
        topOrgs: [],
        recentSignups: []
      });
      const [health, setHealth] = useState({ status: 'healthy', database: 'connected', uptime: 0 });

      const tierColors = { starter: 'blue', professional: 'purple', enterprise: 'amber' };
      const tierPrices = { starter: 199, professional: 499, enterprise: 1299 };

      useEffect(() => { fetchData(); }, [tab]);

      const fetchData = async () => {
        setLoading(true);
        try {
          if (tab === 'dashboard') {
            const data = await api.get('/superadmin/dashboard');
            setDashboard(data);
          } else if (tab === 'organizations') {
            const data = await api.get('/superadmin/organizations?limit=100' + (search ? '&search=' + search : ''));
            setOrgs(data.organizations || []);
          } else if (tab === 'users') {
            const data = await api.get('/superadmin/users?limit=100' + (search ? '&search=' + search : ''));
            setUsers(data.users || []);
          } else if (tab === 'tickets') {
            const data = await api.get('/superadmin/tickets');
            setTickets(data.tickets || []);
          } else if (tab === 'announcements') {
            const data = await api.get('/superadmin/announcements');
            setAnnouncements(data.announcements || []);
          } else if (tab === 'health') {
            const data = await api.get('/superadmin/health');
            setHealth(data);
          }
        } catch (e) {
          console.error('Fetch error:', e);
          // Demo data fallback
          if (tab === 'dashboard') {
            setDashboard({
              overview: { totalOrgs: 156, activeOrgs: 142, totalUsers: 2847, activeUsers: 1923, trialOrgs: 23, currentMRR: 87500, currentARR: 1050000 },
              growth: { newOrgsMonth: 18, newOrgsWeek: 5, newUsersMonth: 234, orgGrowthRate: 12.5 },
              tiers: { starter: 89, professional: 52, enterprise: 15 },
              activity: { incidentsMonth: 342, inspectionsMonth: 1205, trainingsMonth: 567 },
              topOrgs: [
                { name: 'Acme Manufacturing', tier: 'enterprise', activityCount: 89 },
                { name: 'BuildRight Construction', tier: 'professional', activityCount: 67 },
                { name: 'SafeChem Industries', tier: 'enterprise', activityCount: 54 }
              ],
              recentSignups: [
                { name: 'NewTech Solutions', industry: 'technology', subscription: { tier: 'starter' }, createdAt: new Date() },
                { name: 'Green Energy Corp', industry: 'energy', subscription: { tier: 'professional' }, createdAt: new Date(Date.now() - 86400000) }
              ]
            });
          } else if (tab === 'organizations') {
            setOrgs([
              { _id: '1', name: 'Acme Manufacturing', industry: 'Manufacturing', subscription: { tier: 'enterprise', status: 'active' }, userCount: 245, incidentCount: 34, createdAt: '2024-01-15', lastActivity: new Date() },
              { _id: '2', name: 'BuildRight Construction', industry: 'Construction', subscription: { tier: 'professional', status: 'active' }, userCount: 67, incidentCount: 12, createdAt: '2024-02-20', lastActivity: new Date() },
              { _id: '3', name: 'SafeChem Industries', industry: 'Chemical', subscription: { tier: 'enterprise', status: 'active' }, userCount: 189, incidentCount: 28, createdAt: '2024-01-08', lastActivity: new Date() }
            ]);
          } else if (tab === 'tickets') {
            setTickets([
              { _id: '1', ticketNumber: 'TKT-001', subject: 'Cannot export reports', category: 'bug', priority: 'high', status: 'open', submitterName: 'John Smith', organization: { name: 'Acme Mfg' }, createdAt: new Date() },
              { _id: '2', ticketNumber: 'TKT-002', subject: 'Feature request: Mobile app', category: 'feature_request', priority: 'medium', status: 'in_progress', submitterName: 'Jane Doe', organization: { name: 'BuildRight' }, createdAt: new Date(Date.now() - 86400000) }
            ]);
          }
        }
        setLoading(false);
      };

      // Organization Detail Modal
      const OrgDetailModal = ({ isOpen, onClose, org }) => {
        const [details, setDetails] = useState(null);
        const [detailTab, setDetailTab] = useState('overview');
        const [loadingDetail, setLoadingDetail] = useState(true);

        useEffect(() => {
          if (org?._id && isOpen) {
            setLoadingDetail(true);
            api.get('/superadmin/organizations/' + org._id)
              .then(d => setDetails(d))
              .catch(console.error)
              .finally(() => setLoadingDetail(false));
          }
        }, [org, isOpen]);

        if (!isOpen) return null;

        return (
          <Modal isOpen={isOpen} onClose={onClose} title={org?.name || 'Organization Details'} size="xl">
            {loadingDetail ? (
              <div className="flex justify-center py-12"><Spinner size="lg" /></div>
            ) : details ? (
              <>
                <div className="flex gap-2 mb-6 border-b border-slate-200 pb-3">
                  {['overview', 'users', 'activity', 'billing'].map(t => (
                    <button key={t} onClick={() => setDetailTab(t)} className={`px-4 py-2 text-sm font-medium rounded-lg capitalize ${detailTab === t ? 'bg-primary-100 text-primary-700' : 'text-slate-600 hover:bg-slate-100'}`}>{t}</button>
                  ))}
                </div>

                {detailTab === 'overview' && (
                  <div className="space-y-6">
                    <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                      <div className="p-4 bg-slate-50 rounded-xl text-center">
                        <p className="text-2xl font-bold text-slate-800">{details.metrics?.userCount || 0}</p>
                        <p className="text-sm text-slate-500">Users</p>
                      </div>
                      <div className="p-4 bg-slate-50 rounded-xl text-center">
                        <p className="text-2xl font-bold text-slate-800">{details.metrics?.incidentCount || 0}</p>
                        <p className="text-sm text-slate-500">Incidents</p>
                      </div>
                      <div className="p-4 bg-slate-50 rounded-xl text-center">
                        <p className="text-2xl font-bold text-slate-800">{details.metrics?.inspectionCount || 0}</p>
                        <p className="text-sm text-slate-500">Inspections</p>
                      </div>
                      <div className="p-4 bg-slate-50 rounded-xl text-center">
                        <p className="text-2xl font-bold text-slate-800">{details.metrics?.trainingRecords || 0}</p>
                        <p className="text-sm text-slate-500">Training Records</p>
                      </div>
                    </div>
                    <div className="grid grid-cols-2 gap-4">
                      <div>
                        <label className="text-sm font-medium text-slate-500">Industry</label>
                        <p className="font-semibold text-slate-800">{details.organization?.industry || 'N/A'}</p>
                      </div>
                      <div>
                        <label className="text-sm font-medium text-slate-500">Subscription</label>
                        <p><Badge color={tierColors[details.organization?.subscription?.tier]}>{details.organization?.subscription?.tier}</Badge></p>
                      </div>
                      <div>
                        <label className="text-sm font-medium text-slate-500">Created</label>
                        <p className="font-semibold text-slate-800">{new Date(details.organization?.createdAt).toLocaleDateString()}</p>
                      </div>
                      <div>
                        <label className="text-sm font-medium text-slate-500">Status</label>
                        <p><Badge color={details.organization?.isActive ? 'green' : 'red'}>{details.organization?.isActive ? 'Active' : 'Inactive'}</Badge></p>
                      </div>
                    </div>
                  </div>
                )}

                {detailTab === 'users' && (
                  <div className="space-y-3 max-h-96 overflow-y-auto">
                    {(details.users || []).map(u => (
                      <div key={u._id} className="flex items-center justify-between p-3 bg-slate-50 rounded-xl">
                        <div className="flex items-center gap-3">
                          <div className="w-10 h-10 bg-primary-100 text-primary-600 rounded-full flex items-center justify-center font-bold">
                            {(u.firstName?.[0] || '') + (u.lastName?.[0] || '')}
                          </div>
                          <div>
                            <p className="font-semibold text-slate-800">{u.firstName} {u.lastName}</p>
                            <p className="text-sm text-slate-500">{u.email}</p>
                          </div>
                        </div>
                        <div className="flex items-center gap-2">
                          <Badge color={u.role === 'admin' ? 'purple' : 'gray'}>{u.role}</Badge>
                          <Badge color={u.isActive ? 'green' : 'red'}>{u.isActive ? 'Active' : 'Inactive'}</Badge>
                        </div>
                      </div>
                    ))}
                  </div>
                )}

                {detailTab === 'activity' && (
                  <div className="space-y-3 max-h-96 overflow-y-auto">
                    {(details.recentActivity || []).length === 0 ? (
                      <p className="text-center py-8 text-slate-500">No recent activity</p>
                    ) : (
                      (details.recentActivity || []).map((a, i) => (
                        <div key={i} className="flex items-center gap-3 p-3 bg-slate-50 rounded-xl">
                          <Badge color="blue">{a.action}</Badge>
                          <span className="text-slate-700">{a.entityName || a.module}</span>
                          <span className="text-sm text-slate-500 ml-auto">{new Date(a.timestamp).toLocaleString()}</span>
                        </div>
                      ))
                    )}
                  </div>
                )}

                {detailTab === 'billing' && (
                  <div className="space-y-4">
                    <div className="p-4 bg-slate-50 rounded-xl">
                      <div className="flex justify-between items-center">
                        <div>
                          <p className="text-sm text-slate-500">Current Plan</p>
                          <p className="text-xl font-bold text-slate-800 capitalize">{details.organization?.subscription?.tier}</p>
                        </div>
                        <p className="text-2xl font-bold text-primary-600">${tierPrices[details.organization?.subscription?.tier] || 0}/mo</p>
                      </div>
                    </div>
                    <h4 className="font-semibold text-slate-700">Transaction History</h4>
                    {(details.transactions || []).length === 0 ? (
                      <p className="text-slate-500 text-center py-4">No transactions</p>
                    ) : (
                      (details.transactions || []).map((t, i) => (
                        <div key={i} className="flex justify-between items-center p-3 bg-slate-50 rounded-xl">
                          <div>
                            <p className="font-semibold text-slate-800">{t.type}</p>
                            <p className="text-sm text-slate-500">{new Date(t.createdAt).toLocaleDateString()}</p>
                          </div>
                          <p className={`font-bold ${t.amount >= 0 ? 'text-emerald-600' : 'text-red-600'}`}>${Math.abs(t.amount).toLocaleString()}</p>
                        </div>
                      ))
                    )}
                  </div>
                )}
              </>
            ) : (
              <p className="text-center py-8 text-slate-500">Failed to load details</p>
            )}
          </Modal>
        );
      };

      // Organization Edit Modal
      const OrgModal = ({ isOpen, onClose, org }) => {
        const [form, setForm] = useState({});
        const [saving, setSaving] = useState(false);
        const [showAdmin, setShowAdmin] = useState(false);

        useEffect(() => {
          if (org) {
            setForm({ ...org, email: org.email || org.contact?.email, phone: org.phone || org.contact?.phone });
          } else {
            setForm({ name: '', industry: '', email: '', phone: '', subscription: { tier: 'starter', status: 'active' }, adminUser: { email: '', password: '', firstName: '', lastName: '' } });
            setShowAdmin(true);
          }
        }, [org, isOpen]);

        const handleSave = async () => {
          setSaving(true);
          try {
            if (org?._id) {
              await api.put('/superadmin/organizations/' + org._id, form);
            } else {
              await api.post('/superadmin/organizations', form);
            }
            fetchData();
            onClose();
          } catch (e) { console.error(e); }
          setSaving(false);
        };

        return (
          <Modal isOpen={isOpen} onClose={onClose} title={org ? 'Edit Organization' : 'Create Organization'} size="lg"
            footer={<><Button variant="secondary" onClick={onClose}>Cancel</Button><Button onClick={handleSave} loading={saving}>{org ? 'Update' : 'Create'}</Button></>}
          >
            <div className="space-y-5">
              <Input label="Organization Name *" value={form.name || ''} onChange={e => setForm(p => ({ ...p, name: e.target.value }))} />
              <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <Select label="Industry" value={form.industry || ''} onChange={e => setForm(p => ({ ...p, industry: e.target.value }))} options={[
                  { value: '', label: 'Select Industry' },
                  { value: 'Manufacturing', label: 'Manufacturing' },
                  { value: 'Construction', label: 'Construction' },
                  { value: 'Healthcare', label: 'Healthcare' },
                  { value: 'Logistics', label: 'Logistics' },
                  { value: 'Energy', label: 'Energy' },
                  { value: 'Chemical', label: 'Chemical' },
                  { value: 'Food & Beverage', label: 'Food & Beverage' },
                  { value: 'Retail', label: 'Retail' },
                  { value: 'Technology', label: 'Technology' },
                  { value: 'Other', label: 'Other' }
                ]} />
                <Select label="Subscription Tier" value={form.subscription?.tier || 'starter'} onChange={e => setForm(p => ({ ...p, subscription: { ...p.subscription, tier: e.target.value } }))} options={[
                  { value: 'starter', label: 'Starter ($199/mo)' },
                  { value: 'professional', label: 'Professional ($499/mo)' },
                  { value: 'enterprise', label: 'Enterprise ($1,299/mo)' }
                ]} />
              </div>
              <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <Input label="Contact Email" type="email" value={form.email || ''} onChange={e => setForm(p => ({ ...p, email: e.target.value }))} />
                <Input label="Contact Phone" type="tel" value={form.phone || ''} onChange={e => setForm(p => ({ ...p, phone: e.target.value }))} />
              </div>
              <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <Select label="Status" value={form.subscription?.status || 'active'} onChange={e => setForm(p => ({ ...p, subscription: { ...p.subscription, status: e.target.value } }))} options={[
                  { value: 'trial', label: 'Trial' },
                  { value: 'active', label: 'Active' },
                  { value: 'cancelled', label: 'Cancelled' },
                  { value: 'expired', label: 'Expired' }
                ]} />
                <div className="flex items-center pt-6">
                  <Checkbox label="Organization is Active" checked={form.isActive !== false} onChange={e => setForm(p => ({ ...p, isActive: e.target.checked }))} />
                </div>
              </div>

              {!org && (
                <>
                  <div className="border-t border-slate-200 pt-4 mt-4">
                    <Checkbox label="Create Admin User" checked={showAdmin} onChange={e => setShowAdmin(e.target.checked)} />
                  </div>
                  {showAdmin && (
                    <div className="space-y-4 p-4 bg-slate-50 rounded-xl">
                      <h4 className="font-semibold text-slate-700">Admin User Details</h4>
                      <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <Input label="First Name" value={form.adminUser?.firstName || ''} onChange={e => setForm(p => ({ ...p, adminUser: { ...p.adminUser, firstName: e.target.value } }))} />
                        <Input label="Last Name" value={form.adminUser?.lastName || ''} onChange={e => setForm(p => ({ ...p, adminUser: { ...p.adminUser, lastName: e.target.value } }))} />
                      </div>
                      <Input label="Email *" type="email" value={form.adminUser?.email || ''} onChange={e => setForm(p => ({ ...p, adminUser: { ...p.adminUser, email: e.target.value } }))} />
                      <Input label="Password *" type="password" value={form.adminUser?.password || ''} onChange={e => setForm(p => ({ ...p, adminUser: { ...p.adminUser, password: e.target.value } }))} />
                    </div>
                  )}
                </>
              )}
            </div>
          </Modal>
        );
      };

      // Announcement Modal
      const AnnouncementModal = ({ isOpen, onClose, item }) => {
        const [form, setForm] = useState({});
        const [saving, setSaving] = useState(false);

        useEffect(() => {
          setForm(item || { title: '', content: '', type: 'info', priority: 'medium', isActive: true, displayLocation: ['dashboard'] });
        }, [item, isOpen]);

        const handleSave = async () => {
          setSaving(true);
          try {
            if (item?._id) {
              await api.put('/superadmin/announcements/' + item._id, form);
            } else {
              await api.post('/superadmin/announcements', form);
            }
            fetchData();
            onClose();
          } catch (e) { console.error(e); }
          setSaving(false);
        };

        return (
          <Modal isOpen={isOpen} onClose={onClose} title={item ? 'Edit Announcement' : 'New Announcement'} size="lg"
            footer={<><Button variant="secondary" onClick={onClose}>Cancel</Button><Button onClick={handleSave} loading={saving}>Save</Button></>}
          >
            <div className="space-y-5">
              <Input label="Title *" value={form.title || ''} onChange={e => setForm(p => ({ ...p, title: e.target.value }))} />
              <Textarea label="Content *" value={form.content || ''} onChange={e => setForm(p => ({ ...p, content: e.target.value }))} rows={4} />
              <div className="grid grid-cols-1 sm:grid-cols-3 gap-4">
                <Select label="Type" value={form.type || 'info'} onChange={e => setForm(p => ({ ...p, type: e.target.value }))} options={[
                  { value: 'info', label: 'Information' },
                  { value: 'warning', label: 'Warning' },
                  { value: 'critical', label: 'Critical' },
                  { value: 'maintenance', label: 'Maintenance' },
                  { value: 'feature', label: 'New Feature' },
                  { value: 'promotion', label: 'Promotion' }
                ]} />
                <Select label="Priority" value={form.priority || 'medium'} onChange={e => setForm(p => ({ ...p, priority: e.target.value }))} options={[
                  { value: 'low', label: 'Low' },
                  { value: 'medium', label: 'Medium' },
                  { value: 'high', label: 'High' },
                  { value: 'urgent', label: 'Urgent' }
                ]} />
                <div className="flex items-center pt-6">
                  <Checkbox label="Active" checked={form.isActive !== false} onChange={e => setForm(p => ({ ...p, isActive: e.target.checked }))} />
                </div>
              </div>
              <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <Input label="Start Date" type="date" value={form.startDate ? new Date(form.startDate).toISOString().split('T')[0] : ''} onChange={e => setForm(p => ({ ...p, startDate: e.target.value }))} />
                <Input label="End Date" type="date" value={form.endDate ? new Date(form.endDate).toISOString().split('T')[0] : ''} onChange={e => setForm(p => ({ ...p, endDate: e.target.value }))} />
              </div>
            </div>
          </Modal>
        );
      };

      // Ticket Detail Modal
      const TicketModal = ({ isOpen, onClose, ticket }) => {
        const [message, setMessage] = useState('');
        const [sending, setSending] = useState(false);
        const [status, setStatus] = useState(ticket?.status || 'open');

        useEffect(() => {
          if (ticket) setStatus(ticket.status);
        }, [ticket]);

        const sendMessage = async () => {
          if (!message.trim()) return;
          setSending(true);
          try {
            await api.post('/superadmin/tickets/' + ticket._id + '/messages', { message });
            setMessage('');
            fetchData();
          } catch (e) { console.error(e); }
          setSending(false);
        };

        const updateStatus = async (newStatus) => {
          try {
            await api.put('/superadmin/tickets/' + ticket._id, { status: newStatus });
            setStatus(newStatus);
            fetchData();
          } catch (e) { console.error(e); }
        };

        if (!ticket) return null;

        return (
          <Modal isOpen={isOpen} onClose={onClose} title={'Ticket: ' + ticket.ticketNumber} size="lg">
            <div className="space-y-4">
              <div className="flex items-center gap-3 flex-wrap">
                <Badge color={ticket.priority === 'critical' ? 'red' : ticket.priority === 'high' ? 'orange' : 'gray'}>{ticket.priority}</Badge>
                <Badge color={ticket.category === 'bug' ? 'red' : ticket.category === 'feature_request' ? 'purple' : 'blue'}>{ticket.category?.replace('_', ' ')}</Badge>
                <Select value={status} onChange={e => updateStatus(e.target.value)} options={[
                  { value: 'new', label: 'New' },
                  { value: 'open', label: 'Open' },
                  { value: 'in_progress', label: 'In Progress' },
                  { value: 'waiting_customer', label: 'Waiting on Customer' },
                  { value: 'resolved', label: 'Resolved' },
                  { value: 'closed', label: 'Closed' }
                ]} className="w-48" />
              </div>

              <div className="p-4 bg-slate-50 rounded-xl">
                <h4 className="font-semibold text-slate-800">{ticket.subject}</h4>
                <p className="text-slate-600 mt-2">{ticket.description}</p>
                <div className="flex gap-4 mt-3 text-sm text-slate-500">
                  <span>From: {ticket.submitterName}</span>
                  <span>Org: {ticket.organization?.name}</span>
                  <span>{new Date(ticket.createdAt).toLocaleString()}</span>
                </div>
              </div>

              <div className="border-t border-slate-200 pt-4">
                <h4 className="font-semibold text-slate-700 mb-3">Messages</h4>
                <div className="space-y-3 max-h-64 overflow-y-auto">
                  {(ticket.messages || []).map((m, i) => (
                    <div key={i} className={`p-3 rounded-xl ${m.sender === 'support' ? 'bg-primary-50 ml-8' : 'bg-slate-100 mr-8'}`}>
                      <div className="flex justify-between items-start mb-1">
                        <span className="font-semibold text-sm">{m.senderName || m.sender}</span>
                        <span className="text-xs text-slate-500">{new Date(m.sentAt).toLocaleString()}</span>
                      </div>
                      <p className="text-slate-700">{m.message}</p>
                    </div>
                  ))}
                </div>
              </div>

              <div className="flex gap-2">
                <Textarea value={message} onChange={e => setMessage(e.target.value)} placeholder="Type your reply..." rows={2} className="flex-1" />
                <Button onClick={sendMessage} loading={sending} disabled={!message.trim()}>Send</Button>
              </div>
            </div>
          </Modal>
        );
      };

      const tabs = [
        { id: 'dashboard', label: 'Dashboard', icon: Icons.Dashboard },
        { id: 'organizations', label: 'Organizations', icon: Icons.Contractor },
        { id: 'users', label: 'Users', icon: Icons.Users },
        { id: 'tickets', label: 'Support', icon: Icons.Action },
        { id: 'announcements', label: 'Announcements', icon: Icons.Bell },
        { id: 'revenue', label: 'Revenue', icon: Icons.Reports },
        { id: 'health', label: 'System', icon: Icons.Settings }
      ];

      return (
        <div className="min-h-screen bg-slate-100">
          {/* Header */}
          <header className="bg-gradient-to-r from-slate-900 to-slate-800 text-white px-6 py-4 shadow-lg">
            <div className="max-w-7xl mx-auto flex items-center justify-between">
              <div className="flex items-center gap-4">
                <div className="w-10 h-10 bg-gradient-to-br from-red-500 to-red-600 rounded-xl flex items-center justify-center shadow-lg">
                  <Icons.Shield />
                </div>
                <div>
                  <h1 className="font-bold text-lg">SafetyFirst Platform Admin</h1>
                  <p className="text-sm text-slate-400">Manage organizations, users, and system</p>
                </div>
              </div>
              <Button variant="ghost" className="!text-white hover:!bg-slate-700" onClick={onLogout} icon={<Icons.Logout />}>Sign Out</Button>
            </div>
          </header>

          {/* Navigation */}
          <div className="bg-white border-b border-slate-200 shadow-sm sticky top-0 z-10">
            <div className="max-w-7xl mx-auto px-6">
              <div className="flex gap-1 overflow-x-auto py-2">
                {tabs.map(t => (
                  <button key={t.id} onClick={() => { setTab(t.id); setSearch(''); }} 
                    className={`flex items-center gap-2 px-4 py-2.5 text-sm font-medium rounded-lg whitespace-nowrap transition-colors ${tab === t.id ? 'bg-primary-100 text-primary-700' : 'text-slate-600 hover:bg-slate-100'}`}>
                    <t.icon />{t.label}
                  </button>
                ))}
              </div>
            </div>
          </div>

          <div className="max-w-7xl mx-auto px-6 py-8">
            {/* DASHBOARD TAB */}
            {tab === 'dashboard' && (
              <div className="space-y-6">
                {/* Top Stats */}
                <div className="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-7 gap-4">
                  <div className="bg-white p-4 rounded-xl shadow-sm">
                    <p className="text-2xl font-bold text-slate-800">{dashboard.overview?.totalOrgs || 0}</p>
                    <p className="text-sm text-slate-500">Organizations</p>
                  </div>
                  <div className="bg-white p-4 rounded-xl shadow-sm">
                    <p className="text-2xl font-bold text-slate-800">{dashboard.overview?.totalUsers || 0}</p>
                    <p className="text-sm text-slate-500">Users</p>
                  </div>
                  <div className="bg-white p-4 rounded-xl shadow-sm">
                    <p className="text-2xl font-bold text-emerald-600">{dashboard.overview?.activeUsers || 0}</p>
                    <p className="text-sm text-slate-500">Active (30d)</p>
                  </div>
                  <div className="bg-white p-4 rounded-xl shadow-sm">
                    <p className="text-2xl font-bold text-amber-600">{dashboard.overview?.trialOrgs || 0}</p>
                    <p className="text-sm text-slate-500">Trials</p>
                  </div>
                  <div className="bg-white p-4 rounded-xl shadow-sm">
                    <p className="text-2xl font-bold text-primary-600">${((dashboard.overview?.currentMRR || 0) / 1000).toFixed(1)}k</p>
                    <p className="text-sm text-slate-500">MRR</p>
                  </div>
                  <div className="bg-white p-4 rounded-xl shadow-sm">
                    <p className="text-2xl font-bold text-purple-600">${((dashboard.overview?.currentARR || 0) / 1000).toFixed(0)}k</p>
                    <p className="text-sm text-slate-500">ARR</p>
                  </div>
                  <div className="bg-white p-4 rounded-xl shadow-sm">
                    <p className="text-2xl font-bold text-green-600">+{dashboard.growth?.orgGrowthRate || 0}%</p>
                    <p className="text-sm text-slate-500">Growth</p>
                  </div>
                </div>

                {/* Tier Breakdown & Activity */}
                <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                  <Card title="Subscription Breakdown">
                    <div className="space-y-4">
                      {['starter', 'professional', 'enterprise'].map(tier => {
                        const count = dashboard.tiers?.[tier] || 0;
                        const total = (dashboard.tiers?.starter || 0) + (dashboard.tiers?.professional || 0) + (dashboard.tiers?.enterprise || 0);
                        const pct = total > 0 ? (count / total * 100).toFixed(0) : 0;
                        return (
                          <div key={tier} className="flex items-center gap-4">
                            <div className="w-24">
                              <Badge color={tierColors[tier]} size="md">{tier}</Badge>
                            </div>
                            <div className="flex-1 bg-slate-100 rounded-full h-4 overflow-hidden">
                              <div className={`h-full rounded-full ${tier === 'starter' ? 'bg-blue-500' : tier === 'professional' ? 'bg-purple-500' : 'bg-amber-500'}`} style={{ width: pct + '%' }} />
                            </div>
                            <div className="w-20 text-right">
                              <span className="font-bold text-slate-800">{count}</span>
                              <span className="text-slate-500 text-sm ml-1">({pct}%)</span>
                            </div>
                            <div className="w-24 text-right text-emerald-600 font-semibold">
                              ${(count * tierPrices[tier]).toLocaleString()}
                            </div>
                          </div>
                        );
                      })}
                    </div>
                  </Card>

                  <Card title="Monthly Activity">
                    <div className="grid grid-cols-3 gap-4">
                      <div className="text-center p-4 bg-red-50 rounded-xl">
                        <Icons.Incident />
                        <p className="text-2xl font-bold text-red-600 mt-2">{dashboard.activity?.incidentsMonth || 0}</p>
                        <p className="text-sm text-slate-500">Incidents</p>
                      </div>
                      <div className="text-center p-4 bg-blue-50 rounded-xl">
                        <Icons.Inspection />
                        <p className="text-2xl font-bold text-blue-600 mt-2">{dashboard.activity?.inspectionsMonth || 0}</p>
                        <p className="text-sm text-slate-500">Inspections</p>
                      </div>
                      <div className="text-center p-4 bg-green-50 rounded-xl">
                        <Icons.Training />
                        <p className="text-2xl font-bold text-green-600 mt-2">{dashboard.activity?.trainingsMonth || 0}</p>
                        <p className="text-sm text-slate-500">Training</p>
                      </div>
                    </div>
                  </Card>
                </div>

                {/* Recent Signups & Top Orgs */}
                <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                  <Card title="Recent Signups" noPadding>
                    <div className="divide-y divide-slate-100">
                      {(dashboard.recentSignups || []).slice(0, 5).map((org, i) => (
                        <div key={i} className="flex items-center justify-between p-4 hover:bg-slate-50">
                          <div className="flex items-center gap-3">
                            <div className="w-10 h-10 bg-primary-100 text-primary-600 rounded-xl flex items-center justify-center font-bold">{org.name?.[0]}</div>
                            <div>
                              <p className="font-semibold text-slate-800">{org.name}</p>
                              <p className="text-sm text-slate-500">{org.industry}</p>
                            </div>
                          </div>
                          <div className="text-right">
                            <Badge color={tierColors[org.subscription?.tier]}>{org.subscription?.tier}</Badge>
                            <p className="text-xs text-slate-400 mt-1">{new Date(org.createdAt).toLocaleDateString()}</p>
                          </div>
                        </div>
                      ))}
                    </div>
                  </Card>

                  <Card title="Most Active Organizations" noPadding>
                    <div className="divide-y divide-slate-100">
                      {(dashboard.topOrgs || []).slice(0, 5).map((org, i) => (
                        <div key={i} className="flex items-center justify-between p-4 hover:bg-slate-50">
                          <div className="flex items-center gap-3">
                            <div className="w-8 h-8 bg-slate-200 rounded-full flex items-center justify-center font-bold text-slate-600">{i + 1}</div>
                            <div>
                              <p className="font-semibold text-slate-800">{org.name}</p>
                              <Badge color={tierColors[org.tier]} size="sm">{org.tier}</Badge>
                            </div>
                          </div>
                          <div className="text-right">
                            <p className="font-bold text-slate-800">{org.activityCount}</p>
                            <p className="text-xs text-slate-500">activities</p>
                          </div>
                        </div>
                      ))}
                    </div>
                  </Card>
                </div>
              </div>
            )}

            {/* ORGANIZATIONS TAB */}
            {tab === 'organizations' && (
              <div className="space-y-4">
                <div className="flex flex-col sm:flex-row justify-between gap-4">
                  <div className="relative flex-1 max-w-md">
                    <div className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400"><Icons.Search /></div>
                    <input type="text" placeholder="Search organizations..." value={search} onChange={e => setSearch(e.target.value)} onKeyDown={e => e.key === 'Enter' && fetchData()}
                      className="pl-10 pr-4 py-2.5 bg-white border-2 border-slate-200 rounded-xl focus:border-primary-500 w-full" />
                  </div>
                  <Button onClick={() => { setSelected(null); setModal('org'); }} icon={<Icons.Plus />}>Add Organization</Button>
                </div>

                <Card noPadding>
                  {loading ? (
                    <div className="flex justify-center py-16"><Spinner size="lg" /></div>
                  ) : (
                    <div className="overflow-x-auto">
                      <table className="w-full">
                        <thead className="bg-slate-50 border-b border-slate-200">
                          <tr>
                            <th className="text-left p-4 font-semibold text-slate-600">Organization</th>
                            <th className="text-left p-4 font-semibold text-slate-600">Industry</th>
                            <th className="text-left p-4 font-semibold text-slate-600">Tier</th>
                            <th className="text-left p-4 font-semibold text-slate-600">Users</th>
                            <th className="text-left p-4 font-semibold text-slate-600">Incidents</th>
                            <th className="text-left p-4 font-semibold text-slate-600">Last Active</th>
                            <th className="text-left p-4 font-semibold text-slate-600">Actions</th>
                          </tr>
                        </thead>
                        <tbody className="divide-y divide-slate-100">
                          {orgs.map(org => (
                            <tr key={org._id} className="hover:bg-slate-50">
                              <td className="p-4">
                                <div className="flex items-center gap-3">
                                  <div className="w-10 h-10 bg-gradient-to-br from-slate-600 to-slate-700 text-white rounded-xl flex items-center justify-center font-bold">{org.name?.[0]}</div>
                                  <div>
                                    <p className="font-semibold text-slate-800">{org.name}</p>
                                    <p className="text-sm text-slate-500">{new Date(org.createdAt).toLocaleDateString()}</p>
                                  </div>
                                </div>
                              </td>
                              <td className="p-4 text-slate-600">{org.industry || '-'}</td>
                              <td className="p-4"><Badge color={tierColors[org.subscription?.tier]}>{org.subscription?.tier}</Badge></td>
                              <td className="p-4 font-semibold text-slate-800">{org.userCount || 0}</td>
                              <td className="p-4 text-slate-600">{org.incidentCount || 0}</td>
                              <td className="p-4 text-sm text-slate-500">{org.lastActivity ? new Date(org.lastActivity).toLocaleDateString() : '-'}</td>
                              <td className="p-4">
                                <div className="flex gap-2">
                                  <button onClick={() => { setSelected(org); setModal('orgDetail'); }} className="p-2 hover:bg-blue-100 rounded-lg text-slate-500 hover:text-blue-600"><Icons.Eye /></button>
                                  <button onClick={() => { setSelected(org); setModal('org'); }} className="p-2 hover:bg-primary-100 rounded-lg text-slate-500 hover:text-primary-600"><Icons.Edit /></button>
                                </div>
                              </td>
                            </tr>
                          ))}
                        </tbody>
                      </table>
                    </div>
                  )}
                </Card>
              </div>
            )}

            {/* USERS TAB */}
            {tab === 'users' && (
              <div className="space-y-4">
                <div className="flex flex-col sm:flex-row justify-between gap-4">
                  <div className="relative flex-1 max-w-md">
                    <div className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400"><Icons.Search /></div>
                    <input type="text" placeholder="Search users..." value={search} onChange={e => setSearch(e.target.value)} onKeyDown={e => e.key === 'Enter' && fetchData()}
                      className="pl-10 pr-4 py-2.5 bg-white border-2 border-slate-200 rounded-xl focus:border-primary-500 w-full" />
                  </div>
                </div>

                <Card noPadding>
                  {loading ? (
                    <div className="flex justify-center py-16"><Spinner size="lg" /></div>
                  ) : (
                    <div className="overflow-x-auto">
                      <table className="w-full">
                        <thead className="bg-slate-50 border-b border-slate-200">
                          <tr>
                            <th className="text-left p-4 font-semibold text-slate-600">User</th>
                            <th className="text-left p-4 font-semibold text-slate-600">Organization</th>
                            <th className="text-left p-4 font-semibold text-slate-600">Role</th>
                            <th className="text-left p-4 font-semibold text-slate-600">Status</th>
                            <th className="text-left p-4 font-semibold text-slate-600">Last Login</th>
                            <th className="text-left p-4 font-semibold text-slate-600">Actions</th>
                          </tr>
                        </thead>
                        <tbody className="divide-y divide-slate-100">
                          {users.map(user => (
                            <tr key={user._id} className="hover:bg-slate-50">
                              <td className="p-4">
                                <div className="flex items-center gap-3">
                                  <div className="w-10 h-10 bg-primary-100 text-primary-600 rounded-full flex items-center justify-center font-bold">
                                    {(user.firstName?.[0] || '') + (user.lastName?.[0] || '')}
                                  </div>
                                  <div>
                                    <p className="font-semibold text-slate-800">{user.firstName} {user.lastName}</p>
                                    <p className="text-sm text-slate-500">{user.email}</p>
                                  </div>
                                </div>
                              </td>
                              <td className="p-4">
                                <p className="text-slate-800">{user.organization?.name || '-'}</p>
                                <Badge color={tierColors[user.organization?.subscription?.tier]} size="sm">{user.organization?.subscription?.tier}</Badge>
                              </td>
                              <td className="p-4"><Badge color={user.role === 'admin' ? 'purple' : 'gray'}>{user.role}</Badge></td>
                              <td className="p-4"><Badge color={user.isActive ? 'green' : 'red'}>{user.isActive ? 'Active' : 'Inactive'}</Badge></td>
                              <td className="p-4 text-sm text-slate-500">{user.lastLogin ? new Date(user.lastLogin).toLocaleDateString() : 'Never'}</td>
                              <td className="p-4">
                                <Button size="sm" variant="secondary" onClick={async () => {
                                  if (confirm('Login as ' + user.firstName + ' ' + user.lastName + '?')) {
                                    try {
                                      const data = await api.post('/superadmin/impersonate/' + user._id);
                                      if (data.token) {
                                        localStorage.setItem('ehs_impersonate_return', api.token);
                                        api.setToken(data.token);
                                        window.location.reload();
                                      }
                                    } catch (e) { console.error(e); }
                                  }
                                }}>Impersonate</Button>
                              </td>
                            </tr>
                          ))}
                        </tbody>
                      </table>
                    </div>
                  )}
                </Card>
              </div>
            )}

            {/* SUPPORT TICKETS TAB */}
            {tab === 'tickets' && (
              <div className="space-y-4">
                <Card noPadding>
                  {loading ? (
                    <div className="flex justify-center py-16"><Spinner size="lg" /></div>
                  ) : tickets.length === 0 ? (
                    <div className="text-center py-16 text-slate-500">
                      <Icons.Action />
                      <p className="mt-2">No support tickets</p>
                    </div>
                  ) : (
                    <div className="divide-y divide-slate-100">
                      {tickets.map(ticket => (
                        <div key={ticket._id} className="flex items-center justify-between p-4 hover:bg-slate-50 cursor-pointer" onClick={() => { setSelected(ticket); setModal('ticket'); }}>
                          <div className="flex items-center gap-4">
                            <div className={`w-3 h-3 rounded-full ${ticket.status === 'new' ? 'bg-red-500' : ticket.status === 'open' ? 'bg-amber-500' : ticket.status === 'in_progress' ? 'bg-blue-500' : 'bg-green-500'}`} />
                            <div>
                              <p className="font-semibold text-slate-800">{ticket.subject}</p>
                              <div className="flex gap-2 mt-1">
                                <span className="text-sm text-slate-500">{ticket.ticketNumber}</span>
                                <span className="text-sm text-slate-400">‚Ä¢</span>
                                <span className="text-sm text-slate-500">{ticket.submitterName}</span>
                                <span className="text-sm text-slate-400">‚Ä¢</span>
                                <span className="text-sm text-slate-500">{ticket.organization?.name}</span>
                              </div>
                            </div>
                          </div>
                          <div className="flex items-center gap-3">
                            <Badge color={ticket.priority === 'critical' ? 'red' : ticket.priority === 'high' ? 'orange' : 'gray'}>{ticket.priority}</Badge>
                            <Badge color={ticket.category === 'bug' ? 'red' : 'blue'}>{ticket.category?.replace('_', ' ')}</Badge>
                            <span className="text-sm text-slate-500">{new Date(ticket.createdAt).toLocaleDateString()}</span>
                          </div>
                        </div>
                      ))}
                    </div>
                  )}
                </Card>
              </div>
            )}

            {/* ANNOUNCEMENTS TAB */}
            {tab === 'announcements' && (
              <div className="space-y-4">
                <div className="flex justify-end">
                  <Button onClick={() => { setSelected(null); setModal('announcement'); }} icon={<Icons.Plus />}>New Announcement</Button>
                </div>
                <Card noPadding>
                  {loading ? (
                    <div className="flex justify-center py-16"><Spinner size="lg" /></div>
                  ) : announcements.length === 0 ? (
                    <div className="text-center py-16 text-slate-500">
                      <Icons.Bell />
                      <p className="mt-2">No announcements</p>
                    </div>
                  ) : (
                    <div className="divide-y divide-slate-100">
                      {announcements.map(a => (
                        <div key={a._id} className="flex items-center justify-between p-4 hover:bg-slate-50">
                          <div>
                            <div className="flex items-center gap-2">
                              <p className="font-semibold text-slate-800">{a.title}</p>
                              <Badge color={a.type === 'critical' ? 'red' : a.type === 'warning' ? 'orange' : a.type === 'feature' ? 'green' : 'blue'}>{a.type}</Badge>
                              {!a.isActive && <Badge color="gray">Inactive</Badge>}
                            </div>
                            <p className="text-sm text-slate-500 mt-1 line-clamp-1">{a.content}</p>
                          </div>
                          <div className="flex items-center gap-2">
                            <span className="text-sm text-slate-500">{new Date(a.createdAt).toLocaleDateString()}</span>
                            <button onClick={() => { setSelected(a); setModal('announcement'); }} className="p-2 hover:bg-primary-100 rounded-lg text-slate-500 hover:text-primary-600"><Icons.Edit /></button>
                            <button onClick={async () => { if (confirm('Delete?')) { await api.del('/superadmin/announcements/' + a._id); fetchData(); } }} className="p-2 hover:bg-red-100 rounded-lg text-slate-500 hover:text-red-600"><Icons.Trash /></button>
                          </div>
                        </div>
                      ))}
                    </div>
                  )}
                </Card>
              </div>
            )}

            {/* REVENUE TAB */}
            {tab === 'revenue' && (
              <div className="space-y-6">
                <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                  {['starter', 'professional', 'enterprise'].map(tier => {
                    const count = dashboard.tiers?.[tier] || 0;
                    return (
                      <div key={tier} className="bg-white p-6 rounded-xl shadow-sm">
                        <Badge color={tierColors[tier]} size="md">{tier}</Badge>
                        <div className="mt-4 flex justify-between items-end">
                          <div>
                            <p className="text-3xl font-bold text-slate-800">{count}</p>
                            <p className="text-slate-500">organizations</p>
                          </div>
                          <div className="text-right">
                            <p className="text-xl font-bold text-emerald-600">${(count * tierPrices[tier]).toLocaleString()}</p>
                            <p className="text-sm text-slate-500">/month</p>
                          </div>
                        </div>
                      </div>
                    );
                  })}
                </div>

                <Card title="Revenue Summary">
                  <div className="grid grid-cols-2 md:grid-cols-4 gap-6">
                    <div className="text-center p-4 bg-primary-50 rounded-xl">
                      <p className="text-3xl font-bold text-primary-600">${((dashboard.overview?.currentMRR || 0)).toLocaleString()}</p>
                      <p className="text-slate-500">Monthly Revenue</p>
                    </div>
                    <div className="text-center p-4 bg-purple-50 rounded-xl">
                      <p className="text-3xl font-bold text-purple-600">${((dashboard.overview?.currentARR || 0)).toLocaleString()}</p>
                      <p className="text-slate-500">Annual Revenue</p>
                    </div>
                    <div className="text-center p-4 bg-emerald-50 rounded-xl">
                      <p className="text-3xl font-bold text-emerald-600">${Math.round((dashboard.overview?.currentMRR || 0) / Math.max(dashboard.overview?.totalOrgs || 1, 1))}</p>
                      <p className="text-slate-500">Avg Revenue/Org</p>
                    </div>
                    <div className="text-center p-4 bg-amber-50 rounded-xl">
                      <p className="text-3xl font-bold text-amber-600">${Math.round((dashboard.overview?.currentMRR || 0) / Math.max(dashboard.overview?.totalUsers || 1, 1))}</p>
                      <p className="text-slate-500">Avg Revenue/User</p>
                    </div>
                  </div>
                </Card>
              </div>
            )}

            {/* SYSTEM HEALTH TAB */}
            {tab === 'health' && (
              <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                <Card title="System Status">
                  <div className="space-y-4">
                    {[
                      ['Overall Status', health.status === 'healthy' ? 'Operational' : health.status, health.status === 'healthy' ? 'green' : 'red'],
                      ['Database', health.database === 'connected' ? 'Connected' : 'Disconnected', health.database === 'connected' ? 'green' : 'red'],
                      ['API Server', 'Operational', 'green'],
                      ['File Storage', 'Operational', 'green'],
                      ['Email Service', 'Operational', 'green']
                    ].map(([name, status, color]) => (
                      <div key={name} className="flex items-center justify-between p-4 bg-slate-50 rounded-xl">
                        <span className="font-medium text-slate-700">{name}</span>
                        <Badge color={color}>{status}</Badge>
                      </div>
                    ))}
                  </div>
                </Card>

                <Card title="Server Info">
                  <div className="space-y-4">
                    <div className="flex justify-between p-3 bg-slate-50 rounded-xl">
                      <span className="text-slate-600">Uptime</span>
                      <span className="font-semibold text-slate-800">{Math.floor((health.uptime || 0) / 3600)}h {Math.floor(((health.uptime || 0) % 3600) / 60)}m</span>
                    </div>
                    <div className="flex justify-between p-3 bg-slate-50 rounded-xl">
                      <span className="text-slate-600">Memory (Heap)</span>
                      <span className="font-semibold text-slate-800">{Math.round((health.memory?.heapUsed || 0) / 1024 / 1024)} MB</span>
                    </div>
                    <div className="flex justify-between p-3 bg-slate-50 rounded-xl">
                      <span className="text-slate-600">Memory (RSS)</span>
                      <span className="font-semibold text-slate-800">{Math.round((health.memory?.rss || 0) / 1024 / 1024)} MB</span>
                    </div>
                  </div>
                </Card>

                <Card title="Database Collections" className="md:col-span-2">
                  <div className="grid grid-cols-2 md:grid-cols-5 gap-4">
                    {(health.collections || []).map(c => (
                      <div key={c.name} className="p-4 bg-slate-50 rounded-xl text-center">
                        <p className="text-2xl font-bold text-slate-800">{c.count?.toLocaleString() || 0}</p>
                        <p className="text-sm text-slate-500 capitalize">{c.name}</p>
                      </div>
                    ))}
                  </div>
                </Card>

                <Card title="Quick Actions" className="md:col-span-2">
                  <div className="flex flex-wrap gap-3">
                    <Button variant="secondary" icon={<Icons.Download />} onClick={() => window.open('/api/superadmin/export/organizations', '_blank')}>Export Organizations</Button>
                    <Button variant="secondary" icon={<Icons.Reports />}>Generate Platform Report</Button>
                    <Button variant="secondary" icon={<Icons.Audit />} onClick={() => window.open('/api/superadmin/audit-logs', '_blank')}>View Audit Logs</Button>
                  </div>
                </Card>
              </div>
            )}
          </div>

          {/* Modals */}
          <OrgModal isOpen={modal === 'org'} onClose={() => { setModal(null); setSelected(null); }} org={selected} />
          <OrgDetailModal isOpen={modal === 'orgDetail'} onClose={() => { setModal(null); setSelected(null); }} org={selected} />
          <AnnouncementModal isOpen={modal === 'announcement'} onClose={() => { setModal(null); setSelected(null); }} item={selected} />
          <TicketModal isOpen={modal === 'ticket'} onClose={() => { setModal(null); setSelected(null); }} ticket={selected} />
        </div>
      );
    };


    // ========== MAIN APP ==========
    const App = () => {
      const [user, setUser] = useState(null);
      const [loading, setLoading] = useState(true);
      const [page, setPage] = useState('dashboard');
      const [mobileOpen, setMobileOpen] = useState(false);
      const [toasts, setToasts] = useState([]);

      const addToast = (message, type = 'info') => { 
        const id = Date.now(); 
        setToasts(p => [...p, { id, message, type }]); 
        setTimeout(() => setToasts(p => p.filter(t => t.id !== id)), 5000); 
      };
      const removeToast = (id) => setToasts(p => p.filter(t => t.id !== id));

      useEffect(() => {
        const token = localStorage.getItem('ehs_token');
        if (token) { 
          api.setToken(token); 
          api.get('/auth/me')
            .then(d => setUser(d.user))
            .catch(() => api.setToken(null))
            .finally(() => setLoading(false)); 
        } else {
          setLoading(false);
        }
      }, []);

      const handleLogin = u => setUser(u);
      const handleLogout = () => { api.setToken(null); setUser(null); };

      // Column definitions
      const incidentCols = [
        { header: 'ID', render: r => <span className="font-mono text-xs bg-slate-100 px-2 py-1 rounded-lg">{r.incidentNumber}</span> },
        { header: 'Title', render: r => <span className="font-semibold text-slate-800 max-w-[200px] truncate block">{r.title}</span> },
        { header: 'Type', render: r => <Badge color="blue">{r.type?.replace('_', ' ')}</Badge> },
        { header: 'Severity', render: r => <Badge color={r.severity === 'severe' || r.severity === 'catastrophic' ? 'red' : r.severity === 'serious' ? 'orange' : 'yellow'}>{r.severity}</Badge> },
        { header: 'Status', render: r => <StatusBadge status={r.status} /> },
        { header: 'Date', render: r => <span className="text-slate-500">{new Date(r.dateOccurred).toLocaleDateString()}</span> },
      ];

      const actionCols = [
        { header: 'ID', render: r => <span className="font-mono text-xs bg-slate-100 px-2 py-1 rounded-lg">{r.actionNumber}</span> },
        { header: 'Title', render: r => <span className="font-semibold text-slate-800">{r.title}</span> },
        { header: 'Priority', render: r => <Badge color={r.priority === 'critical' ? 'red' : r.priority === 'high' ? 'orange' : r.priority === 'medium' ? 'yellow' : 'gray'}>{r.priority}</Badge> },
        { header: 'Status', render: r => <StatusBadge status={r.status} /> },
        { header: 'Due', render: r => { const d = new Date(r.dueDate); const overdue = d < new Date() && r.status !== 'completed'; return <span className={overdue ? 'text-red-600 font-bold' : 'text-slate-500'}>{d.toLocaleDateString()}</span>; } },
      ];

      const riskCols = [
        { header: 'ID', render: r => <span className="font-mono text-xs bg-slate-100 px-2 py-1 rounded-lg">{r.assessmentNumber}</span> },
        { header: 'Title', render: r => <span className="font-semibold text-slate-800">{r.title}</span> },
        { header: 'Type', render: r => <Badge color="purple">{r.type?.replace('_', ' ')}</Badge> },
        { header: 'Risk Level', render: r => <RiskBadge level={r.overallRiskLevel} /> },
        { header: 'Status', render: r => <StatusBadge status={r.status} /> },
      ];

      const jsaCols = [
        { header: 'ID', render: r => <span className="font-mono text-xs bg-slate-100 px-2 py-1 rounded-lg">{r.jsaNumber}</span> },
        { header: 'Title', render: r => <span className="font-semibold text-slate-800">{r.title}</span> },
        { header: 'Department', render: r => r.department || '-' },
        { header: 'Status', render: r => <StatusBadge status={r.status} /> },
      ];

      const permitCols = [
        { header: 'ID', render: r => <span className="font-mono text-xs bg-slate-100 px-2 py-1 rounded-lg">{r.permitNumber}</span> },
        { header: 'Title', render: r => <span className="font-semibold text-slate-800">{r.title}</span> },
        { header: 'Type', render: r => <Badge color="orange">{r.type?.replace('_', ' ')}</Badge> },
        { header: 'Priority', render: r => <Badge color={r.priority === 'emergency' ? 'red' : r.priority === 'urgent' ? 'orange' : 'gray'}>{r.priority}</Badge> },
        { header: 'Status', render: r => <StatusBadge status={r.status} /> },
      ];

      const contractorCols = [
        { header: 'Company', render: r => <span className="font-semibold text-slate-800">{r.companyName}</span> },
        { header: 'Type', render: r => <Badge color="cyan">{r.type}</Badge> },
        { header: 'Contact', render: r => r.contact?.primaryName || '-' },
        { header: 'Status', render: r => <StatusBadge status={r.status} /> },
      ];

      const chemicalCols = [
        { header: 'Product', render: r => <span className="font-semibold text-slate-800">{r.productName}</span> },
        { header: 'Manufacturer', accessor: 'manufacturer' },
        { header: 'CAS #', render: r => <span className="font-mono text-xs">{r.casNumber || '-'}</span> },
        { header: 'Status', render: r => <StatusBadge status={r.status} /> },
      ];

      const emergencyCols = [
        { header: 'Title', render: r => <span className="font-semibold text-slate-800">{r.title}</span> },
        { header: 'Type', render: r => <Badge color="red">{r.type?.replace('_', ' ')}</Badge> },
        { header: 'Location', accessor: 'location' },
        { header: 'Status', render: r => <StatusBadge status={r.status} /> },
      ];

      const renderPage = () => {
        switch (page) {
          case 'dashboard': return <DashboardPage />;
          case 'incidents': return <ListPage title="Incidents" subtitle="Track and investigate workplace incidents" endpoint="/incidents" columns={incidentCols} ModalComp={IncidentModal} createLabel="Report Incident" icon={Icons.Incident} />;
          case 'observations': return <ListPage title="Safety Observations" subtitle="Near misses, hazards, and safety observations" endpoint="/observations" columns={[
            { header: 'ID', render: r => <span className="font-mono text-xs bg-slate-100 px-2 py-1 rounded-lg">{r.observationNumber}</span> },
            { header: 'Description', render: r => <span className="font-semibold text-slate-800 truncate max-w-xs block">{r.description}</span> },
            { header: 'Type', render: r => <Badge color={r.type === 'unsafe_act' ? 'red' : r.type === 'unsafe_condition' ? 'yellow' : r.type === 'near_miss' ? 'orange' : 'green'}>{r.type?.replace(/_/g, ' ')}</Badge> },
            { header: 'Status', render: r => <StatusBadge status={r.status} /> },
          ]} ModalComp={ObservationModal} createLabel="Report Observation" icon={Icons.Observation} />;
          case 'actions': return <ListPage title="Action Items" subtitle="Corrective and preventive actions" endpoint="/action-items" columns={actionCols} ModalComp={ActionModal} createLabel="New Action" icon={Icons.Action} />;
          case 'inspections': return <ListPage title="Inspections" subtitle="Safety inspections and audits" endpoint="/inspections" columns={[
            { header: 'ID', render: r => <span className="font-mono text-xs bg-slate-100 px-2 py-1 rounded-lg">{r.inspectionNumber}</span> },
            { header: 'Title', render: r => <span className="font-semibold text-slate-800">{r.title}</span> },
            { header: 'Type', render: r => <Badge color="cyan">{r.type}</Badge> },
            { header: 'Status', render: r => <StatusBadge status={r.status} /> },
          ]} ModalComp={InspectionModal} createLabel="New Inspection" icon={Icons.Inspection} />;
          case 'training': return <ListPage title="Training" subtitle="Training courses and compliance" endpoint="/training" columns={[
            { header: 'Title', render: r => <span className="font-semibold text-slate-800">{r.title}</span> },
            { header: 'Type', render: r => <Badge color="purple">{r.type}</Badge> },
            { header: 'Duration', render: r => r.duration ? r.duration.hours + 'h ' + (r.duration.minutes || 0) + 'm' : '-' },
          ]} ModalComp={TrainingModal} createLabel="New Course" icon={Icons.Training} />;
          case 'documents': return <ListPage title="Documents" subtitle="Policies, procedures, and SDS" endpoint="/documents" columns={[
            { header: 'Title', render: r => <span className="font-semibold text-slate-800">{r.title}</span> },
            { header: 'Category', render: r => <Badge color="purple">{r.category}</Badge> },
            { header: 'Version', accessor: 'version' },
            { header: 'Status', render: r => <StatusBadge status={r.status} /> },
          ]} ModalComp={DocumentModal} createLabel="Upload Document" icon={Icons.Document} />;
          case 'risk': return <ListPage title="Risk Assessments" subtitle="Identify and control workplace hazards" endpoint="/risk-assessments" columns={riskCols} ModalComp={RiskModal} createLabel="New Assessment" icon={Icons.Risk} />;
          case 'jsa': return <ListPage title="Job Safety Analysis" subtitle="Step-by-step task hazard analysis" endpoint="/jsa" columns={jsaCols} ModalComp={JSAModal} createLabel="New JSA" icon={Icons.JSA} />;
          case 'permits': return <ListPage title="Permits to Work" subtitle="High-risk work authorization" endpoint="/permits" columns={permitCols} ModalComp={PermitModal} createLabel="New Permit" icon={Icons.Permit} />;
          case 'moc': return <ListPage title="Management of Change" subtitle="Track and approve operational changes" endpoint="/moc" columns={[
            { header: 'ID', render: r => <span className="font-mono text-xs bg-slate-100 px-2 py-1 rounded-lg">{r.mocNumber}</span> },
            { header: 'Title', render: r => <span className="font-semibold text-slate-800">{r.title}</span> },
            { header: 'Type', render: r => <Badge color="purple">{r.changeType?.replace(/_/g, ' ')}</Badge> },
            { header: 'Priority', render: r => <Badge color={r.priority === 'critical' ? 'red' : r.priority === 'high' ? 'orange' : r.priority === 'medium' ? 'yellow' : 'green'}>{r.priority}</Badge> },
            { header: 'Status', render: r => <StatusBadge status={r.status} /> },
          ]} ModalComp={MOCModal} createLabel="New MOC" icon={Icons.MOC} />;
          case 'contractors': return <ListPage title="Contractors" subtitle="Contractor safety management" endpoint="/contractors" columns={contractorCols} ModalComp={ContractorModal} createLabel="Add Contractor" icon={Icons.Contractor} />;
          case 'suppliers': return <ListPage title="Supplier Management" subtitle="Supplier qualification and performance" endpoint="/suppliers" columns={[
            { header: 'Name', render: r => <span className="font-semibold text-slate-800">{r.name}</span> },
            { header: 'Category', render: r => <Badge color="blue">{r.category}</Badge> },
            { header: 'Rating', render: r => <Badge color={r.rating >= 4 ? 'green' : r.rating >= 3 ? 'yellow' : 'red'}>{r.rating ? r.rating + '/5' : 'N/A'}</Badge> },
            { header: 'Status', render: r => <StatusBadge status={r.status} /> },
          ]} ModalComp={SupplierModal} createLabel="Add Supplier" icon={Icons.Supplier} />;
          case 'assets': return <ListPage title="Asset Management" subtitle="Equipment and asset tracking" endpoint="/assets" columns={[
            { header: 'Asset ID', render: r => <span className="font-mono text-xs bg-slate-100 px-2 py-1 rounded-lg">{r.assetNumber}</span> },
            { header: 'Name', render: r => <span className="font-semibold text-slate-800">{r.name}</span> },
            { header: 'Category', render: r => <Badge color="blue">{r.category}</Badge> },
            { header: 'Location', accessor: 'location' },
            { header: 'Status', render: r => <StatusBadge status={r.status} /> },
          ]} ModalComp={AssetModal} createLabel="Add Asset" icon={Icons.Asset} />;
          case 'chemicals': return <ListPage title="Chemical/SDS Management" subtitle="Safety Data Sheets and chemical inventory" endpoint="/chemicals" columns={chemicalCols} ModalComp={ChemicalModal} createLabel="Add Chemical" icon={Icons.Chemical} />;
          case 'health': return <ListPage title="Occupational Health" subtitle="Employee health monitoring and records" endpoint="/occupational-health" columns={[
            { header: 'Employee', render: r => r.employee ? r.employee.firstName + ' ' + r.employee.lastName : (r.employeeName || '-') },
            { header: 'Type', render: r => <Badge color="green">{r.recordType?.replace(/_/g, ' ')}</Badge> },
            { header: 'Date', render: r => r.date ? new Date(r.date).toLocaleDateString() : '-' },
            { header: 'Status', render: r => <StatusBadge status={r.status} /> },
          ]} ModalComp={HealthModal} createLabel="New Record" icon={Icons.Health} />;
          case 'emergency': return <ListPage title="Emergency Response Plans" subtitle="Emergency procedures and drill records" endpoint="/emergency-plans" columns={emergencyCols} ModalComp={EmergencyModal} createLabel="New Plan" icon={Icons.Emergency} />;
          case 'ergonomics': return <ListPage title="Ergonomic Assessments" subtitle="Workstation and task evaluations" endpoint="/ergonomic-assessments" columns={[
            { header: 'ID', render: r => <span className="font-mono text-xs bg-slate-100 px-2 py-1 rounded-lg">{r.assessmentNumber}</span> },
            { header: 'Employee', render: r => r.employeeName || '-' },
            { header: 'Type', render: r => <Badge color="purple">{r.type}</Badge> },
            { header: 'Status', render: r => <StatusBadge status={r.status} /> },
          ]} ModalComp={ErgonomicModal} createLabel="New Assessment" icon={Icons.Ergo} />;
          case 'environmental': return <ListPage title="Environmental Management" subtitle="Air, water, waste, and emissions tracking" endpoint="/environmental" columns={[
            { header: 'ID', render: r => <span className="font-mono text-xs bg-slate-100 px-2 py-1 rounded-lg">{r.recordNumber}</span> },
            { header: 'Type', render: r => <Badge color={r.type === 'air' ? 'blue' : r.type === 'water' ? 'cyan' : r.type === 'waste' ? 'yellow' : 'green'}>{r.type}</Badge> },
            { header: 'Source', render: r => <span className="font-semibold text-slate-800">{r.source}</span> },
            { header: 'Date', render: r => r.date ? new Date(r.date).toLocaleDateString() : '-' },
            { header: 'Status', render: r => <StatusBadge status={r.status} /> },
          ]} ModalComp={EnvironmentalModal} createLabel="New Record" icon={Icons.Environment} />;
          case 'quality': return <ListPage title="Quality/NCR Management" subtitle="Nonconformance reports and quality issues" endpoint="/quality" columns={[
            { header: 'NCR #', render: r => <span className="font-mono text-xs bg-slate-100 px-2 py-1 rounded-lg">{r.ncrNumber}</span> },
            { header: 'Title', render: r => <span className="font-semibold text-slate-800">{r.title}</span> },
            { header: 'Type', render: r => <Badge color="purple">{r.type?.replace(/_/g, ' ')}</Badge> },
            { header: 'Severity', render: r => <Badge color={r.severity === 'critical' ? 'red' : r.severity === 'major' ? 'orange' : 'yellow'}>{r.severity}</Badge> },
            { header: 'Status', render: r => <StatusBadge status={r.status} /> },
          ]} ModalComp={QualityModal} createLabel="New NCR" icon={Icons.Quality} />;
          case 'capa': return <ListPage title="CAPA Management" subtitle="Corrective and preventive action tracking" endpoint="/capa" columns={[
            { header: 'CAPA #', render: r => <span className="font-mono text-xs bg-slate-100 px-2 py-1 rounded-lg">{r.capaNumber}</span> },
            { header: 'Title', render: r => <span className="font-semibold text-slate-800">{r.title}</span> },
            { header: 'Type', render: r => <Badge color={r.type === 'corrective' ? 'red' : 'blue'}>{r.type}</Badge> },
            { header: 'Source', render: r => <Badge color="gray">{r.source?.replace(/_/g, ' ')}</Badge> },
            { header: 'Status', render: r => <StatusBadge status={r.status} /> },
          ]} ModalComp={CAPAModal} createLabel="New CAPA" icon={Icons.CAPA} />;
          case 'meetings': return <ListPage title="Safety Meetings" subtitle="Committee meetings and safety talks" endpoint="/meetings" columns={[
            { header: 'Title', render: r => <span className="font-semibold text-slate-800">{r.title}</span> },
            { header: 'Type', render: r => <Badge color="blue">{r.type?.replace(/_/g, ' ')}</Badge> },
            { header: 'Date', render: r => r.date ? new Date(r.date).toLocaleDateString() : '-' },
            { header: 'Attendees', render: r => r.attendees?.length || 0 },
            { header: 'Status', render: r => <StatusBadge status={r.status} /> },
          ]} ModalComp={MeetingModal} createLabel="Schedule Meeting" icon={Icons.Meeting} />;
          case 'osha': return <OSHAPage />;
          case 'reports': return <ReportsPage />;
          case 'inbox': return <InboxPage />;
          case 'icare': return <ICarePage />;
          case 'audits': return <ScheduledAuditsPage />;
          case 'hierarchy': return <HierarchyPage />;
          case 'archived': return <ArchivedPage />;
          case 'customreports': return <CustomReportsPage />;
          case 'formbuilder': return <FormBuilderPage />;
          case 'users': return <UsersPage />;
          case 'audit': return <AuditPage />;
          case 'settings': return <SettingsPage />;
          default: return <DashboardPage />;
        }
      };


      if (loading) return <div className="min-h-screen flex items-center justify-center gradient-bg"><Spinner size="lg" className="!border-white/30 !border-t-white" /></div>;
      
      const path = window.location.pathname;
      
      // Super Admin Portal
      if (path === '/superadmin' || path.startsWith('/superadmin')) {
        if (!user) return <LoginPage onLogin={handleLogin} isSuperAdmin={true} />;
        if (user.role === 'superadmin' || user.isSuperAdmin) {
          return <SuperAdminPage onLogout={handleLogout} />;
        }
        return <div className="min-h-screen flex items-center justify-center bg-slate-100"><Card className="max-w-md"><h2 className="text-xl font-bold text-red-600 mb-2">Access Denied</h2><p className="text-slate-600 mb-4">You don't have permission to access the admin portal.</p><Button onClick={handleLogout}>Sign Out</Button></Card></div>;
      }
      
      // Redirect unauthenticated users on root to landing page
      if (!user && path === '/') {
        window.location.href = '/';
        return null;
      }
      
      // Registration page
      if (path === '/register') {
        if (user) { window.location.href = '/app'; return null; }
        return <RegisterPage onRegister={(u) => { handleLogin(u); window.location.href = '/app'; }} />;
      }
      
      // Login page
      if (path === '/login' || (!user && path !== '/register')) {
        return <LoginPage onLogin={(u) => { handleLogin(u); window.location.href = '/app'; }} />;
      }
      
      // Redirect to app if authenticated on root
      if (user && path === '/') {
        window.location.href = '/app';
        return null;
      }

      return (
        <AuthContext.Provider value={{ user, setUser }}>
          <ToastContext.Provider value={{ addToast }}>
            <div className="min-h-screen flex bg-slate-100">
              <Sidebar page={page} setPage={setPage} user={user} onLogout={handleLogout} mobileOpen={mobileOpen} setMobileOpen={setMobileOpen} />
              <div className="flex-1 flex flex-col min-w-0">
                <Header user={user} setMobileOpen={setMobileOpen} />
                <main className="flex-1 p-4 lg:p-6 overflow-auto">{renderPage()}</main>
              </div>
            </div>
            <Toast toasts={toasts} removeToast={removeToast} />
          </ToastContext.Provider>
        </AuthContext.Provider>
      );
    };

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
